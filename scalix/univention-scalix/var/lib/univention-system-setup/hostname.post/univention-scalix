#!/bin/sh

export PATH=$PATH:/opt/scalix/bin/

eval $(univention-baseconfig shell)

oldhostname=$1
newhostname=$2

oldfqdn="$1.$domainname"
newfqdn="$2.$domainname"

/etc/init.d/univention-scalix stop

# get the instance directory
. /etc/opt/scalix/instance.cfg
INSTANCE=${OMDATADIR/\/var\/opt\/scalix\//}
export INSTANCE=${INSTANCE/\/s/}


if [ -x /opt/scalix/bin/sxmodfqdn ]; then
	echo "Change Scalix config: /opt/scalix/bin/sxmodfqdn -o oldfqdn -n newfqdn"
	/opt/scalix/bin/sxmodfqdn -o $oldfqdn -n $newfqdn
fi

/usr/share/univention-scalix/univention-scalix-conffile

if [ -e /opt/scalix/global/config ]; then
	echo "Change Scalix config: sed -i \"s|OMHOSTNAME=$oldfqdn|OMHOSTNAME=$newfqdn|\" /opt/scalix/global/config"
	sed -i "s|OMHOSTNAME=$oldfqdn|OMHOSTNAME=$newfqdn|" /opt/scalix/global/config
fi

source /opt/scalix/global/config

for dir in /var/opt/scalix/${INSTANCE}/* /opt/scalix /etc/opt/scalix /etc/opt/scalix-tomcat; do
	if [ -d ${dir} ]; then
		if [ ${dir} != $OMDATADIR ]; then
			SRCHDIRS="${SRCHDIRS} $dir"
		fi
	fi
done

for dir in $SRCHDIRS; do
	find $dir -type f ! -name "*.dat*" ! -name "*.key*" ! -name "*log*" | xargs grep -il $oldfqdn | while read line
		do
			echo "Change Scalix config: sed -i \"s|$oldfqdn|$newfqdn|g\" $line;"
			sed -i "s|$oldfqdn|$newfqdn|g" $line
		done
done

omshowu -m all| while read line; do
	ommodu "$line" --index `omshowu -n "$line"|grep -i sis| sed -e "s/^.*$oldfqdn/sxidx:\/\/$newfqdn/g"`;
done

if [ ! -e /var/cache/univention-system-setup/postrun/univention-scalix ]; then
	mkdir -p /var/cache/univention-system-setup/postrun
	echo "#!/bin/sh" >/var/cache/univention-system-setup/postrun/univention-scalix
	echo "/etc/init.d/univention-scalix start" >/var/cache/univention-system-setup/postrun/univention-scalix
	chmod +x /var/cache/univention-system-setup/postrun/univention-scalix
fi

exit 0

