#!/bin/sh

recover=`cat /proc/cmdline | grep " recover"`
params="--cmdline"

# disable console blanking
setterm -powersave off
setterm -powerdown 0
setterm -blank 0

#check architecture
architecture=`uname -m`

if [ -n "$architecture" ] && [ "$architecture" = "ppc64" ]; then
	params="$params --simple"
fi

if [ -e /.ucs-edition ]; then
	params="$params --edition $(cat /.ucs-edition)"
fi

if [ -e /.ucs-version ]; then
	params="$params --version $(cat /.ucs-version)"
fi
if [ -n "$recover" ]; then


	/bin/python -OO /lib/univention-installer/main.py $params
	echo "Starting recover shell"
	echo ""
	/bin/sh
else
	while [ ! -e /tmp/installation_profile ]; do

		/bin/python -OO /lib/univention-installer/main.py $params

		if [ ! -e /tmp/installation_profile ]; then
			echo "Press Return to restart the installer program."
			read $foo
			continue
		fi

		lib/univention-installer-scripts.d/00_scripts.sh
		for i in lib/univention-installer-scripts.d/*; do
			if [ "$i" = lib/univention-installer-scripts.d/00_scripts.sh ]; then
				continue
			fi
			if [ "$i" = lib/univention-installer-scripts.d/99_reboot.sh ]; then
				continue
			fi
			if [ -e /tmp/logging ]; then
				mkdir -p /instmnt/var/log/univention/
				touch installation.log
				chown root:adm installation.log
				chmod 640 installation.log
			fi
			if [ -e /tmp/logging ]; then
				/bin/sh $i </dev/tty1 2>&1 | tee -a /instmnt/var/log/univention/installation.log
			else
				/bin/sh $i </dev/tty1
			fi
		done
		lib/univention-installer-scripts.d/99_reboot.sh

	done
fi
