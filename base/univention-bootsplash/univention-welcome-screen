#!/bin/bash
#
# Univention Welcome Screen
#  start welcome screen
#
# Copyright 2015-2017 Univention GmbH
#
# http://www.univention.de/
#
# All rights reserved.
#
# The source code of this program is made available
# under the terms of the GNU Affero General Public License version 3
# (GNU AGPL V3) as published by the Free Software Foundation.
#
# Binary versions of this program provided by Univention to you as
# well as other copyrighted, protected or trademarked materials like
# Logos, graphics, fonts, specific documentations and configurations,
# cryptographic keys etc. are subject to a license agreement between
# you and Univention and not subject to the GNU AGPL V3.
#
# In the case you use this program under the terms of the GNU AGPL V3,
# the program is provided in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public
# License with the Debian GNU/Linux or Univention distribution in file
# /usr/share/common-licenses/AGPL-3; if not, see
# <http://www.gnu.org/licenses/>.

eval "$(ucr shell)"

. /usr/share/univention-lib/base.sh
. /usr/share/univention-lib/ucr.sh

image="/tmp/.univention-welcome-screen.png"

echo "starting $0 ($(date)) with $@"

# which mode
mode="$1"
grab=true
display=true
ply=false
if [ -n "$mode" ]; then
	if [ "$mode" = "--only-switch-to-welcome" ]; then
		display=false
		grab=true
	fi
	if [ "$mode" = "--only-show-welcome" ]; then
		grab=false
		display=true
	fi
	if [ "$mode" = "--start-plymouth" ]; then
		grab=true
		display=true
		ply=true
	fi
fi

# some tests
quit=false
keyboards="$(ls /dev/input/by-path/*-kbd*)"
test -z "$keyboards" && quit=true && msg="no keyboard found, exiting"
test ! -e /dev/fb0 && quit=true && msg="no framebuffer found, exiting"
test -e /etc/X11/default-display-manager && quit=true && msg="a display-manager is installed/configured, exiting"
if ! grep -q -w splash /proc/cmdline; then
	quit=true
	msg="bootsplash deactivated, exiting"
fi
if is_ucr_false welcome-screen/autostart; then 
	quit=true
	msg="welcome screen disabled, exiting"
fi
if [ "ucs" != "$bootsplash_theme" -a "ucs-appliance-dark" != "$bootsplash_theme" -a "ucs-appliance-light" != "$bootsplash_theme" ]; then
	quit=true
	msg="theme does not support welcome screen, exiting"
fi
if is_ucr_true system/setup/boot/start; then
	quit=true
	msg="system/setup/boot/start is activated, exiting"
fi

if $quit; then
	echo $msg
	exit 0
fi

# go to welcome screen
if $grab; then
	if $ply; then
		if ! plymouth --ping; then
			plymouthd
			plymouth --show-splash
		fi
	fi
	if plymouth --ping; then
		echo "going to plymouth welcome screen mode..."
		# check appliance logo
		appliance=false
		if [ -n "$umc_web_appliance_logo" ]; then
			if [ -e "/var/www/$umc_web_appliance_logo" -a ! -e /usr/share/plymouth/themes/ucs/appliance.png ]; then
				cp "/var/www/$umc_web_appliance_logo" /usr/share/plymouth/themes/ucs/appliance.logo
				if [ -x "$(which convert)" ]; then
					convert -background None /usr/share/plymouth/themes/ucs/appliance.logo /usr/share/plymouth/themes/ucs/appliance.png
				fi
			fi
			if [ -e /usr/share/plymouth/themes/ucs/appliance.png ]; then
				appliance=true
			fi
		fi
		lang="${locale_default%%:*}"
		if [ -n "$lang" ]; then
			export LC_ALL="$lang"
		fi
		export TEXTDOMAINDIR=/usr/share/plymouth/themes/ucs/
		if [ -n "$umc_web_appliance_name" ]; then
			header="$(gettext -d univention-welcome-screen "Welcome to ")$umc_web_appliance_name"
		else
			header="$(gettext -d univention-welcome-screen "Welcome to ")Univention Corporate Server"
		fi
		console="$(gettext -d univention-welcome-screen "[ Press any key to open text console ]")"
		message1="$(gettext -d univention-welcome-screen "Open a browser window")"
		message2="$(gettext -d univention-welcome-screen "Navigate to one of the following addresses:")"
		message3="$(gettext -d univention-welcome-screen "Open the web management interface")"
		hostname="$hostname.$domainname"
		address="https://$(get_default_ip_address)"
		addresses="$address https://$hostname"
		# show welcome screen
		plymouth --show-splash
		plymouth update --status=univention-welcome
		plymouth display-message --text="$console"
		if $appliance; then
			plymouth update --status="univention-welcome:appliance"
		fi
		plymouth update --status="univention-welcome:header:$header"
		plymouth update --status="univention-welcome:message1:$message1"
		plymouth update --status="univention-welcome:message2:$message2"
		plymouth update --status="univention-welcome:message3:$message3"
		plymouth update --status="univention-welcome:hostname:$hostname"
		plymouth update --status="univention-welcome:address:$address"
		plymouth update --status="univention-welcome:addresses:$addresses"
		plymouth update --status="univention-welcome:console:$console"
		plymouth update --status="univention-welcome:console:$console" # this is not a typo, second call flushes screen
		plymouth update --status=""
		echo "grab image and quit plymouth"
		fbgrab "$image"
		plymouth --hide-splash
		plymouth quit
	fi
fi


# show welcome screen
if $display; then
	if [ -e "$image" ]; then
		#chvt 7
		echo "display welcome screen and wait..."
		fbi -T 7 --noverbose --noedit "$image" 1>/dev/null 2>&1
		hexdump -n 96 $keyboards >/dev/null
		echo "key pressed, good bye"
		#chvt 1
	fi
fi

exit 0
