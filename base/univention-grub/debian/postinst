#!/bin/sh

eval $(univention-baseconfig shell)

if [ "$1" = configure -a -z "$2" ] && [ -z "$grub_append" ]; then

        vars="grub/timeout=5 "

        if [ -n "$lilo_vga" ]; then
                vars="$vars grub/vga=$lilo_vga "
        fi

		if [ -n "$lilo_boot" ]; then
			vars="$vars grub/boot=$lilo_boot"
		fi

        if [ -n "$lilo_append" ]; then
                if [ -n "$grub_append" ]; then
                        grub_append="$grub_append $lilo_append"
                else
                        grub_append="$lilo_append"
                fi
        fi

        if [ -n "$lilo_root" ]; then
				vars="$vars grub/root=$lilo_root"
                if [ -n "$grub_append" ]; then
                        grub_append="$grub_append root=$lilo_root"
                else
                        grub_append="root=$lilo_root"
                fi
		else
        	rootdevice=$(grep -w / /etc/fstab | awk '{print $1}')
			vars="$vars grub/root=$rootdevice"
        fi

        if [ -n "$lilo_append_acpi" ] && [ "$lilo_append_acpi" = "off" ]; then
                if [ -n "$grub_append" ]; then
                        grub_append="$grub_append acpi=off "
                else
                        grub_append="acpi=off "
                fi
        fi

        if [ -n "$lilo_append_pci_acpi" ] && [ "$lilo_append_pci_acpi" = "off" ]; then
                if [ -n "$grub_append" ]; then
                        grub_append="$grub_append pci=noacpi "
                else
                        grub_append="pci=noacpi "
                fi
        fi

        root2fstype=$(grep -w / /etc/fstab | awk '{print $3}')
        if [ -n "$root2fstype" ]; then
                if [ -n "$grub_append" ]; then
                        grub_append="$grub_append root2fstype=$root2fstype "
                else
                        grub_append="root2fstype=$root2fstype "
                fi
        fi

        if [ -n "$grub_append" ]; then
                univention-baseconfig set grub/append="$grub_append"
        fi

        univention-baseconfig set $vars grub/memtest86=true

        univention-baseconfig unset lilo/append/acpi \
                                lilo/append/pci_acpi \
                                lilo/append \
                                lilo/boot \
                                lilo/compact \
                                lilo/default \
                                lilo/root \
                                lilo/vga

elif [ -z "$2" ]; then
        # root fs type for quota support on xfs
        root2fstype=$(grep -w / /etc/fstab | awk '{print $3}')
        if [ -n "$root2fstype" ]; then
                append="$append root2fstype=$root2fstype "
        fi

        rootdevice=$(grep -w / /etc/fstab | awk '{print $1}')
        if [ -n "$root2fstype" ]; then
                append="$append root=$rootdevice "
        fi

        univention-baseconfig set grub/timeout?5 \
								grub/append="$append" \
								grub/root="$rootdevice" \
								grub/vga=785 \
								grub/memtest86=true

fi

# determine grubdevice
if [ -z "$grub_groot" ] ; then
	grubdev=$(mount | grep " on /boot " | cut -d' ' -f1)
	if [ -z "$grubdev" ] ; then
		grubdev=$(mount | grep " on / " | cut -d' ' -f1)
	fi
	. /usr/sbin/update-grub
	groot=$(convert $grubdev)
	univention-baseconfig set grub/groot="$groot"
fi

eval $(univention-baseconfig shell)

#DEBHELPER#


if [ "$1" = configure -a -z "$2" ]; then
	# source the update-grub file, so we could use the grub helper functions
	if [ -n "$grub_boot" ]; then

		mkinitramfs -o /boot/initrd-`uname -r` `uname -r`

		grub-install --no-floppy $grub_boot
	fi
	update-grub -y
fi

exit 0

