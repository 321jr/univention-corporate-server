#!/bin/sh
#
# Univention Setup
#  regenerate SSL certificates
#
# Copyright (C) 2009 Univention GmbH
#
# http://www.univention.de/
#
# All rights reserved.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License version 2 as
# published by the Free Software Foundation.
#
# Binary versions of this file provided by Univention to you as
# well as other copyrighted, protected or trademarked materials like
# Logos, graphics, fonts, specific documentations and configurations,
# cryptographic keys etc. are subject to a license agreement between
# you and Univention.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA

exec >/var/log/univention/setup.log 2>&1

. /usr/lib/univention-system-setup/scripts/setup_utils.sh

eval $(univention-config-registry shell)

new_ssl_locality=$(get_profile_var "ssl/locality")
new_ssl_organization=$(get_profile_var "ssl/organization")
new_ssl_country=$(get_profile_var "ssl/country")
new_ssl_state=$(get_profile_var "ssl/state")
new_ssl_organizationalunit=$(get_profile_var "ssl/organizationalunit")
new_ssl_email=$(get_profile_var "ssl/email")

recreate="no"

for var in "locality" "organization" "country" "state" "organizationalunit" "email"; do
	old="ssl_$var"
	new="new_ssl_$var"

	if [ "${!old}" != "${!new}" ]; then
		recreate="yes"
		break
	fi
done

if [ $recreate = "yes" ]; then
	# backup old SSL certificates
	mv /etc/univention/ssl /etc/univention/ssl.orig

	# try to set the clock before generating the root CA, otherwise it
	# is possible that the certificate is not valid at the end of the
	# installation Bug #13549
	rdate time.fu-berlin.de || rdate 130.133.1.10 || true

	# set UCR variables
	for var in "locality" "organization" "country" "state" "organizationalunit" "email"; do
		old="ssl_$var"
		new="new_ssl_$var"
		if [ -n "${!new}" ]; then
			univention-config-registry set "${old/_//}=${!new}"
		fi
	done

	# create new CA und certificates
	. /usr/share/univention-ssl/make-certificates.sh
	init
	(
		cd /etc/univention/ssl.orig
		for fqdn in *.$domainname; do
			host=$(basename $fqdn .$domainname)
			univention-certificate new -name $fqdn
			ln -sf /etc/univention/ssl/$fqdn /etc/univention/ssl/$host
		done
	)

	# copy certificates for cyrus
    for file in cert.pem private.key; do
        cp /etc/univention/ssl/$hostname.$domainname/$file /var/lib/cyrus/$file
        chown cyrus: /var/lib/cyrus/$file
        chmod 600 /var/lib/cyrus/$file
    done

	# restart services
	for service in slapd apache2 cyrus postfix; do
		invoke-rc.d --quiet $service restart
	done
fi

exit 0
