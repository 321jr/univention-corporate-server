#!/usr/bin/python2.6
"""Unit test for univention.management.console.modules.setup.netconf.modules.RewritePackageDatabase"""
# pylint: disable-msg=C0103,E0611,R0904
import unittest
import os
import univention.management.console.modules
univention.management.console.modules.__path__.append(os.path.join(os.path.dirname(__file__), os.path.pardir, 'umc/python'))
from univention.management.console.modules.setup.netconf import ChangeSet, SkipPhase
from univention.management.console.modules.setup.netconf.modules import RewritePackageDatabase


class DummyOption(object):
	def __init__(self):
		self.no_act = True


class TestPkgDbUnconfigured(unittest.TestCase):
	def setUp(self):
		ucr = {}
		profile = {}
		options = DummyOption()
		self.cs = ChangeSet(ucr, profile, options)
		self.phase = RewritePackageDatabase.PhaseRewritePackageDatabase(self.cs)

	def test_pkgdb(self):
		self.assertRaises(
			SkipPhase,
			self.phase.check
		)


class TestPkgDbChanged(unittest.TestCase):
	"""
	Old address changed to new address.
	"""
	def setUp(self):
		ucr = {
			"interfaces/eth0/type": "static",
			"interfaces/eth0/start": "true",
			"interfaces/eth0/address": "1.2.3.4",
			"interfaces/eth0/network": "1.2.0.0",
			"interfaces/eth0/netmask": "255.255.0.0",
			"interfaces/eth0/broadcast": "1.2.255.255",
			"interfaces/eth0/ipv6/default/address": "1111:2222::3333",
			"interfaces/eth0/ipv6/default/prefix": "64",
			"pgsql/pkgdb/network": "1.2.0.0",
			"pgsql/pkgdb/netmask": "255.255.0.0",
		}
		profile = {
			"interfaces/eth0/type": "static",
			"interfaces/eth0/start": "true",
			"interfaces/eth0/address": "2.3.4.5",
			"interfaces/eth0/network": "2.3.0.0",
			"interfaces/eth0/netmask": "255.255.255.0",
			"interfaces/eth0/broadcast": "2.3.4.255",
			"interfaces/eth0/ipv6/default/address": "2222:3333:4444::5555",
			"interfaces/eth0/ipv6/default/prefix": "80",
		}
		options = DummyOption()
		self.cs = ChangeSet(ucr, profile, options)
		self.phase = RewritePackageDatabase.PhaseRewritePackageDatabase(self.cs)

	def test_pkgdb(self):
		self.phase.check()
		self.phase.pre()
		self.assertEqual("2.3.4.0", self.cs.ucr_changes["pgsql/pkgdb/network"])
		self.assertEqual("24", self.cs.ucr_changes["pgsql/pkgdb/netmask"])


if __name__ == '__main__':
	unittest.main()
