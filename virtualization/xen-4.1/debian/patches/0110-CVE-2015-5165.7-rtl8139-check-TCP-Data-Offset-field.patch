From: Stefan Hajnoczi <stefanha@redhat.com>
Date: Wed, 15 Jul 2015 18:17:04 +0100
Subject: CVE-2015-5165.7 rtl8139: check TCP Data Offset field

The TCP Data Offset field contains the length of the header.  Make sure
it is valid and does not exceed the IP data length.

Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
Source: http://xenbits.xen.org/xsa/xsa140-qemuu-unstable-7.patch
---
 tools/ioemu-qemu-xen/hw/rtl8139.c | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/tools/ioemu-qemu-xen/hw/rtl8139.c b/tools/ioemu-qemu-xen/hw/rtl8139.c
index c610e3d..795493b 100644
--- a/tools/ioemu-qemu-xen/hw/rtl8139.c
+++ b/tools/ioemu-qemu-xen/hw/rtl8139.c
@@ -2190,6 +2190,11 @@ static int rtl8139_cplus_transmit_one(RTL8139State *s)
 
                 int tcp_hlen = TCP_HEADER_DATA_OFFSET(p_tcp_hdr);
 
+                /* Invalid TCP data offset? */
+                if (tcp_hlen < sizeof(tcp_header) || tcp_hlen > ip_data_len) {
+                    goto skip_offload;
+                }
+
                 /* ETH_MTU = ip header len + tcp header len + payload */
                 int tcp_data_len = ip_data_len - tcp_hlen;
                 int tcp_chunk_size = ETH_MTU - hlen - tcp_hlen;
