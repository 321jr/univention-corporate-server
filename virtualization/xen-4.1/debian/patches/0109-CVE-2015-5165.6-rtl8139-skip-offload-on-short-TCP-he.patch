From: Stefan Hajnoczi <stefanha@redhat.com>
Date: Thu, 17 Sep 2015 08:10:18 +0200
Subject: CVE-2015-5165.6 rtl8139: skip offload on short TCP header

TCP Large Segment Offload accesses the TCP header in the packet.  If the
packet is too short we must not attempt to access header fields:

  tcp_header *p_tcp_hdr = (tcp_header*)(eth_payload_data + hlen);
  int tcp_hlen = TCP_HEADER_DATA_OFFSET(p_tcp_hdr);

Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
Source: http://xenbits.xen.org/xsa/xsa140-qemuu-unstable-6.patch
---
 tools/ioemu-qemu-xen/hw/rtl8139.c | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/tools/ioemu-qemu-xen/hw/rtl8139.c b/tools/ioemu-qemu-xen/hw/rtl8139.c
index eb985c0..c610e3d 100644
--- a/tools/ioemu-qemu-xen/hw/rtl8139.c
+++ b/tools/ioemu-qemu-xen/hw/rtl8139.c
@@ -2160,6 +2160,11 @@ static int rtl8139_cplus_transmit_one(RTL8139State *s)
 
             if ((txdw0 & CP_TX_LGSEN) && ip_protocol == IP_PROTO_TCP)
             {
+                /* Large enough for the TCP header? */
+                if (ip_data_len < sizeof(tcp_header)) {
+                    goto skip_offload;
+                }
+
 #if defined (DEBUG_RTL8139)
                 int large_send_mss = (txdw0 >> 16) & CP_TC_LGSEN_MSS_MASK;
 #endif
