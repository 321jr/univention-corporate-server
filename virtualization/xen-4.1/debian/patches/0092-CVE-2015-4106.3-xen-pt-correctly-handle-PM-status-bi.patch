From: Jan Beulich <jbeulich@suse.com>
Date: Wed, 16 Sep 2015 15:43:43 +0200
Subject: CVE-2015-4106.3 xen/pt: correctly handle PM status bit

xen_pt_pmcsr_reg_write() needs an adjustment to deal with the RW1C
nature of the not passed through bit 15 (PCI_PM_CTRL_PME_STATUS).

This is a preparatory patch for XSA-131.

Signed-off-by: Jan Beulich <jbeulich@suse.com>
Reviewed-by: Stefano Stabellini <stefano.stabellini@eu.citrix.com>
Source: http://xenbits.xen.org/xsa/xsa131-qemut-3.patch
---
 tools/ioemu-qemu-xen/hw/pass-through.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/tools/ioemu-qemu-xen/hw/pass-through.c b/tools/ioemu-qemu-xen/hw/pass-through.c
index 54da1e5..6f19ad0 100644
--- a/tools/ioemu-qemu-xen/hw/pass-through.c
+++ b/tools/ioemu-qemu-xen/hw/pass-through.c
@@ -3744,7 +3744,8 @@ static int pt_pmcsr_reg_write(struct pt_dev *ptdev,
 
     /* create value for writing to I/O device register */
     throughable_mask = ~reg->emu_mask & valid_mask;
-    *value = PT_MERGE_VALUE(*value, dev_value, throughable_mask);
+    *value = PT_MERGE_VALUE(*value, dev_value & ~PCI_PM_CTRL_PME_STATUS,
+                            throughable_mask);
 
     if (!ptdev->power_mgmt)
         return 0;
