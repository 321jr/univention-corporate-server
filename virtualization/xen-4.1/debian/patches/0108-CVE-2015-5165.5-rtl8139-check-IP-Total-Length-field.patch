From: Stefan Hajnoczi <stefanha@redhat.com>
Date: Wed, 15 Jul 2015 18:17:02 +0100
Subject: CVE-2015-5165.5 rtl8139: check IP Total Length field

The IP Total Length field includes the IP header and data.  Make sure it
is valid and does not exceed the Ethernet payload size.

Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
Source: http://xenbits.xen.org/xsa/xsa140-qemuu-unstable-5.patch
---
 tools/ioemu-qemu-xen/hw/rtl8139.c | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/tools/ioemu-qemu-xen/hw/rtl8139.c b/tools/ioemu-qemu-xen/hw/rtl8139.c
index ba654f5..eb985c0 100644
--- a/tools/ioemu-qemu-xen/hw/rtl8139.c
+++ b/tools/ioemu-qemu-xen/hw/rtl8139.c
@@ -2142,7 +2142,12 @@ static int rtl8139_cplus_transmit_one(RTL8139State *s)
             }
 
             ip_protocol = ip->ip_p;
-            ip_data_len = be16_to_cpu(ip->ip_len) - hlen;
+
+            ip_data_len = be16_to_cpu(ip->ip_len);
+            if (ip_data_len < hlen || ip_data_len > eth_payload_len) {
+                goto skip_offload;
+            }
+            ip_data_len -= hlen;
 
             if (txdw0 & CP_TX_IPCS)
             {
