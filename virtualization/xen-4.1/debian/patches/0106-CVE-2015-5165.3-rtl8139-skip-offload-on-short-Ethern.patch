From: Stefan Hajnoczi <stefanha@redhat.com>
Date: Thu, 17 Sep 2015 07:40:13 +0200
Subject: CVE-2015-5165.3 rtl8139: skip offload on short Ethernet/IP header

Transmit offload features access Ethernet and IP headers the packet.  If
the packet is too short we must not attempt to access header fields:

  int proto = be16_to_cpu(*(uint16_t *)(saved_buffer + 12));
  ...
  eth_payload_data = saved_buffer + ETH_HLEN;
  ...
  ip = (ip_header*)eth_payload_data;
  if (IP_HEADER_VERSION(ip) != IP_HEADER_VERSION_4) {

Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
Source: http://xenbits.xen.org/xsa/xsa140-qemuu-unstable-3.patch
---
 tools/ioemu-qemu-xen/hw/rtl8139.c | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/tools/ioemu-qemu-xen/hw/rtl8139.c b/tools/ioemu-qemu-xen/hw/rtl8139.c
index 77f45ed..6400579 100644
--- a/tools/ioemu-qemu-xen/hw/rtl8139.c
+++ b/tools/ioemu-qemu-xen/hw/rtl8139.c
@@ -2103,6 +2103,11 @@ static int rtl8139_cplus_transmit_one(RTL8139State *s)
             #define ETH_HLEN    14
             #define ETH_MTU     1500
 
+            /* Large enough for Ethernet and IP headers? */
+            if (saved_size < ETH_HLEN + sizeof(ip_header)) {
+                goto skip_offload;
+            }
+
             /* ip packet header */
             ip_header *ip = 0;
             int hlen = 0;
