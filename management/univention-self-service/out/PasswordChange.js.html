<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: PasswordChange.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: PasswordChange.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
 * Copyright 2015-2016 Univention GmbH
 *
 * http://www.univention.de/
 *
 * All rights reserved.
 *
 * The source code of this program is made available
 * under the terms of the GNU Affero General Public License version 3
 * (GNU AGPL V3) as published by the Free Software Foundation.
 *
 * Binary versions of this program provided by Univention to you as
 * well as other copyrighted, protected or trademarked materials like
 * Logos, graphics, fonts, specific documentations and configurations,
 * cryptographic keys etc. are subject to a license agreement between
 * you and Univention and not subject to the GNU AGPL V3.
 *
 * In the case you use this program under the terms of the GNU AGPL V3,
 * the program is provided in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public
 * License with the Debian GNU/Linux or Univention distribution in file
 * /usr/share/common-licenses/AGPL-3; if not, see
 * &lt;http://www.gnu.org/licenses/>.
 */
/*global define require console window */

define([
	"dojo/_base/lang",
	"dojo/on",
	"dojo/keys",
	"dojo/dom",
	"dojo/json",
	"dojo/request/xhr",
	"dijit/form/Button",
	"put-selector/put",
	"./TextBox",
	"./lib",
	"./i18n!."
], function(lang, on, keys, dom, json, xhr, Button, put, TextBox, lib, _) {

	return {
		title: 'Password change',
		desc: 'Change your (expired) password.',
		hash: 'passwordchange',
		contentContainer: null,
		steps: null,

		/**
		 * Returns the title of the subpage.
		 * */
		getTitle: function() {
			return _(this.title);
		},

		/**
		 * Returns the description of the subpage.
		 * */
		getDesc: function() {
			return _(this.desc);
		},

		/**
		 * Return the content node of the subpage.
		 * If the content does not exists, it will be generated.
		 * */
		getContent: function() {
			if (!this.contentContainer) {
				this.contentContainer = put('div.contentWrapper');
				put(this.contentContainer, 'div.contentDesc', this.getDesc());
				put(this.contentContainer, this._getSteps());
			}
			return this.contentContainer;
		},

		/**
		 * Return the steps for the content node.
		 * If the steps do not exists, they will be generated.
		 * Note: Please call getContent for generating the steps.
		 * */
		_getSteps: function() {
			if (!this.steps) {
				this.steps = put('ol#PasswordChangeSteps.PasswordOl');
				this._createUsername();
				this._createOldPassword();
				this._createNewPassword();
				this._createSubmit();
			}
			return this.steps;
		},

		/**
		 * Creates input field for username.
		 * */
		_createUsername: function() {
			var step = put('li.step');
			var label = put('div.stepLabel', _('Username'));
			put(step, label);
			this._username = new TextBox({
				'class': 'soloLabelPane',
				isValid: function() {
					return !!this.get('value');
				},
				required: true
			});
			this._username.startup();
			put(step, this._username.label.domNode);
			put(this.steps, step);
		},

		/**
		 * Creates input field for old password.
		 * */
		_createOldPassword: function() {
			var step = put('li.step');
			var label = put('div.stepLabel', _('Old Password'));
			put(step, label);
			this._oldPassword = new TextBox({
				type: 'password',
				'class': 'soloLabelPane',
				isValid: function() {
					return !!this.get('value');
				},
				required: true
			});
			this._oldPassword.startup();
			put(step, this._oldPassword.label.domNode);
			put(this.steps, step);
		},

		/**
		 * Creates input fields for new password.
		 * */
		_createNewPassword: function() {
			var step = put('li.step');
			var label = put('div.stepLabel', _('New Password'));
			put(step, label);
			this._newPassword = new TextBox({
				type: 'password',
				'class': 'soloLabelPane left',
				isValid: function() {
					return !!this.get('value');
				},
				required: true
			});
			this._newPassword.startup();
			put(step, this._newPassword.label.domNode);
			put(this.steps, step);

			step = put('li.step');
			label = put('div.stepLabel', _('New Password (retype)'));
			put(step, label);
			this._verifyPassword = new TextBox({
				type: 'password',
				'class': 'soloLabelPane',
				isValid: lang.hitch(this, function() {
					return this._newPassword.get('value') ===
						this._verifyPassword.get('value');
				}),
				invalidMessage: _('The passwords do not match, please retype again.'),
				required: true
			});
			this._verifyPassword.startup();
			put(step, this._verifyPassword.label.domNode);
			put(this.steps, step);
		},

		/**
		 * Creates submit button.
		 * */
		_createSubmit: function() {
			var step = put('div');
			this._submitButton = new Button({
				label: _('Change password'),
				onClick: lang.hitch(this, '_setPassword')
			});
			put(step, '>', this._submitButton.domNode);

			// let the user submit the form by pressing ENTER
			on(document, "keyup", lang.hitch(this, function(evt) {
				if (evt.keyCode === keys.ENTER &amp;&amp; !this._submitButton.get('disabled')) {
					this._setPassword();
				}
			}));
			put(this.steps, step);
		},

		/**
		 * Changes the current password if all input fields are valid.
		 * */
		_setPassword: function() {
			this._showValidStatusOfInputFields();
			this._submitButton.set('disabled', true);
			var allInputFieldsAreValid = this._username.isValid() &amp;&amp;
				this._oldPassword.isValid() &amp;&amp;
				this._newPassword.isValid() &amp;&amp;
				this._verifyPassword.isValid();

			if (allInputFieldsAreValid) {
				data = json.stringify({
					'username': this._username.get('value'),
					'password': this._oldPassword.get('value'),
					'new_password': this._newPassword.get('value')
				});

				xhr.post('passwordchange/', {
					handleAs: 'json',
					headers: {
						'Content-Type': 'application/json',
						'Accept-Language': lib.getQuery('lang') || 'en-US'
					},
					data: data
				}).then(lang.hitch(this, function(data) {
					lib.showLastMessage({
						content: data.message,
						'class': '.success'
					});
					this._clearAllInputFields();
				}), lang.hitch(this, function(err) {
					var message = err.name + ": " + err.message;
					if (err.response &amp;&amp; err.response.data &amp;&amp; err.response.data.message) {
						message = err.response.data.message;
					}
					lib.showMessage({
						content: message,
						'class': '.error'
					});
				})).always(lang.hitch(this, function(){
					this._submitButton.set('disabled', false);
				}));
			} else {
				this._submitButton.set('disabled', false);
			}
		},

		/**
		 * Checks and displays if all input field are valid.
		 * */
		_showValidStatusOfInputFields: function() {
			this._username.setValid(this._username.isValid());
			this._oldPassword.setValid(this._oldPassword.isValid());
			this._newPassword.setValid(this._newPassword.isValid());
			//this._verifyPassword.setValid(this._verifyPassword.isValid());
		},

		/**
		 * Clears all input field values of the subpage.
		 * */
		_clearAllInputFields: function() {
			this._username.reset();
			this._oldPassword.reset();
			this._newPassword.reset();
			this._verifyPassword.reset();
		},
	};
});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#_clearAllInputFields">_clearAllInputFields</a></li><li><a href="global.html#_createNewPassword">_createNewPassword</a></li><li><a href="global.html#_createOldPassword">_createOldPassword</a></li><li><a href="global.html#_createPassword">_createPassword</a></li><li><a href="global.html#_createRenewOptions">_createRenewOptions</a></li><li><a href="global.html#_createSubmit">_createSubmit</a></li><li><a href="global.html#_createSubmitNewPassword">_createSubmitNewPassword</a></li><li><a href="global.html#_createUsername">_createUsername</a></li><li><a href="global.html#_deleteRenewOptions">_deleteRenewOptions</a></li><li><a href="global.html#_getContactInformation">_getContactInformation</a></li><li><a href="global.html#_getCredentials">_getCredentials</a></li><li><a href="global.html#_getNewContactInformation">_getNewContactInformation</a></li><li><a href="global.html#_getRenewOption">_getRenewOption</a></li><li><a href="global.html#_getRequestSteps">_getRequestSteps</a></li><li><a href="global.html#_getResetMethods">_getResetMethods</a></li><li><a href="global.html#_getSetNewSteps">_getSetNewSteps</a></li><li><a href="global.html#_getSteps">_getSteps</a></li><li><a href="global.html#_renderRenewOptions">_renderRenewOptions</a></li><li><a href="global.html#_requestToken">_requestToken</a></li><li><a href="global.html#_setContactInformation">_setContactInformation</a></li><li><a href="global.html#_setPassword">_setPassword</a></li><li><a href="global.html#_showNewPasswordHowTo">_showNewPasswordHowTo</a></li><li><a href="global.html#_showValidStatusOfInputFields">_showValidStatusOfInputFields</a></li><li><a href="global.html#_validateMail">_validateMail</a></li><li><a href="global.html#getContent">getContent</a></li><li><a href="global.html#getDesc">getDesc</a></li><li><a href="global.html#getRequestNewPassDesc">getRequestNewPassDesc</a></li><li><a href="global.html#getSetNewPassDesc">getSetNewPassDesc</a></li><li><a href="global.html#getTitle">getTitle</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Sun Mar 27 2016 18:07:42 GMT+0200 (CEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
