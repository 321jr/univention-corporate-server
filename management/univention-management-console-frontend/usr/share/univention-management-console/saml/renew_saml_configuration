#!/bin/bash
# -*- coding: utf-8 -*-
#
# Univention Management Console
# script to rewrite SAML configuration for UMC
#
# Copyright 2015 Univention GmbH
#
# http://www.univention.de/
#
# All rights reserved.
#
# The source code of this program is made available
# under the terms of the GNU Affero General Public License version 3
# (GNU AGPL V3) as published by the Free Software Foundation.
#
# Binary versions of this program provided by Univention to you as
# well as other copyrighted, protected or trademarked materials like
# Logos, graphics, fonts, specific documentations and configurations,
# cryptographic keys etc. are subject to a license agreement between
# you and Univention and not subject to the GNU AGPL V3.
#
# In the case you use this program under the terms of the GNU AGPL V3,
# the program is provided in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public
# License with the Debian GNU/Linux or Univention distribution in file
# /usr/share/common-licenses/AGPL-3; if not, see
# <http://www.gnu.org/licenses/>.

eval "$(ucr shell)"

# generate SSL cert + private key for the SAML service provider
if [ ! -e /usr/share/univention-management-console/saml/pki/sp.pem ]; then
	openssl req -newkey rsa:2048 -new -x509 -days "${ssl_default_days:-1825}" -subj "/C=US/ST=Unknown/L=Unknown/O=Unknown/CN=${hostname}.${domainname}" -nodes \
		-outform PEM -out /usr/share/univention-management-console/saml/pki/sp.pem \
		-keyform PEM -keyout /usr/share/univention-management-console/saml/pki/sp.key || exit 1
	chmod 0600 /usr/share/univention-management-console/saml/pki/sp.key || exit 1
fi

# 1. generate simplesamlphp configuration
ucr commit /etc/simplesamlphp/metadata/umc.php || exit 1
# 2. get the XML metadata from the previous generated configuration so that UMC can use it
wget --ca-certificate /etc/univention/ssl/ucsCA/CAcert.pem "https://${hostname}.${domainname}/simplesamlphp/saml2/idp/metadata.php" -O /usr/share/univention-management-console/saml/idp/simplesamlphp.xml || exit 1
# 3. rewrite UMC-PAM configuration to include every IDP entry
ucr commit /etc/pam.d/univention-management-console || exit 1
# 4. enable saml sasl module
ucr commit /etc/ldap/sasl2/saml || exit 1

echo 'In order to apply the new SAML configuration please restart the UMC-Webserver:'
echo 'service univention-management-console-web-server restart'

exit 0
