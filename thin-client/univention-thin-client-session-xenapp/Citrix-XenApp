#!/bin/sh
#
# Univention Client Session
#  Citrix session script
#
# Copyright (C) 2009-2010 Univention GmbH
#
# http://www.univention.de/
#
# All rights reserved.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License version 2 as
# published by the Free Software Foundation.
#
# Binary versions of this file provided by Univention to you as
# well as other copyrighted, protected or trademarked materials like
# Logos, graphics, fonts, specific documentations and configurations,
# cryptographic keys etc. are subject to a license agreement between
# you and Univention.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA

# overwrite user session selection
if [ -x /usr/share/univention-gdm-sessions/force-user-session ]; then
	session=$(/usr/share/univention-gdm-sessions/force-user-session $USER)
	if [ -n "$session" ] && [ "$session" != "$(basename $0)" ]; then
		if [ -e "/etc/gdm/Sessions/$session" ]; then
			exec "/etc/gdm/Sessions/$session"
		else
			exec "$session"
		fi
	fi
fi


# run a window-manager (metacity) to avoid optical failures of citrix-client
/usr/bin/metacity &

if test -e /tmp/passwd; then
    user_password=`cat /tmp/passwd`
    rm /tmp/passwd
fi
   
user=`whoami`

eval "$(/usr/sbin/univention-config-registry shell)"

if [ -n "$univentionSoundEnabled" -a "1" = "$univentionSoundEnabled" ]; then
    sound="-sound"
    arts="artsdsp"
fi

# Request the Windows logon domain from the policy
user_dn=$(ldapsearch -x "(&(uid=$user)(objectClass=posixAccount))" dn | ldapsearch-wrapper | grep ^dn\: | sed 's/dn\: //')
domain=$(univention-policy-result -s "$user_dn" | grep univentionThinClientUserWindowsDomain |   grep -o '".*"' | tr -d '"')
if [ -z "$domain" ]; then
	if [ -n "$univentionWindowsDomain" ]; then
		domain="$univentionWindowsDomain"
	elif [ -n "$windows_domain" ]; then
		domain="$windows_domain"
	else
		domain="$(ldapsearch -x -LLL sambaDomainName=* sambaDomainName | ldapsearch-wrapper | grep ^sambaDomainName | head -n 1 | sed -e 's|sambaDomainName: ||')"
	fi
fi

logonname=$user

# The logon name might be prefixed, strip them if necessary
if [ ! -z $thinclient_authentication_prefix1 ]; then
    if [ ! -z $thinclient_authentication_prefix2 ]; then
	logonname=`echo $user | sed -e "s/$thinclient_authentication_prefix1//" | sed -e "s/$thinclient_authentication_prefix2//"`
    fi
fi

if [ ! -e /usr/lib/ICAClient/wfica ]; then
    echo "The Citrix Receiver client hasn't been installed yet." > /tmp/msg
    echo "Please refer to http://sdb.univention.de/1137 for" >> /tmp/msg
    echo "further instructions" >> /tmp/msg
    xmessage -file /tmp/msg
    rm /tmp/msg
    exit 0
fi

$arts /usr/lib/ICAClient/wfica $sound -icaroot /usr/lib/ICAClient -nosplash /tmp/citrix.ica -domain "$domain" -username "$logonname" -clearpassword "$user_password"


