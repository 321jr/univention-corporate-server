#!/bin/sh
#
# Univention Client Uplash
#  init script: setting up a thin client bootsplash
#
# Copyright (C) 2004-2010 Univention GmbH
#
# http://www.univention.de/
#
# All rights reserved.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License version 2 as
# published by the Free Software Foundation.
#
# Binary versions of this file provided by Univention to you as
# well as other copyrighted, protected or trademarked materials like
# Logos, graphics, fonts, specific documentations and configurations,
# cryptographic keys etc. are subject to a license agreement between
# you and Univention.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software

SPLASH=true
VERBOSE=true

for x in $(cat /proc/cmdline); do
        case $x in
        nosplash*)
                SPLASH=false
                ;;
        quiet*)
                VERBOSE=false
                ;;
        esac
done

bootsplash_start() {

	xres=1024
	yres=768

	vga=$(cat /proc/cmdline | awk -F 'vga=' {'print $2'} | awk {'print $1'})

	if [ ! -d /dev/.initramfs ]; then
		mkdir /dev/.initramfs || true
	fi

	if [ -n "$vga" ]; then
	        if [ "$vga" = "791" -o "$vga" = "773" -o "$vga" = "790" -o "$vga" = "792" ]; then
	                xres=1024
	                yres=768
	        fi
	        if [ "$vga" = "775" -o "$vga" = "793" -o "$vga" = "794" -o "$vga" = "795" ]; then
	                xres=1280
	                yres=1024
	        fi
	        if [ "$vga" = "769" -o "$vga" = "784" -o "$vga" = "785" -o "$vga" = "786" ]; then
	                xres=640
	                yres=480
	        fi
	        if [ "$vga" = "771" -o "$vga" = "787" -o "$vga" = "788" -o "$vga" = "789" ]; then
	                xres=800
	                yres=600
	        fi
	        if [ "$vga" = "796" -o "$vga" = "797" -o "$vga" = "798" -o "$vga" = "799" ]; then
	                xres=1600
	                yres=1200
	        fi
	fi
	
	echo "xres=$xres" > /etc/usplash.conf
	echo "yres=$yres" >> /etc/usplash.conf

        if [ ! -c /dev/mem ]; then
                mknod -m 640 /dev/mem c 1 1
        fi
        if [ ! -c /dev/zero ]; then
                mknod -m 666 /dev/zero c 1 5
        fi
        for i in 0 1 2 3 4 5 6 7 8; do
                [ -c /dev/tty$i ] || mknod /dev/tty$i c 4 $i
        done
        modprobe -q i8042 2>/dev/null
        modprobe -q atkbd 2>/dev/null
        if [ "$VERBOSE" = true ]; then
                varg=-v
        else
                varg=
        fi
        if [ "$xres" ] && [ "$xres" != 0 ] && \
           [ "$yres" ] && [ "$yres" != 0 ]; then
                /sbin/usplash -c -x "$xres" -y "$yres" $varg &
        else
                /sbin/usplash -c $varg &
        fi
        sleep 1
        /sbin/usplash_write "TIMEOUT 600"
        /sbin/usplash_write "PULSATE"
        sleep 1
	# disable kernel bootsplash
	echo verbose > /proc/splash
}

bootsplash_stop() {
	/sbin/usplash_write "TIMEOUT 600"
	/sbin/usplash_write "PULSATE"
}

case "$1" in
  start)
	if [ "$SPLASH" = "true" ] ; then
	        bootsplash_start
	fi
        ;;
  stop)
        if [ "$SPLASH" = "true" ] ; then
        	bootsplash_stop
        fi
        ;;
  *)
        N=/etc/init.d/$NAME
        # echo "Usage: $N {start|stop|restart|reload|force-reload}" >&2
        echo "Usage: $N {start|stop}" >&2
        exit 1
        ;;
esac

exit 0
