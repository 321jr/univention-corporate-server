#!/bin/bash
#
# Univention Client Basesystem
#  init script: setting up a thin client
#
# Copyright 2004-2010 Univention GmbH
#
# http://www.univention.de/
#
# All rights reserved.
#
# The source code of this program is made available
# under the terms of the GNU Affero General Public License version 3
# (GNU AGPL V3) as published by the Free Software Foundation.
#
# Binary versions of this program provided by Univention to you as
# well as other copyrighted, protected or trademarked materials like
# Logos, graphics, fonts, specific documentations and configurations,
# cryptographic keys etc. are subject to a license agreement between
# you and Univention and not subject to the GNU AGPL V3.
#
# In the case you use this program under the terms of the GNU AGPL V3,
# the program is provided in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public
# License with the Debian GNU/Linux or Univention distribution in file
# /usr/share/common-licenses/AGPL-3; if not, see
# <http://www.gnu.org/licenses/>.

. /lib/lsb/init-functions

log_action_msg "Setting up Thin Client policy configuration"

eval $(univention-config-registry shell ldap/server/name ldap/hostdn)

# get and set poliy
policy="$(univention_policy_result -s -h $ldap_server_name -s "$ldap_hostdn" \
| sed 's|fixedAttributes=[^ ]*||g')"
eval ucr set $(echo "$policy")

# mapping
eval "$policy"
ucrMapping=$(while IFS== read var val; do
        if [ ! "\$$var" = "\$" ]; then
                # no value found
                if [ -z "$val" ]; then
                        continue
                fi
                # spaces are not allowed in var names -> remove them
                var=${var// /}
                if eval test -n \"\$${var}\"; then
                        echo \"$val=\$${var}\"
                fi
        fi
done < <(cat /etc/univention/templates/mapping/*.univention-config-registry-mapping))

# set mapping vars
if [ -n "$ucrMapping" ]; then
        eval ucr set $(echo "$ucrMapping")
fi

# interpret configuration registry policies
/usr/lib/univention-directory-policy/univention-policy-update-config-registry --setall "$ldap_hostdn" >>/dev/tty8 2>&1

eval $(univention-config-registry shell)

# set several basic configurations

registry_vals="portmap/autostart?yes locale/default?de_DE.UTF-8:UTF-8"

# set all desktopServer as possible timeserver
timeserver=""
for i in `cat $policy_file_result | grep univentionDesktopServer | sed -e 's|.*univentionDesktopServer=||' | sed -e 's|"||g'`; do
  if test -z "${timeserver}"; then
    timeserver="$i"
  else
    timeserver="$timeserver $i"
  fi
done

registry_vals="$registry_vals ntpdate/server=$timeserver"

for i in $timeserver; do
	if /bin/netcat -q0 -w4 $i 37 </dev/null >/dev/null 2>&1; then
		/usr/bin/rdate $i >/dev/tty8 2>&1
	fi
	/usr/sbin/ntpdate $i >/dev/tty8 2>&1 && break
done

/sbin/hwclock --systohc

# set authentication servers
authserver=''
for i in `cat $policy_file_result | grep univentionAuthServer | sed -e 's|.*univentionAuthServer=||' | sed -e 's|"||g'`; do
	authserver="$authserver $i"
done

if [ -n "$authserver" ]; then
	registry_vals="$registry_vals univentionAuthServer=$authserver"
fi

if [ -z "$kerberos_realm" ]; then
	# set kerberos realm
	realm=`/usr/bin/dns-lookup _kerberos.$domainname txt | head -1`
	if [ -z "$realm" ]; then
		echo "WARNING: Kerberos realm TXT record not found. Check the DNS for the TXT record _kerberos.$domainname"
	else
		registry_vals="$registry_vals kerberos/realm=$realm"
	fi
fi

univention-config-registry set $registry_vals >>/dev/tty8 2>&1
univention-config-registry commit /etc/init.d/portmap /etc/krb5.conf >>/dev/tty8 2>&1

# load kernel modules defined by policy
for module in $(echo $kernel_modules | sed 's/;/ /g'); do
	[ "$module" ] || continue
	modprobe $module >/dev/null 2>&1
done

mkdir -p /ramdisk/etc/cups/ppd/
mkdir -p /var/spool/cups/cert/

# DEBUG-Messages
if [ -n "$thinclient_debug" ]; then
	echo "Local-Settings:" > /dev/tty8
	echo "Policy-Settings:" > /dev/tty9

	univention-config-registry dump | grep -v univention > /dev/tty8
	univention-config-registry dump | grep univention > /dev/tty9
fi

log_action_end_msg 0
