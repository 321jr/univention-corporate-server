#!/bin/sh -e
#
# Univention Client Basesystem
#  init script: setting up a thin client
#
# Copyright (C) 2004, 2005, 2006, 2007 Univention GmbH
#
# http://www.univention.de/
#
# All rights reserved.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License version 2 as
# published by the Free Software Foundation.
#
# Binary versions of this file provided by Univention to you as
# well as other copyrighted, protected or trademarked materials like
# Logos, graphics, fonts, specific documentations and configurations,
# cryptographic keys etc. are subject to a license agreement between
# you and Univention.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software

echo -n "Setting up Thin Client policy configuration ... "

eval $(univention-baseconfig shell ldap/server/name ldap/hostdn)

policy_file=$(mktemp)
policy_file_result=$(mktemp)

univention_policy_result -h $ldap_server_name -s $ldap_hostdn | sed 's|fixedAttributes=[^ ]*||;s|"||g' >$policy_file
cat $policy_file | while read line; do

	# split the line a=b in a and b
	var="${line%%=*}"
	val="${line#*=}"

	if [ -n "$var" ] && [ -n "$val" ]; then
		new_value=$(grep "$var=" /etc/univention/templates/mapping/* | head -n 1 | sed -e 's|.*=||;s|"||g')
		if [ -n "${new_value}" ]; then
			echo $line | sed -e "s|${var}=|${new_value}=|g" >>$policy_file_result
		else
			echo $line >>$policy_file_result
		fi
	fi

done

univention-baseconfig set $(cat $policy_file_result) >/dev/tty8 2>&1

# interpret configuration registry policies
/usr/lib/univention-directory-policy/univention-policy-update-config-registry --setall $myDN >>/dev/tty8 2>&1

eval $(univention-baseconfig shell)

# set several basic configurations

registry_vals="portmap/autostart?yes locale/default?de_DE.UTF-8:UTF-8"

# set all desktopServer as possible timeserver
timeserver=""
for i in `cat $policy_file_result | grep univentionDesktopServer | sed -e 's|.*univentionDesktopServer=||' | sed -e 's|"||g'`; do
  timeserver="$timeserver $i"
done

registry_vals="$registry_vals ntpdate/server=$timeserver"

for i in $timeserver; do
	if /bin/netcat -q0 -w4 $i 37 </dev/null >/dev/null 2>&1; then
		/usr/sbin/rdate $i >/dev/tty8 2>&1
	fi
	/usr/sbin/ntpdate $i >/dev/tty8 2>&1 && break
done

/sbin/hwclock --systohc

# set authentication servers
authserver=''
for i in `cat $policy_file_result | grep univentionAuthServer | sed -e 's|.*univentionAuthServer=||' | sed -e 's|"||g'`; do
	authserver="$authserver $i"
done

if [ -n "$authserver" ]; then
	registry_vals="$registry_vals univentionAuthServer=$authserver"
fi

# set kerberos realm
realm=`/usr/bin/dns-lookup _kerberos.$domainname txt | head -1`
if [ -z "$realm" ]; then
	echo "WARNING: Kerberos realm TXT record not found. Check the DNS for the TXT record _kerberos.$domainname"
else
	registry_vals="$registry_vals kerberos/realm=$realm"
fi

univention-baseconfig set $registry_vals >>/dev/tty8 2>&1
univention-baseconfig commit /etc/init.d/portmap /etc/krb5.conf >>/dev/tty8 2>&1

# load kernel modules defined by policy
for module in $(echo $kernel_modules | sed 's/;/ /g'); do
	[ "$module" ] || continue
	modprobe $module >/dev/null 2>&1
done

mkdir -p /ramdisk/etc/cups/ppd/
mkdir -p /var/spool/cups/cert/

# DEBUG-Messages
if [ -n "$thinclient_debug" ]; then
	echo "Local-Settings:" > /dev/tty8
	echo "Policy-Settings:" > /dev/tty9

	univention-baseconfig dump | grep -v univention > /dev/tty8
	univention-baseconfig dump | grep univention > /dev/tty9
fi

echo "done"
