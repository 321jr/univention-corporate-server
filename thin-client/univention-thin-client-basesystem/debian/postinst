#!/bin/sh
#
# Univention Thin Client Basesystem
#  postinst script for the univention-client-basesystem debian package
#
# Copyright 2001-2010 Univention GmbH
#
# http://www.univention.de/
#
# All rights reserved.
#
# The source code of this program is made available
# under the terms of the GNU Affero General Public License version 3
# (GNU AGPL V3) as published by the Free Software Foundation.
#
# Binary versions of this program provided by Univention to you as
# well as other copyrighted, protected or trademarked materials like
# Logos, graphics, fonts, specific documentations and configurations,
# cryptographic keys etc. are subject to a license agreement between
# you and Univention and not subject to the GNU AGPL V3.
#
# In the case you use this program under the terms of the GNU AGPL V3,
# the program is provided in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public
# License with the Debian GNU/Linux or Univention distribution in file
# /usr/share/common-licenses/AGPL-3; if not, see
# <http://www.gnu.org/licenses/>.

eval `univention-baseconfig shell`


/etc/init.d/nfs-kernel-server reload || true

if test "`readlink /etc/skel`" = "/var/lib/univention-client-root/etc/skel"; then
	rm -f /etc/skel
	mv /etc/skel.orig /etc/skel
fi

if [ "$1" == "configure" -a -n "$2" ]; then

	if [ ! -L /var/lib/univention-client-root/home ]; then

		rm -Rf /var/lib/univention-client-root/home
		ln -sf /ramdisk/home /var/lib/univention-client-root/home

	fi

fi

# readd missing directories
for d in /var/lib/univention-client-root/usr/share/man/man{1,2,3,4,5,6,7,8,9} \
	usr/doc usr/games usr/share/man usr/share/man-db usr/share/info \
	usr/share/doc usr/share/doc-base usr/share/apps usr/share/common_licenses \
	usr/share/dict usr/share/calendar; do
	if [ ! -e "$d" ] ; then
		mkdir -p "$d"
	fi
done

#DEBHELPER#

if [ -e "/etc/univention/ssl/ucsCA/CAcert.pem" ]; then
	mkdir -p /var/lib/univention-client-root/etc/univention/ssl/ucsCA
	cp /etc/univention/ssl/ucsCA/CAcert.pem /var/lib/univention-client-root/etc/univention/ssl/ucsCA
	chmod 644 /var/lib/univention-client-root/etc/univention/ssl/ucsCA/CAcert.pem
fi


if [ -e /var/lib/univention-server-cdrom/sources.list ]; then
	cp /var/lib/univention-server-cdrom/sources.list /var/lib/univention-client-root/etc/apt/sources.list
else
	cp /etc/apt/sources.list /var/lib/univention-client-root/etc/apt/sources.list
fi

for path in usr/share/fonts/; do
	/usr/bin/fc-cache /var/lib/univention-client-root/$path
done

if [ -e /etc/libnss-ldap.conf ]; then
	cp /etc/libnss-ldap.conf /var/lib/univention-client-root/ramdisk/etc/libnss-ldap.conf
fi

/usr/lib/univention-install/33univention-client-basesystem.inst || true

if [ "$1" = "configure" -a -n "$2" ]; then
	# update the dpkg status file. Bug #16094
	/usr/share/univention-thin-client-basesystem/merge_dpkg_status.py >/var/lib/univention-client-root/var/lib/dpkg/status.NEW
	if [ $? = 0 ]; then
		mv /var/lib/univention-client-root/var/lib/dpkg/status /var/lib/univention-client-root/var/lib/dpkg/status.BAK
		mv /var/lib/univention-client-root/var/lib/dpkg/status.NEW /var/lib/univention-client-root/var/lib/dpkg/status
		univention-thin-client-apt install -f
	fi
fi

univention-thin-client-apt install univention-thin-client-basesystem-config

#univention-thin-client-apt dist-upgrade || true

# Bug #12288 - file is overwritten by locales package
ln -sf /ramdisk/etc/locale.gen /var/lib/univention-client-root/etc/locale.gen

exit 0
