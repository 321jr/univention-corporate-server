#!/bin/sh -e
#
# Univention Thin Client Basesystem
#  postinst script for the univention-client-basesystem debian package
#
# Copyright (C) 2001, 2002, 2003, 2004, 2005, 2006 Univention GmbH
#
# http://www.univention.de/
#
# All rights reserved.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License version 2 as
# published by the Free Software Foundation.
#
# Binary versions of this file provided by Univention to you as
# well as other copyrighted, protected or trademarked materials like
# Logos, graphics, fonts, specific documentations and configurations,
# cryptographic keys etc. are subject to a license agreement between
# you and Univention.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.	See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA	 02110-1301	 USA

eval `univention-baseconfig shell`


/etc/init.d/nfs-kernel-server reload || true

if test "`readlink /etc/skel`" = "/var/lib/univention-client-root/etc/skel"; then
	rm -f /etc/skel
	mv /etc/skel.orig /etc/skel
fi

if [ "$1" == "configure" -a -n "$2" ]; then

	if [ ! -L /var/lib/univention-client-root/home ]; then

		rm -Rf /var/lib/univention-client-root/home
		ln -sf /ramdisk/home /var/lib/univention-client-root/home

	fi

fi

# readd missing directories
for d in /var/lib/univention-client-root/usr/share/man/man{1,2,3,4,5,6,7,8,9} \
	usr/doc usr/games usr/share/man usr/share/man-db usr/share/info \
	usr/share/doc usr/share/doc-base usr/share/apps usr/share/common_licenses \
	usr/share/dict usr/share/calendar; do
	if [ ! -e "$d" ] ; then
		mkdir -p "$d"
	fi
done

#DEBHELPER#

if [ -e "/etc/univention/ssl/ucsCA/CAcert.pem" ]; then
	mkdir -p /var/lib/univention-client-root/etc/univention/ssl/ucsCA
	cp /etc/univention/ssl/ucsCA/CAcert.pem /var/lib/univention-client-root/etc/univention/ssl/ucsCA
	chmod 644 /var/lib/univention-client-root/etc/univention/ssl/ucsCA/CAcert.pem
fi


if [ -e /var/lib/univention-server-cdrom/sources.list ]; then
	cp /var/lib/univention-server-cdrom/sources.list /var/lib/univention-client-root/etc/apt/sources.list
else
	cp /etc/apt/sources.list /var/lib/univention-client-root/etc/apt/sources.list
fi

for path in usr/share/fonts/; do
	/usr/bin/fc-cache /var/lib/univention-client-root/$path
done

if [ -e /etc/libnss-ldap.conf ]; then
	cp /etc/libnss-ldap.conf /var/lib/univention-client-root/ramdisk/etc/libnss-ldap.conf
fi

/usr/lib/univention-install/33univention-client-basesystem.inst || true

univention-thin-client-apt install univention-thin-client-basesystem-config

univention-thin-client-apt dist-upgrade || true

exit 0
