[EC2Tags]
usecase: dev-jenkins-ucs4.2

[Global]
# These settings can be overwritten by the instance
logfile: app-appliance-setup.log

kvm_server: KVM_BUILD_SERVER
# kvm_user: build
kvm_user: build
kvm_architecture: amd64
kvm_ucsversion: 4.1-0
kvm_template: generic-v2
kvm_interface: eth0

[ucsmaster-app]
profile:
command1:
 ucr set repository/online/server="REPOSITORY_SERVER"
 echo "deb http://192.168.0.10/build2/ ucs_4.1-0-appliance/all/" >> /etc/apt/sources.list
 echo "deb http://192.168.0.10/build2/ ucs_4.1-0-appliance/\$(ARCH)/" >> /etc/apt/sources.list
 echo "deb http://192.168.0.10/build2/ ucs_4.1-0-errata4.1-1/all/" >> /etc/apt/sources.list
 echo "deb http://192.168.0.10/build2/ ucs_4.1-0-errata4.1-1/\$(ARCH)/" >> /etc/apt/sources.list
 ucr set update/secure_apt=no
 . utils.sh; upgrade_to_latest_patchlevel
 reboot
 LOCAL sleep 60
 . utils.sh && wait_for_reboot
command2:
command3:
 ucr set updater/identify="Univention App 4.1 Appliance APP_ID (KVM)"
 ucr set repository/app_center/server="APP_CENTER_SERVER"
 . base_appliance-beta.sh; setup_pre_joined_environment
 . base_appliance-beta.sh; setup_appliance APP_ID
 . base_appliance-beta.sh; register_apps APP_ID
 . base_appliance-beta.sh; install_pre_packages APP_ID
 . base_appliance-beta.sh; download_packages_and_dependencies APP_ID
 . base_appliance-beta.sh; create_install_script APP_ID
 . base_appliance-beta.sh; install_app_in_prejoined_setup APP_ID
 . base_appliance-beta.sh; appliance_basesettings APP_ID
 . base_appliance-beta.sh; install_activation_packages
 . base_appliance-beta.sh; appliance_reset_servers
 . base_appliance-beta.sh; appliance_cleanup
# sleep 3600
 . base_appliance-beta.sh; disable_root_login_and_poweroff
command4:
 LOCAL sleep 60
 LOCAL ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no build@KVM_BUILD_SERVER mkdir -p /tmp/build-APP_ID/
 LOCAL ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no build@KVM_BUILD_SERVER qemu-img convert -p -c -O qcow2 /var/lib/libvirt/images/build_ucsmaster-app.qcow2 /tmp/build-APP_ID/master.qcow2
 LOCAL ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no build@KVM_BUILD_SERVER ucs-kt-remove build_ucsmaster-app
 LOCAL scp -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -r build@KVM_BUILD_SERVER:/tmp/build-APP_ID /tmp/
 LOCAL scp -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -r /tmp/build-APP_ID build@docker.knut.univention.de:/tmp/
 LOCAL ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no build@omar.knut.univention.de mkdir -p /var/univention/buildsystem2/mirror/appcenter.test/univention-apps/4.1/APP_ID-beta/
 LOCAL scp -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no /tmp/build-APP_ID/master.qcow2 build@omar.knut.univention.de:/var/univention/buildsystem2/mirror/appcenter.test/univention-apps/4.1/APP_ID-beta/Univention-App-APP_ID-KVM.qcow2
 LOCAL ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no build@KVM_BUILD_SERVER rm -f /tmp/build-APP_ID/master.qcow2
 LOCAL rm -f /tmp/build-APP_ID/master.qcow2
command5:
# vmware player
 LOCAL ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no build@docker.knut.univention.de guestfish add /tmp/build-APP_ID/master.qcow2 : run : mount /dev/vg_ucs/root / : command \"/usr/sbin/ucr set updater/identify=\'Univention App 4.1 Appliance APP_ID \(VMware\)\'\"
 LOCAL ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no build@docker.knut.univention.de "test -e /tmp/build-APP_ID/Univention-App-APP_ID-vmware.zip && rm /tmp/build-APP_ID/Univention-App-APP_ID-vmware.zip || true"
 LOCAL ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no build@docker.knut.univention.de generate_appliance -m '$(< /tmp/ucsmaster-APP_ID.memory)' -p UCS -v 4.1-with-APP_ID -o --vmware -s /tmp/build-APP_ID/master.qcow2 -f "Univention-App-APP_ID"
 LOCAL scp -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no build@docker.knut.univention.de:Univention-App-APP_ID-vmware.zip /tmp/build-APP_ID/
 LOCAL scp -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no /tmp/build-APP_ID/Univention-App-APP_ID-vmware.zip build@omar.knut.univention.de:/var/univention/buildsystem2/mirror/appcenter.test/univention-apps/4.1/APP_ID-beta/Univention-App-APP_ID-vmware.zip
 LOCAL ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no build@omar.knut.univention.de "(cd /var/univention/buildsystem2/mirror/appcenter.test/univention-apps/4.1/APP_ID-beta/; md5sum Univention-App-APP_ID-vmware.zip >Univention-App-APP_ID-vmware.zip.md5; chmod 644 Univention-App-APP_ID-vmware.zip*)"
 LOCAL ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no build@docker.knut.univention.de rm -f Univention-App-APP_ID-vmware.zip
 LOCAL rm /tmp/build-APP_ID/Univention-App-APP_ID-vmware.zip
command6:
# virtualbox
 LOCAL ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no build@docker.knut.univention.de guestfish add /tmp/build-APP_ID/master.qcow2 : run : mount /dev/vg_ucs/root / : command \"/usr/sbin/ucr set updater/identify=\'Univention App 4.1 Appliance APP_ID \(VirtualBox\)\'\"
 LOCAL ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no build@docker.knut.univention.de "test -e Univention-App-APP_ID-virtualbox.ova && rm Univention-App-APP_ID-virtualbox.ova || true"
 LOCAL ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no build@docker.knut.univention.de generate_appliance -m '$(< /tmp/ucsmaster-APP_ID.memory)' -p UCS -v 4.1-with-APP_ID -o --ova-virtualbox -s /tmp/build-APP_ID/master.qcow2 -f "Univention-App-APP_ID"
 LOCAL scp -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no build@docker.knut.univention.de:Univention-App-APP_ID-virtualbox.ova /tmp/build-APP_ID/
 LOCAL scp -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no /tmp/build-APP_ID/Univention-App-APP_ID-virtualbox.ova build@omar.knut.univention.de:/var/univention/buildsystem2/mirror/appcenter.test/univention-apps/4.1/APP_ID-beta/Univention-App-APP_ID-virtualbox.ova
 LOCAL ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no build@omar.knut.univention.de "(cd /var/univention/buildsystem2/mirror/appcenter.test/univention-apps/4.1/APP_ID-beta/; md5sum Univention-App-APP_ID-virtualbox.ova >Univention-App-APP_ID-virtualbox.ova.md5; chmod 644 Univention-App-APP_ID-virtualbox.ova*)"
 LOCAL ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no build@docker.knut.univention.de rm -f Univention-App-APP_ID-virtualbox.ova
 LOCAL rm -f /tmp/build-APP_ID/Univention-App-APP_ID-virtualbox.ova
# originally from command 8
 LOCAL ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no build@docker.knut.univention.de rm -r /tmp/build-APP_ID/
files:
 examples/jenkins/utils/*sh /root/
