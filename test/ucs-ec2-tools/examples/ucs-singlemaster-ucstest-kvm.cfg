[EC2Tags]
usecase: dev-jenkins-ucs4.1

[Global]
# These settings can be overwritten by the instance
logfile: ~/ec2/logfiles/singlemaster-test-kvm.log

kvm_server: isala
kvm_architecture: amd64
kvm_ucsversion: 3.1-1
kvm_template: generic
kvm_interface: eth0
kvm_user: build

[singlemaster-test]
profile:
 hostname="ucs"
 domainname="test.local"
 windows/domain="TEST"
 ldap/base="dc=test,dc=local"
 root_password="univention"
 locale/default="de_DE.UTF-8:UTF-8"
 ssl/email="ssl@test.local"
 timezone="Europe/Berlin"
 server/role="domaincontroller_master"
 packages_install="univention-s4-connector univention-samba4"
 packages_remove=""
 interfaces/eth0/address="10.200.99.2"
 interfaces/eth0/broadcast="10.200.99.255"
 interfaces/eth0/netmask="24"
 interfaces/eth0/network="10.200.99.0"
 gateway="10.200.99.1"
 nameserver1="192.168.0.3"
command1:
 ucr set updater/identify="UCS (EC2 Test)"
 # add ssh key
 mkdir /root/.ssh; chmod 700 /root/.ssh; cat /root/id_rsa.pub >> /root/.ssh/authorized_keys ; rm -f /root/id_rsa.pub
 # profile will be moved by Univention System Setup Boot - wait until USSB has been started and then move profile back
 while [ ! -f "/var/cache/univention-system-setup/browser.pid" ] ; do sleep 1s; echo -n .; done ; echo
 mv /var/cache/univention-system-setup/profile.bak /var/cache/univention-system-setup/profile || true
 /usr/lib/univention-system-setup/scripts/setup-join.sh
command2:
 ucr set repository/online/server=updates-test.software-univention.de
 univention-upgrade --noninteractive --ignoressh --ignoreterm
 # Workaround for Bug #31561
 sleep 10
 univention-upgrade --noninteractive --ignoreterm --ignoressh
command3:
 reboot
 LOCAL sleep 40
command4:
 ucr set repository/online/unmaintained=true
 univention-install --yes ucs-test
 ucr set repository/online/unmaintained=false
 ucs-test -E dangerous -s base
command5:
 LOCAL mkdir -p ~/ec2/testresult/singlemaster-test-kvm
 LOCAL scp root@[[singlemaster-test_IP]]:/var/log/univention/test* ~/ec2/testresult/singlemaster-test-kvm/
files:
 ~/.ssh/id_rsa.pub /root/
