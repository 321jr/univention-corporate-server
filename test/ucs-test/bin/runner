#!/usr/bin/python
# vim: set fileencoding=utf-8 ft=python sw=4 ts=4 noet :
#
# UCS Testrunner - run UCS test in sane environment
#
import sys
from optparse import OptionParser
from univention.testing.utils import setup_environment, setup_debug
from univention.testing.data import *
import univention.testing.format

def main():
	usage = "Usage: %prog [options] <lang> <file>"
	parser = OptionParser(usage=usage)
	parser.add_option("-v", "--verbose", dest="verbose", action="count", help="Increase verbosity")
	parser.add_option("-f", "--force", dest="force", action="store_true", help="Disable pre-condition check")
	parser.add_option("-F", "--format", dest="format", action="store", choices=univention.testing.format.FORMATS, default='text', help="Select output format [%default]")
	(options, args) = parser.parse_args()
	setup_environment()
	setup_debug(options.verbose)

	try:
		exe, lang, fn = sys.argv[0:3]
		del sys.argv[0:2]
	except ValueError, e:
		parser.print_usage(sys.stderr)
		sys.exit(2)

	formatter = getattr(univention.testing.format, 'format_%s' % (options.format,))
	format = formatter()
	te = TestEnvironment(interactive=True)
	if options.force:
		te.set_exposure('dangerous')
	tc = TestCase().load(fn)
	tr = TestResult(tc, te).run()
	format.format(tr)

if __name__ == '__main__':
	try:
		main()
	except KeyboardInterrupt, e:
		sys.exit(1)
