#!/usr/share/ucs-test/runner python
## desc: Validate nagios for all computer roles
## tags: [udm-computers]
## roles: [domaincontroller_master]
## exposure: careful
## packages:
##   - univention-config
##   - univention-directory-manager-tools


import univention.testing.udm as udm_test
import univention.testing.strings as uts
import univention.testing.utils as utils
import univention.config_registry as configRegistry

if __name__ == '__main__':
	ucr = configRegistry.ConfigRegistry()
	ucr.load()
	ldap = utils.get_ldap_connection()

	for role in udm_test.UCSTestUDM.COMPUTER_MODULES:
		with udm_test.UCSTestUDM() as udm:
			forwardZone = udm.create_object('dns/forward_zone', zone = '%s.%s' % (uts.random_name(), uts.random_name()), nameserver = uts.random_string())
			parentBackupName = uts.random_name()
			parentBackup = udm.create_object('computers/domaincontroller_backup', name = parentBackupName, options = ['nagios'], ip = '10.20.30.2', dnsEntryZoneForward = forwardZone)

			nagiosService = udm.create_object('nagios/service', name = uts.random_name(), checkCommand = uts.random_string(), checkPeriod = uts.random_string(), notificationPeriod = uts.random_string())

			properties = {
				'dnsEntryZoneForward': forwardZone,
				'nagiosServices': nagiosService,
				'nagiosContactEmail': '%s@%s.%s' % (uts.random_name(), uts.random_name(), uts.random_name()),
				'nagiosParents': parentBackup,
				'name': uts.random_name(),
				'ip': '10.20.30.3',
			}


			# FIXME: workaround for remaining locks
			udm.addCleanupLock('aRecord', properties['ip'])

			computer = udm.create_object(role, options = ['nagios'], **properties)
				
			if not utils.verify_ldap_object(computer, {
				'univentionNagiosEmail': [properties['nagiosContactEmail']],
				'univentionNagiosEnabled': ['1'],
				'univentionNagiosParent': ['%s.%s' % (parentBackupName, ldap.getAttr(parentBackup, 'associatedDomain')[0])]
			}):
				utils.fail('Nagios properties of created %s differ from expectatations' % role)

			if not utils.verify_ldap_object(nagiosService, {'univentionNagiosHostname': ['%s.%s' % (properties['name'], ldap.getAttr(computer, 'associatedDomain')[0])]}):
				utils.fail('Could not find created %s at nagios service as expected')
