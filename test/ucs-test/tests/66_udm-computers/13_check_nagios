#!/usr/share/ucs-test/runner bash 
## desc: "Check nagios for all computer roles"
## exposure: dangerous
## packages:
## - univention-directory-manager-tools
## roles:
## - domaincontroller_master

. "$TESTLIBPATH/udm.sh" || exit 137
. "$TESTLIBPATH/ldap.sh" || exit 137
. "$TESTLIBPATH/random.sh" || exit 137

UDM_dns_forward_zone_zone="$(random_chars)"
UDM_dns_forward_zone_nameserver="$(random_chars)"
udm_create "dns/forward_zone"
udm_exists "dns/forward_zone" || fail_test 110

UDM_dns_reverse_zone_nameserver="$(random_chars)"
UDM_dns_reverse_zone_subnet="1.2"
udm_create "dns/reverse_zone"
UDM_dns_reverse_zone_subnet="2.1.in-addr.arpa"
udm_exists "dns/reverse_zone" || fail_test 110

UDM_computers_domaincontroller_backup_name="$(random_chars)"
UDM_computers_domaincontroller_backup_ip="1.2.3.4"
UDM_computers_domaincontroller_backup_dnsEntryZoneForward="zoneName=$UDM_dns_forward_zone_zone,cn=dns,$ldap_base $UDM_computers_domaincontroller_backup_ip"
UDM_computers_domaincontroller_backup_dnsEntryZoneReverse="zoneName=$UDM_dns_reverse_zone_subnet,cn=dns,$ldap_base $UDM_computers_domaincontroller_backup_ip"
udm_create "computers/domaincontroller_backup" "" "" "" "" --option nagios || fail_test 110
udm_exists "computers/domaincontroller_backup" || fail_test 110

UDM_computers_name="$(random_chars)"
UDM_computers_mac="06:05:04:03:02:01"
UDM_computers_ip="1.2.3.5"
UDM_computers_dnsEntryZoneForward="zoneName=$UDM_dns_forward_zone_zone,cn=dns,$ldap_base $UDM_computers_ip"
UDM_computers_dnsEntryZoneReverse="zoneName=$UDM_dns_reverse_zone_subnet,cn=dns,$ldap_base $UDM_computers_ip"
UDM_computers_nagiosServices="cn=UNIVENTION_PING,cn=nagios,$ldap_base"
UDM_computers_nagiosContactEmail="$(random_chars)@$(random_chars).$(random_chars)"
UDM_computers_nagiosParents="cn=$UDM_computers_domaincontroller_backup_name,cn=computers,$ldap_base"

# We want to test the UDM modules, so we stop the S4 connector to prevent side effects
test -x /etc/init.d/univention-s4-connector && /etc/init.d/univention-s4-connector stop

for role in $UDM_ALL_COMPUTER_ROLES; do

	info "*** $role ***"

	if ! udm_create "$role" "UDM_computers_" "" "" "" --option nagios; then
		error "Failed creating $role object"
		error "Maybe the reason is #15699 or #15721"
		fail_test 121
	fi

	if ! udm_exists "$role" "UDM_computers_"; then
		error "Can't find computer-object with 'udm $role list'"
		error "See: #15729"
		fail_test 121
	fi

	udm_verify_udm_attribute nagiosServices "$UDM_computers_nagiosServices" "$role" "UDM_computers_" || fail_test 110
	udm_verify_udm_attribute nagiosContactEmail "$UDM_computers_nagiosContactEmail" "$role" "UDM_computers_" || fail_test 110
	udm_verify_udm_attribute nagiosParents "$UDM_computers_nagiosParents" "$role" "UDM_computers_" || fail_test 110

	udm_remove "$role" "UDM_computers_" "" "" "" --remove_referring || fail_test 110
	! udm_exists "$role" "UDM_computers_" || fail_test 110
done

udm_remove "computers/domaincontroller_backup" "" "" "" "" --remove_referring || fail_test 110
! udm_exists "computers/domaincontroller_backup" || fail_test 110

udm_remove "dns/reverse_zone" || fail_test 110
! udm_exists "dns/reverse_zone" || fail_test 110

udm_remove "dns/forward_zone" || fail_test 110
! udm_exists "dns/forward_zone" || fail_test 110

test -x /etc/init.d/univention-s4-connector && /etc/init.d/univention-s4-connector start

exit "$RETVAL"
