#!/usr/share/ucs-test/runner python
## desc: "Rename a user and test sync"
## roles: [domaincontroller_master]
## exposure: dangerous
## packages:
##   - univention-config
##   - univention-directory-manager-tools
##   - univention-samba4
##   - univention-s4-connector
#
#  Bug #31324


import univention.testing.utils as utils
import univention.testing.udm as udm_test
import univention.testing.strings as uts
import subprocess
import re
import univention.config_registry
ucr = univention.config_registry.ConfigRegistry()
ucr.load()
from time import sleep
import dnstests



if __name__ == '__main__':
	with udm_test.UCSTestUDM() as udm:

		new_user_name = uts.random_name()

		user_dn, user_name = udm.create_user()

		utils.verify_ldap_object(user_dn)

		dnstests.wait_for_sync()

		dnstests.check_user(user_dn)

		user_surname = dnstests.get_user_surname(user_dn)

		modified_user_dn = dnstests.modify_username(user_dn, new_user_name, udm)

		dnstests.wait_for_sync()

		dnstests.check_user(modified_user_dn, user_surname, user_dn)

		utils.verify_ldap_object(modified_user_dn)

	dnstests.wait_for_sync()
