#!/usr/share/ucs-test/runner python
## desc: Test the output of the UMC service module
## bugs: [34445]
## tags: [apptest]
## exposure: safe

import sys

from univention.config_registry import ConfigRegistry
import univention.testing.utils as utils
from univention.lib.umc_connection import UMCConnection


def main():
    # getting credentials from the registry
    try:
        UCR = ConfigRegistry()
        UCR.load()
        username = UCR['tests/domainadmin/account']
        password = UCR['tests/domainadmin/pwd']
        hostname = UCR['hostname']

        # extracting the 'uid' value of the username string
        username = username.split(',')[0][len('uid='):]
    except Exception as exc:
        utils.fail("Failed to retrive credentials and/or a hostname "
                   "for a test via UCR: %s" % str(exc))
    if hostname is None:
        utils.fail("The 'hostname' cannot be None")

    # creating a connection and authenticating
    try:
        Connection = UMCConnection(hostname)
        Connection.auth(username, password)
    except Exception as exc:
        utils.fail("Failed to authenticate, hostname '%s' : %s" %
                   (hostname, str(exc)))

    # making a services/query request
    try:
        request_result = Connection.request('services/query')
        if not request_result:
            utils.fail("Request 'services/query' failed, hostname %s" %
                       hostname)
    except Exception as exc:
        utils.fail("Exception while making services/query request: %s" %
                   str(exc))

    # checking the response structure for obligatory keys
    for result in request_result:
        if not 'service' in result:
            utils.fail("The 'service' field was not found in the "
                       "UMC response")
        if not 'isRunning' in result:
            utils.fail("The 'isRunning' field was not found in the "
                       "UMC response")
        if not 'description' in result:
            utils.fail("The 'description' field was not found in the "
                       "UMC response")
        if not 'autostart' in result:
            utils.fail("The 'autostart' field was not found in the "
                       "UMC response")

    # check if 'Univention Directory Listener' was listed in the response
    is_in_results = False
    for result in request_result:
        if result['service'] == 'univention-directory-listener':
            is_in_results = True
            break
    if not is_in_results:
        utils.fail("The 'Univention Directory Listener' service was not found "
                   "in the UMC response")


if __name__ == '__main__':
    sys.exit(main())
