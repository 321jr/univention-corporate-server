#!/usr/share/ucs-test/runner bash
## desc: "Display samba Groups as normal user"
## exposure: safe
## packages:
##  - univention-samba | univention-samba4
## roles-not: 
## - basesystem
## - memberserver
## tags: [basic]

. "$TESTLIBPATH/user.sh" || exit 137

SAMBA="true"
MAIL="false"
KERBEROS="true"
PERSON="false"
POSIX="true"

username="$(user_randomname)"
password="univention"

trap 'user_remove "$username"' INT TERM EXIT
if ! user_create "$username"; then
	fail_fast 1 "Failed to create user"
fi

if checkpkg "univention-samba4"; then
	#wait for user replication
	t0=$(date +%Y%m%d%H%M%S)
	sambaSID=$(univention-ldapsearch -xLLL uid="$username" sambaSID | sed -n 's/^sambaSID: //p')
	i=0
	if [ -z "${sambaSID%S-1-4*}" ]; then
		echo -n "Waiting for S4-Connector and LDAP replication of domain sambaSID for user $username (current: $sambaSID)."
		while [ -z "${sambaSID%S-1-4*}" ]; do
			if [ "$i" = 30 ]; then
				t=$(date +%Y%m%d%H%M%S)
				fail_fast 1 "TIMEOUT: No domain sambaSID replicated to local LDAP after $(($t-$t0)) seconds"
			fi
			sleep 1
			echo -n "."
			i=$(($i+1))
			sambaSID=$(univention-ldapsearch -xLLL uid="$username" sambaSID | sed -n 's/^sambaSID: //p')
		done
		echo
	fi
	t1=$(date +%Y%m%d%H%M%S)

	objectSid=$(ldbsearch -H /var/lib/samba/private/sam.ldb sAMAccountName="$username" objectSid | sed -n 's/^objectSid: //p')
	i=0
	if [ -z "$objectSid" ]; then
		echo -n "Waiting for DRS replication of ObjectSid for user $username."
		while [ -z "$objectSid" ]; do
			if [ "$i" = 360 ]; then
				t=$(date +%Y%m%d%H%M%S)
				fail_fast 1 "TIMEOUT: No samba account replicated to local sam.ldb after $(($t-$t0)) seconds"
			fi
			sleep 1
			echo -n "."
			i=$(($i+1))
			objectSid=$(ldbsearch -H /var/lib/samba/private/sam.ldb sAMAccountName="$username" objectSid | sed -n 's/^objectSid: //p')
		done
		echo
	fi
	t2=$(date +%Y%m%d%H%M%S)
	echo "DRS Replication took $(($t2-$t0)) seconds (sambaSID was correct in local LDAP after $(($t1-$t0)) seconds)"
else
	wait_for_replication
fi


echo "----print samba groups as a user"
if checkpkg "univention-samba4"; then
	output="$(samba-tool group list -U "$username%$password" | grep -q "Domain Users")"
else
	output="$(net rpc group -U "$username%$password" | grep "Domain Users")"
fi
if [ "$?" != 0 ]; then
	echo "$output"
	fail_test 1 "The test trying to display samba-Groups as a user failed"
fi
exit $RETVAL
