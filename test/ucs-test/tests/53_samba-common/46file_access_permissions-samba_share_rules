#!/usr/share/ucs-test/runner bash
## desc: "Test whether samba share rules set with UDM are working"
## exposure: safe
## packages:
##  - univention-samba | univention-samba4
## roles:
## - domaincontroller_master
## - domaincontroller_backup
## - domaincontroller_slave

. "$TESTLIBPATH/user.sh" || exit 137
. "$TESTLIBPATH/shares.sh" || exit 137
. "$TESTLIBPATH/random.sh" || exit 137
. "$TESTLIBPATH/samba.sh" || exit 137

#----create User
echo ----"create User"
SAMBA="true"
MAIL="false"
KERBEROS="true"
PERSON="false"
POSIX="true"

username="$(user_randomname)"
password=univention
sharename="$(random_share)"

trap 'user_remove "$username";share_remove "$sharename";wait_for_replication_and_postrun; rm -rf "/${sharename:?}";' INT TERM EXIT
if ! user_create "$username"; then
	fail_fast 1 "Could not create user $username."
fi

echo "----create Share"
#----create Share
SHARE_POSITION="cn=shares,$ldap_base"
udm-test shares/share create --position="$SHARE_POSITION" \
	--set name="$sharename" \
	--set path="/$sharename" \
	--set directorymode=0777 \
	--set host="$hostname.$domainname"
if [ "$?" != 0 ]; then
	fail_fast 1 "could not create share"
fi

wait_for_replication_and_postrun

if dpkg -s univention-samba4 2>&1 | grep "install ok installed" > /dev/null; then
# force_drs_replication
	wait_for_drs_replication "(sAMAccountName=$username)"
fi

SHARE_DN="$(udm-test shares/share list --filter sambaName="$sharename" | sed -ne 's/^DN: //p')"

USER_DN="$(udm-test users/user list --filter uid="$username" | sed -ne 's/^DN: //p')"


## wait for samba share export
echo "----wait for samba share export"
i=0
sleep_seconds=3
while ! output="$(smbclient -U "$username%$password" "//$hostname.$domainname/$sharename" -c "exit" 2>&1)"
do
	let i="$i"+1
	if [ "$i" = 10 ]; then
		echo "$output"
		fail_fast 1 "TIMEOUT: Samba did not export the share '$sharename' after $((i * $sleep_seconds)) seconds"
	fi
	sleep "$sleep_seconds"
done

#--Tests
#----Testing general connection
echo "----Testing general connection"
smbclient -U "$username%$password" "//$hostname.$domainname/$sharename" -c "exit" >/dev/null 2>&1
if [ "$?" != 0 ];then
	fail_test 1 "Could not connect to the share."
fi

#----making a folder
echo "----Making a folder in the share"
output="$(smbclient -U "$username%$password" "//$hostname.$domainname/$sharename" -c "mkdir folder2" 2>&1)"
if [ "$?" != 0 ];then
	echo "$output"
	fail_test 1 "Failed to make a folder even though it should work."
fi

if ! udm-test shares/share modify --dn="$SHARE_DN" --set "sambaInvalidUsers=$username"; then 
	fail_test 1 "Could not modify share $sharename."
fi

#----making a folder with the user listed on sambaInvalidUsers
echo "----Try to make a folder in the share with the user listed on sambaInvalidUsers"
output="$(smbclient -U "$username%$password" "//$hostname.$domainname/$sharename" -c "mkdir folder" 2>&1)"
echo "$output" | grep -q "NT_STATUS_ACCESS_DENIED"
if [ "$?" != 0 ]; then
	fail_test 1 "Expected return value NT_STATUS_ACCESS_DENIED, but received: $output"
fi

USER_GROUPID=$(univention-ldapsearch -b "$USER_DN" | sed -ne 's/^gidNumber: //p')
USER_GROUP=$(udm-test groups/group list --filter gidNumber="$USER_GROUPID" | sed -ne 's/^  name: //p')

if ! udm-test shares/share modify --dn="$SHARE_DN" --remove "sambaInvalidUsers=$username" || ! udm-test shares/share modify --dn="$SHARE_DN" --set "sambaValidUsers=$username" || ! udm-test shares/share modify --dn="$SHARE_DN" --set sambaInvalidUsers=@"\"$USER_GROUP\""; then 
	fail_test 1 "Could not modify share $sharename."
fi

#----try to connect to a share with the user listed on sambaValidUsers and the user's group listed on sambaInvalidUsers
echo "----Try to make a folder in the share with the user listed on sambaInvalidUsers and the user's group listed on sambaInvalidUsers"
output="$(smbclient -U "$username%$password" "//$hostname.$domainname/$sharename" -c "mkdir folder" 2>&1)"
echo "$output" | grep -q "NT_STATUS_ACCESS_DENIED"
if [ "$?" != 0 ]; then
	fail_test 1 "Expected return value NT_STATUS_ACCESS_DENIED, but received: $output"
fi


#----making a folder in a share with sambaWriteable=No"
if ! udm-test shares/share modify --dn="$SHARE_DN" --remove sambaInvalidUsers=@"\"$USER_GROUP\"" || ! udm-test shares/share modify --dn="$SHARE_DN" --set "sambaWriteable=0"; then 
	fail_test 1 "Could not modify share $sharename."
fi

echo "----Try to make a folder in a share with sambaWriteable=No"
output="$(smbclient -U "$username%$password" "//$hostname.$domainname/$sharename" -c "mkdir folder3" 2>&1)"
echo "$output" | grep -q "NT_STATUS_MEDIA_WRITE_PROTECTED"
if [ "$?" != 0 ]; then
	fail_test 1 "Expected return value NT_STATUS_MEDIA_WRITE_PROTECTED, but received: $output"
fi


exit "$RETVAL"
