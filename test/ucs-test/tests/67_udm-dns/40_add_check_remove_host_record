#!/usr/share/ucs-test/runner python
## desc: Create DNS host record, check if attributes are set correctly and remove it again
## tags: [udm-dns,apptest]
## roles: [domaincontroller_master]
## exposure: careful
## packages:
##   - univention-config
##   - univention-directory-manager-tools



import univention.testing.utils as utils
import univention.testing.udm as udm_test
import univention.testing.strings as uts


if __name__ == '__main__':
	forwardZoneName = '%s.%s' % (uts.random_name(), uts.random_name())
	hostRecordProperties = {
		'name': uts.random_name(),
		'zonettl': '128',
		'a': '10.20.30.40',
		'mx': '50 %s' % uts.random_string(),
		'txt': uts.random_string()
	}
	ldapMapping = {
		'name': 'relativeDomainName',
		'zonettl': 'dNSTTL',
		'a': 'aRecord',
		'txt': 'tXTRecord',
		'mx': 'mXRecord'
	}

	with udm_test.UCSTestUDM() as udm:
		forwardZone = udm.create_object('dns/forward_zone', zone = forwardZoneName, nameserver = uts.random_string())
		hostRecord = udm.create_object('dns/host_record', superordinate = forwardZone, **hostRecordProperties)

		if not utils.verify_ldap_object(hostRecord, {
			'relativeDomainName': [hostRecordProperties['name']],
			'dNSTTL': [hostRecordProperties['zonettl']],
			'aRecord': [hostRecordProperties['a']],
			'tXTRecord': [hostRecordProperties['txt']],
			'mXRecord': [hostRecordProperties['mx']]
		}):
			utils.fail()

		udm.remove_object('dns/host_record', dn = hostRecord, superordinate = forwardZone)
		if utils.verify_ldap_object(hostRecord):
			utils.fail('Could still find DNS host record "%s" in LDAP after it should have been removed' % hostRecord)
