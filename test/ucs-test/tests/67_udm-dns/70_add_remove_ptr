#!/usr/share/ucs-test/runner python
## desc: Create, check and remove PTR record
## tags: [udm-dns,apptest]
## roles: [domaincontroller_master]
## exposure: careful
## packages:
##   - univention-config
##   - univention-directory-manager-tools



import univention.testing.utils as utils
import univention.testing.udm as udm_test
import univention.testing.strings as uts


if __name__ == '__main__':
	with udm_test.UCSTestUDM() as udm:
		reverseZoneName = '10.20.30'
		reverseZone = udm.create_object('dns/reverse_zone', subnet = reverseZoneName, nameserver = uts.random_string())
		
		reverseZoneName = reverseZoneName.split('.')
		reverseZoneName.reverse()
		reverseZoneName = '.'.join(reverseZoneName) + '.in-addr.arpa'
		ptrRecordProperties = {
			'address': '10.20.30.40',
			'ptr_record': '%s.%s.%s.' % (uts.random_name(), uts.random_name(), uts.random_name())
		}

		ptrRecord = udm.create_object('dns/ptr_record', superordinate = reverseZone, **ptrRecordProperties)
		if not utils.verify_ldap_object(ptrRecord, {
			'relativeDomainName': [ptrRecordProperties['address']],
			'zoneName': [reverseZoneName],
			'pTRRecord': [ptrRecordProperties['ptr_record']]
		}):
			utils.fail()

		udm.remove_object('dns/ptr_record', dn = ptrRecord, superordinate = reverseZone)
		if utils.verify_ldap_object(ptrRecord):
			utils.fail('Could still find PTR record "%s" in LDAP after it should have been removed' % ptrRecord)
