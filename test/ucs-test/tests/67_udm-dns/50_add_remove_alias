#!/usr/share/ucs-test/runner python
## desc: Create, check and remove DNS alias
## tags: [udm-dns,apptest]
## roles: [domaincontroller_master]
## exposure: careful
## packages:
##   - univention-config
##   - univention-directory-manager-tools



import univention.testing.utils as utils
import univention.testing.udm as udm_test
import univention.testing.strings as uts



if __name__ == '__main__':
	dnsAliasProperties = {
		'name': uts.random_name(),
		'cname': uts.random_name(),
		'zonettl': '128'
	}

	ldapMapping = {
		'name': 'relativeDomainName',
		'cname': 'cNAMERecord',
		'zonettl': 'dNSTTL'
	}

	with udm_test.UCSTestUDM() as udm:
		forwardZone = udm.create_object('dns/forward_zone', zone = '%s.%s' % (uts.random_name(), uts.random_name()), nameserver = uts.random_string())
		dnsAlias = udm.create_object('dns/alias', superordinate = forwardZone, **dnsAliasProperties)
		
		if not utils.verify_ldap_object(dnsAlias, {
			'relativeDomainName': [dnsAliasProperties['name']],
			'cNAMERecord': [dnsAliasProperties['cname']],
			'dNSTTL': [dnsAliasProperties['zonettl']]
		}):
			utils.fail()

		udm.remove_object('dns/alias', dn = dnsAlias, superordinate = forwardZone)
		if utils.verify_ldap_object(dnsAlias):
			utils.fail('Could still find DNS alias "%s" in LDAP after it should have been removed' % dnsAlias)
