#!/usr/share/ucs-test/runner python
## desc: Check UDM users/user --set userexpiry
## roles: [domaincontroller_master, domaincontroller_backup, domaincontroller_slave]
## exposure: dangerous
## packages: [python-univention-directory-manager]
## bugs: [36330]

from univention.uldap import getMachineConnection
import univention.testing.strings as uts
import univention.testing.udm as udm_test
import univention.testing.utils as utils

def ldap_search(filter_, expectation):
	lo = getMachineConnection()
	result = lo.search(filter=filter_)
	if not result:
		utils.fail("No Objects found with filter: %s" % (filter_,))
	elif len(result) != 1:
		utils.fail("Too many objects (%d) found for filter '%s'" % (len(result), filter_))
	x = result[0]
	for attribute, value in expectation.items():
		if value == None:
			if attribute in x[1]:
				utils.fail("Attribute '%s' found with value '%s', expected to be unset" % (attribute, x[1][attribute]))
		else:
			if not attribute in x[1]:
				utils.fail("Attribute '%s' not found. Expected value: '%s'" % (attribute, value))
			elif value == []:
				return
			elif x[1][attribute] != value:
				utils.fail("Attribute '%s' found with value '%s'. Expected value: '%s'" % (attribute, x[1][attribute], value))

def run():
	with udm_test.UCSTestUDM() as udm:
		passwd =  uts.random_string()
		username =  uts.random_name()
		userdn, username = udm.create_user(password=passwd, disabled="none")
		ldap_search('uid=%s' % username, {
			'sambaAcctFlags': ['[U          ]'],
			'krb5KDCFlags': ['126'],
			'sambaKickoffTime': None,
			'krb5ValidEnd': None,
			'shadowExpire': None,
			})
		udm.modify_object('users/user', dn=userdn, userexpiry="02.02.15")
		ldap_search('uid=%s' % username, {
			'sambaAcctFlags': ['[U          ]'],
			'krb5KDCFlags': ['126'],
			'sambaKickoffTime': ['1422831600'],
			'krb5ValidEnd': ['20150202000000Z'],
			'shadowExpire': ['16468'],
			})
		udm.modify_object('users/user', dn=userdn, userexpiry="2014-01-01")
		ldap_search('uid=%s' % username, {
			'sambaAcctFlags': ['[U          ]'],
			'krb5KDCFlags': ['126'],
			'sambaKickoffTime': ['1388530800'],
			'krb5ValidEnd': ['20140101000000Z'],
			'shadowExpire': ['16071'],
			})
		udm.modify_object('users/user', dn=userdn, disabled="all")
		ldap_search('uid=%s' % username, {
			'sambaAcctFlags': ['[UD         ]'],
			'krb5KDCFlags': ['254'],
			'sambaKickoffTime': ['1388530800'],
			'krb5ValidEnd': ['20140101000000Z'],
			'shadowExpire': ['1'],
			})
		udm.modify_object('users/user', dn=userdn, userexpiry="2015-02-02")
		ldap_search('uid=%s' % username, {
			'sambaAcctFlags': ['[UD         ]'],
			'krb5KDCFlags': ['254'],
			'sambaKickoffTime': ['1422831600'],
			'krb5ValidEnd': ['20150202000000Z'],
			'shadowExpire': ['16468'],
			})
		udm.modify_object('users/user', dn=userdn, userexpiry="01.01.14", disabled="all")
		ldap_search('uid=%s' % username, {
			'sambaAcctFlags': ['[UD         ]'],
			'krb5KDCFlags': ['254'],
			'sambaKickoffTime': ['1388530800'],
			'krb5ValidEnd': ['20140101000000Z'],
			'shadowExpire': ['16071'],
			})
		udm.modify_object('users/user', dn=userdn, userexpiry="02.02.15", disabled="none")
		ldap_search('uid=%s' % username, {
			'sambaAcctFlags': ['[U          ]'],
			'krb5KDCFlags': ['126'],
			'sambaKickoffTime': ['1422831600'],
			'krb5ValidEnd': ['20150202000000Z'],
			'shadowExpire': ['16468'],
			})
		try:
			udm.modify_object('users/user', dn=userdn, disabled="none")
		except udm_test.UCSTestUDM_NoModification:
			pass
		ldap_search('uid=%s' % username, {
			'sambaAcctFlags': ['[U          ]'],
			'krb5KDCFlags': ['126'],
			'sambaKickoffTime': ['1422831600'],
			'krb5ValidEnd': ['20150202000000Z'],
			'shadowExpire': ['16468'],
			})
		try:
			udm.modify_object('users/user', dn=userdn, userexpiry="")
		except udm_test.UCSTestUDM_NoModification:
			pass
		ldap_search('uid=%s' % username, {
			'sambaAcctFlags': ['[U          ]'],
			'krb5KDCFlags': ['126'],
			'sambaKickoffTime': ['1422831600'],
			'krb5ValidEnd': ['20150202000000Z'],
			'shadowExpire': ['16468'],
			})

if __name__ == '__main__':
	run()
