#!/usr/share/ucs-test/runner python
## desc: Check PPD files
## tags: [udm]
## roles:
##   - domaincontroller_master
##   - domaincontroller_slave
##   - domaincontroller_backup
##   - memberserver
##   - managedclient
## exposure: safe
## packages:
##   - univention-config
##   - univention-directory-manager-tools
##   - univention-printserver

import os
import pprint
import univention.testing.utils as utils

if __name__ == '__main__':
	ldap_printer = []
	printer_files = []

	print 'searching for printer models'
	for dn, attr in utils.get_ldap_connection().search(filter='(objectClass=univentionPrinterModels)', attr=['printerModel']):
		for printerModel in attr.get('printerModel', ()):
			print 'found', printerModel
			try:
				model = printerModel.split()[0].split('/')[-1].strip('"')
				if model.endswith('.ppd') or model.endswith('.ppd.gz'):
					ldap_printer.append(model)
			except IndexError:
				pass

	print 'ldap printers'
	pprint.pprint(ldap_printer)

	for root, dirs, files in os.walk('/usr/share/ppd/'):
		for file in files:
			if file.endswith('.ppd') or file.endswith('ppd.gz'):
				printer_files.append(file)

	print 'printer files'
	pprint.pprint(printer_files)

	missing_files = set(ldap_printer) - set(printer_files)
	missing_printers = set(printer_files) - set(ldap_printer)

	message = None
	if missing_files:
		message = 'No PPD file found for LDAP printers: %s' % '\n'.join(missing_files)

	if missing_printers:
		message += '\n\n' + 'No LDAP printer found for PPD files: %s' % '\n'.join(missing_printers)

	if message:
		utils.fail(message)
