#!/usr/share/ucs-test/runner python
## desc: Checking PPD files
## tags: [udm-printers]
## roles:
##   - domaincontroller_master
##   - domaincontroller_slave
##   - domaincontroller_backup
##   - memberserver
##   - managedclient
## exposure: safe
## packages:
##   - univention-config
##   - univention-directory-manager-tools
##   - univention-printserver


import sys
import os
import univention.uldap as uldap

if __name__ == '__main__':
	ldap = uldap.getMachineConnection(ldap_master = False)

	ldapPrinterModels = []
	for dn, attr in ldap.search(filter = '(objectClass=univentionPrinterModels)', attr = ['printerModel']):
		for printerModel in attr.get('printerModel', ()):
			try:
				model = printerModel.split()[0].split('/')[-1].strip('"')
				if model.endswith('.ppd') or model.endswith('.ppd.gz'):
					ldapPrinterModels.append(model)
			except IndexError:
				pass

	printerFiles = []
	for root, dirs, files in os.walk('/usr/share/ppd/'):
		for file in files:
			if file.endswith('.ppd') or file.endswith('ppd.gz'):
				printerFiles.append(file)



	printerModelsLackingFile = []
	filesLackingPrinterModel = []
	
	for printerModel in ldapPrinterModels:
		if not printerModel in printerFiles:
			printerModelsLackingFile.append(printerModel)
	
	for printerFile in printerFiles:
		if not printerFile in ldapPrinterModels:
			filesLackingPrinterModel.append(printerFile)


	
	if printerModelsLackingFile or filesLackingPrinterModel:
		print 'Test FAILED.'
		if printerModelsLackingFile:
			print 'No PPD file found for the following printer models:'
			for printerModel in printerModelsLackingFile:
				print '    %s' % printerModel
		if filesLackingPrinterModel:
			print 'No printer model found in LDAP for the following PPD files:'
			for file in filesLackingPrinterModel:
				print '    %s' % file
		sys.exit(1)
