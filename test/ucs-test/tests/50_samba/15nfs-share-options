#!/usr/share/ucs-test/runner bash
## desc: "Checking all udm nfs options in exports file"
## exposure: safe
## packages:
##  - univention-config
##  - univention-directory-manager-tools
##  - univention-samba
## roles-not: [basesystem]
## tags: [basic]
## join: true

. "$TESTLIBPATH/base.sh" || exit 137
. "$TESTLIBPATH/shares.sh" || exit 137
. "$TESTLIBPATH/random.sh" || exit 137

eval "$(/usr/sbin/univention-config-registry shell)"

## some globals
sharename="$(random_share)"
SHARE_POSITION="cn=shares,$ldap_base"
fqdn="$(host "$hostname" | awk {'print $1'})"
echo "hostname: $hostname"
echo "fqdn: $fqdn"
etc="/etc/exports"
available_options="$(/usr/sbin/univention-directory-manager shares/share create | grep  --regex "(nfs)" | awk  {'print $1'})"

## here we have the udm_option/nfs_value/udm_value
options="
writeable/rw/1
sync/async/async
subtree_checking/subtree_check/1
root_squash/root_squash/1
"

## delete share even on abnormal exits
#trap 'share_remove "$sharename";rm -rf "/opt/${sharename:?}"' INT TERM EXIT
if [ "$server_role" = "memberserver" ]; then
	trap '/usr/sbin/univention-directory-manager shares/share remove --dn "$SHARE_DN" --binddn "$ADMINISTRATOR_DN" --bindpwd "$ADMINISTRATOR_PASSWORD";
rm -rf "/opt/${sharename:?}"' INT TERM EXIT
else
	trap 'share_remove "$sharename";rm -rf "/opt/${sharename:?}";' INT TERM EXIT
fi

ADMINISTRATOR_DN="$(/usr/sbin/univention-directory-manager users/user list --filter uid="$ADMINISTRATOR_USER" | sed -ne 's/^DN: //p')"

## create share
echo "----create share"
if [ "$server_role" = "memberserver" ]; then
	/usr/sbin/univention-directory-manager shares/share create \
		--position="$SHARE_POSITION" \
		--option nfs \
		--set name="$sharename" \
		--set path="/opt/$sharename" \
		--set host="$fqdn" \
		--binddn "$ADMINISTRATOR_DN" --bindpwd "$ADMINISTRATOR_PASSWORD"
else
	/usr/sbin/univention-directory-manager shares/share create \
		--position="$SHARE_POSITION" \
		--option nfs \
		--set name="$sharename" \
		--set path="/opt/$sharename" \
		--set host="$fqdn"
fi

if [ "$?" != 0 ]; then
	fail_fast 1 "could not create share"
fi

SHARE_DN="$(/usr/sbin/univention-directory-manager shares/share list --filter name="$sharename" | sed -ne 's/^DN: //p')"
echo "$SHARE_DN"

## wait for nfs conf file
echo "----wait for the changes to be written in the nfs configuration file"
sleep 10

echo "----check whether the nfs configuration file exists"
if [ ! -f "$etc" ]; then
	fail_fast 1 "nfs config file $etc not found"
fi

## set samba options via udm and check samba config file
echo "----set options"
while read option_line; do

	echo "$option_line" | grep --regex "^\s*#" > /dev/null
	if [ 0 -eq "$?" ]; then continue; fi

	echo "$option_line" | grep --regex "^\s*$" > /dev/null
	if [ 0 -eq "$?" ]; then continue; fi

	udm_option="$(echo "$option_line" | awk -F / {'print $1'})"
	nfs_value="$(echo "$option_line" | awk -F / {'print $2'})"
	udm_value="$(echo "$option_line" | awk -F / {'print $3'})"

	# modify share
	echo "Debug: Options: $option_line"
	echo "Debug: udm call: /usr/sbin/univention-directory-manager shares/share modify --dn=\"cn=$sharename,cn=shares,$ldap_base\" --set \"$udm_option=$udm_value\""
	if [ "$server_role" = "memberserver" ]; then
		/usr/sbin/univention-directory-manager shares/share modify \
			--dn="cn=$sharename,cn=shares,$ldap_base" \
			--set "$udm_option=$udm_value" \
			--binddn "$ADMINISTRATOR_DN" \
			--bindpwd "$ADMINISTRATOR_PASSWORD"
	else
		/usr/sbin/univention-directory-manager shares/share modify --dn="cn=$sharename,cn=shares,$ldap_base" --set "$udm_option=$udm_value"
	fi
	if [ "$?" != 0 ]; then
		fail_fast 1 "could not set $udm_option to $udm_value"
	fi

	# save search string and the rest in $nfs_search, we can not perform the search here, because
	# udm needs some time to create the nfs conf file
	if [ -z "$search" ]; then
		search="${udm_option}:DELIMETER:${nfs_value}:DELIMETER:${udm_value}"
	else
		search="$search 
${udm_option}:DELIMETER:${nfs_value}:DELIMETER:${udm_value}"
	fi

	# clear this options, later we want to check wether we have alle options tested or not
	available_options="$(echo "$available_options" | sed "s/$udm_option//")"

done <<<"$options"

## wait a moment to let udm prepare the samba conf file
sleep 3

## check the nfs conf file
echo "----test the nfs configuration file"
conf_line="$(cat "$etc")"
while read search_line; do
	udm="$(echo "$search_line" | awk -F :DELIMETER: {'print $1'})"
	nfs="$(echo "$search_line" | awk -F :DELIMETER: {'print $2'})"
	value="$(echo "$search_line" | awk -F :DELIMETER: {'print $3'})"

	echo "$conf_line" | grep --regex '^"/opt/'"$sharename" | grep -q --regex '[ (,"]/*'"$nfs"'[ ),"]'
	if [ $? != 0 ]; then
		fail_fast 1 "nfs config file <-> udm settings mismatch udm option: $udm nfs options: $nfs udm value: $value"
	fi
done <<<"$search"

## test if we checked all udm samba options
echo "----check whether all options have been tested"
available_options="$(echo "$available_options" | sed 's/^ *//')"
available_options="$(echo "$available_options" | sed 's/ *$//')"
if [ -n "$available_options" ]; then
	fail_fast 122 "udm option \"$available_options\" is not covered by this test"
fi

exit 0
