#!/usr/share/ucs-test/runner bash
## desc: "Winbind Test"
## exposure: safe
## packages:
##  - winbind
## roles-not:
## - basesystem
## - memberserver
## tags: [basic]

. "$TESTLIBPATH/base.sh" || exit 137
. "$TESTLIBPATH/user.sh" || exit 137

SAMBA="true"
MAIL="false"
KERBEROS="false"
PERSON="false"
POSIX="true"

password="univention"
username="$(user_randomname)"
trap 'user_remove "$username"' INT TERM EXIT

##create User
echo "----create User"
if ! user_create "$username"; then
	fail_fast 1 "Failed to create user";
fi

wait_for_replication

if [ "$(/usr/sbin/univention-config-registry get server/role)" = "memberserver" ]; then
	NAME="$(/usr/sbin/univention-config-registry get windows/domain)+$username"
fi

##wbinfo tests
echo "----wbinfo -t"
if ! wbinfo -t; then
	fail_fast 1 "Checking shared secret failed"
fi

echo "----wbinfo --ping"
if ! wbinfo --ping; then
	fail_fast 1 "failed to ping the winbind-daemon";
fi

echo "----wbinfo --ping-dc"
if ! wbinfo --ping-dc; then
	fail_fast 1 "No connection to NETLOGON"
fi

echo "----wbinfo --krb5auth"
if ! wbinfo --krb5auth="$username"%"$password"; then
	fail_fast 1 "failed to authenticate testuser"
fi

echo "----wbinfo -a"
if ! wbinfo -a "$(wbinfo -s "$(wbinfo -U "$(wbinfo -S "$(wbinfo -n "$username" | cut -d' '  -f1)" | cut -d' ' -f1)"  | cut -d' ' -f1)" | cut -d' '  -f1)%$password"; then
	fail_fast 1 "User authentification failed"
fi

echo "----wbinfo -D"
for i in $(wbinfo --trusted-domains);
do
	if ! output="$(wbinfo -D "$i")"; then
		print "$output"
		fail_fast 1 "Failed to look up domaininfo"
	fi
done

echo "----wbinfo -Y"
for groupsid in $(wbinfo --user-domgroups="$(wbinfo -n "$username" | cut -d' ' -f1)");
do
	wbinfo -Y $(wbinfo -n "$(wbinfo -s "$(wbinfo -G "$(wbinfo -Y $groupsid)" )" | sed 's/ [0-9]*$//')" | cut -d' '  -f1 )
	if [ "$?" != 0 ]; then
		fail_fast 1 "Group lookup failed";
	fi
done

exit 0
