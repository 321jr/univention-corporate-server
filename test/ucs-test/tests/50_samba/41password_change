#!/usr/share/ucs-test/runner bash
## desc: "Testing password change with udm and samba"
## exposure: safe
## packages:
##  - univention-samba
## roles:                                                                                                                                                                                    
## - domaincontroller_master                                                                                                                                                                 
## - domaincontroller_backup                                                                                                                                                        
## - domaincontroller_slave 

. "$TESTLIBPATH/base.sh" || exit 137
. "$TESTLIBPATH/user.sh" || exit 137
. "$TESTLIBPATH/random.sh" || exit 137

echo "----create user"
##create user
SAMBA="true"
MAIL="false"
KERBEROS="true"
PERSON="false"
POSIX="true"

username="$(user_randomname)"
first_password="univention"
second_password="$(random_chars 8 ${_upperletters}${_lowerletters}${_ciphers}äöü)1AÄÜÖ"
third_password="$(random_chars 8 ${_upperletters}${_lowerletters}${_ciphers}äöü)1AÄÜÖ"

trap 'user_remove "$username"' INT TERM EXIT

if ! user_create "$username"; then
	fail_fast 1 "User could not be created"
fi


##wait for the user to be created
echo "----wait for the user to be created"
i=0
while ! output="$(net rpc user info $username -U"$username%$password" 2>&1)"
do
	let i="$i"+1
	if [ "$i" = 20 ]; then
		echo "$output"
		echo "TIMEOUT: The User which has been created in UDM could not be found in samba ldb"
	fi
	sleep 1
done

ADMINISTRATOR_DN="$(/usr/sbin/univention-directory-manager users/user list --filter uid="$ADMINISTRATOR_USER" | sed -ne 's/^DN: //p')"
USER_DN="$(/usr/sbin/univention-directory-manager users/user list --filter uid="$username" | sed -ne 's/^DN: //p')"

##test normal connection with smbclient
echo "----test normal connection with smbclient"
output="$(smbclient -U "$username%$first_password" "//$hostname.$domainname/netlogon" -c "exit")"
if [ "$?" != 0 ];then
	echo "$output"
	fail_test 1 "Could not connect to netlogon with smbclient."
else
	echo "OK"
fi

##changing the password with net rpc / samba
echo "----changing the password with net rpc"
output="$(python net_rpc_change_pwd.py -u "$username" -a "$ADMINISTRATOR_USER" -n "$second_password" -r "$ADMINISTRATOR_PASSWORD")"
if [ "$?" != 0 ];then
	echo "$output"
	fail_test 1 "Failed to change the password"
fi

##test login with udm with new password
echo "----test login with udm with new password"
i=0
while ! output="$(univention-directory-manager users/user list --filter uid="$username" --binddn "$USER_DN" --bindpwd "$second_password")"
do
	let i="$i"+1
	if [ "$i" = 20 ]; then
		echo "$output"
		fail_test 1 "Could not authentificate with UDM after password change with smbpasswd."
	fi
	sleep 1
done

##change the password with udm
echo "----change the password with udm"
output="$(/usr/sbin/univention-directory-manager users/user modify --binddn "$ADMINISTRATOR_DN" --bindpwd "$ADMINISTRATOR_PASSWORD" --dn "$USER_DN" --set "password=$third_password")"
if [ "$?" != 0 ];then
	echo "$output"
	fail_test 1 "Could not change password with UDM"
fi

##test login with smbclient with new password
echo "----test login with smbclient with new password"
output="$(smbclient -U "$username%$third_password" "//$hostname.$domainname/netlogon" -c "exit")"
if [ "$?" != 0 ];then
	echo "$output"
	fail_test 1 "Could not authentificate login with smbclient after password change with UDM"
fi

exit $RETVAL