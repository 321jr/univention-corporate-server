#!/usr/share/ucs-test/runner bash
## desc: "Is sambaLMPassword still present after a change of the Password"
## exposure: safe
## packages:
##  - univention-config
##  - univention-directory-manager-tools
##  - univention-samba
## roles-not: [basesystem]
## tags: [basic]
## join: true

. "$TESTLIBPATH/base.sh" || exit 137
. "$TESTLIBPATH/user.sh" || exit 137

SAMBA="true"
MAIL="false"
KERBEROS="false"
PERSON="false"
POSIX="true"

username=`user_randomname`

#remove name, even on abnormal exit
trap "user_remove $username" INT TERM EXIT

user_create $username
ADMINISTRATOR_DN="$(univention-directory-manager users/user list --filter uid="Administrator" | sed -ne 's/^DN: //p')"
oldsmbpw=`ldapsearch -x -D "$ADMINISTRATOR_DN" -w "$ADMINISTRATOR_PASSWORD" -LLL uid=$username | grep sambaLMPassword:`
#exit the script, if there was no attribut before
if [ -z "$oldsmbpw" ] 
then
	echo "Did not found sambaLMPassword for user $username"
	exit 140
fi
#change password

cat <<%EOF > /tmp/setsambapassword
#!/usr/bin/expect --
log_user 0
if {[ llength \$argv ] != 2 } {
puts "Usage: \$argv0 <username> <password>"
} else {
spawn su Administrator -c "net rpc password \$argv"
expect "Enter $ADMINISTRATOR_USER's password:" { send "$ADMINISTRATOR_PASSWORD\n" }
interact
}
%EOF

chmod +x /tmp/setsambapassword

echo "Call expext script: /tmp/setsambapassword"

/tmp/setsambapassword $username testtest5

rm /tmp/setsambapassword

newsmbpw=`ldapsearch -x -D "$ADMINISTRATOR_DN" -w "$ADMINISTRATOR_PASSWORD" -LLL uid=$username | grep sambaLMPassword:`

if [ -z "$newsmbpw" ]
then
	fail_test 1 "The Password isn't present anymore. The test failed (Bug: #14297)";
else
	echo "***The Password is still present. Everything is fine."
fi	

exit $RETVAL
