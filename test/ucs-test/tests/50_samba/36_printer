#!/usr/share/ucs-test/runner bash
## desc: "Creating a shared printer and printing from smbclient"
## exposure: safe
## packages:
##  - univention-samba
##  - univention-printserver
## roles:
## - domaincontroller_master
## - domaincontroller_backup

. "$TESTLIBPATH/base.sh" || exit 137
. "$TESTLIBPATH/user.sh" || exit 137
. "$TESTLIBPATH/random.sh" || exit 137

#create user
echo "----Create user"
SAMBA="true"
MAIL="false"
KERBEROS="true"
PERSON="false"
POSIX="true"

username="$(user_randomname)"
printername="test36printer"
password="univention"

trap '
user_remove "$username";
rm -rf "/tmp/$printername"/ /tmp/print_input;
udm-test shares/printer remove --dn="$PRINTER_DN"
' INT TERM EXIT

if ! user_create "$username"; then
	fail_fast 1 "User could not be created"
fi

##create printer
udm-test shares/printer create \
	--set "name=$printername" \
	--set "spoolHost=$hostname.$domainname" \
	--set "uri=file:/ tmp/$printername" \
	--set "model=None"
if [ "$?" != 0 ];then
	fail_fast 1 "failed to create printer"
fi

wait_for_replication_and_postrun

udm-test shares/printer list --filter cn="$printername" | sed -ne 's/^DN: //p' | grep "$printername"
if [ "$?" != 0 ];then
	fail_fast 1 "failed to modify printer"
fi

##get the printer DN
echo "----get the printer DN"
i=0
while ! PRINTER_DN="$(univention-ldapsearch cn=test36printer | sed -ne 's/^dn: //p')"
do
	let i="$i"+1
	sleep 1
	if [ $i = 100 ]; then
		echo "Could not get printer DN"
		break
	fi
done


## look for printer
echo "----Looking for samba printer share '$printername'"
i=0
while ! output="$(smbclient -NL localhost | grep -qE "^\s+$printername\s+Printer" 2>&1)"
do
	echo '.'
	let i="$i"+1
	if [ "$i" = 20 ]; then
		print "output"
		fail_fast 1 "Samba did not provide the printer share 20 seconds after creation"
	fi
	sleep 1
done

##create input file
echo "----Creating input file"

echo "$(uname -a)" > "/tmp/print_input"

## initiate print
echo "----initiate print"
i=0
while ! output="$(smbclient -U"$username%$password" "//$hostname.$domainname/$printername" -c "print /tmp/print_input" 2>&1)"
do
	let i=$i+1
	if [ "$i" = 20 ]; then
		echo "$output"
		fail_fast 1 "Initiate printing has not been successful."
	fi
	sleep 1
done

## check output
echo "----check output"
i=0
while ! output="$(grep "$(uname -a)" "/tmp/$printername")"
do
	let i="$i"+1
	if [ "$i" = 10 ]; then
		echo "$output"
		fail_fast 1 "Nothing has been printed to the output file."
	fi
	sleep 1
done

exit $RETVAL
