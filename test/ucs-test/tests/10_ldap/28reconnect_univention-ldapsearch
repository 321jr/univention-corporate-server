#!/usr/share/ucs-test/runner bash
## desc: Test reconnect mechanism of univention-ldapsearch
## tags:
##  - apptest
## roles-not:
##  - basesystem
##  - memberserver
## packages:
##  - univention-config
## bugs: [34293, 37299]
## exposure: dangerous

. "$TESTLIBPATH/base.sh" || exit 137
. "$TESTLIBPATH/undo.sh" || exit 137
. "$TESTLIBPATH/ucr.sh" || exit 137

undo ucr_restore

stop_and_start_slapd_with_delay()
{
	delay=$1
        debug "Force-stopping and starting slapd with $delay seconds delay\n"
	/etc/init.d/slapd force-stop
	{ sleep $delay; /etc/init.d/slapd start;} &
}

do_search ()
{
	sleep 2
        debug "Performing univention-ldapsearch\n"
        univention-ldapsearch -s base dn -LLL | grep ^dn
}

wait_for_slapd()
{
	debug "Waiting for slapd\n"
        sleep 4
}

stop_and_start_slapd_with_delay 5
do_search || fail_test 1 "First default check with a delay of 5 seconds failed"
wait_for_slapd

ucr set ldap/client/retry/count=1
stop_and_start_slapd_with_delay 4
do_search && fail_test 1 "Search was successful: ldap/client/retry/count=1 and slapd restart delay is 4"
wait_for_slapd

ucr set ldap/client/retry/count=11
stop_and_start_slapd_with_delay 7
do_search || fail_test 1 "Search was not successful: ldap/client/retry/count=11 and slapd restart delay is 7"
wait_for_slapd

ucr set ldap/client/retry/count=0
# no server restart here
do_search || fail_test 1 "Search was not successful: ldap/client/retry/count=0 and slapd was not restarted"

ucr set ldap/client/retry/count=0
stop_and_start_slapd_with_delay 4
do_search && fail_test 1 "Search was successful: ldap/client/retry/count=0 and slapd restart delay is 4"
wait_for_slapd

exit $RETVAL
