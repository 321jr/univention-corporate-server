#!/usr/share/ucs-test/runner python2.6
## desc: Check for filesystem permissions on slave-join.secret
## tags: [basic]
## roles:
##  - domaincontroller_master
## packages:
##  - univention-ldap-server
## exposure: safe

import sys
import os
import grp
import pwd

def main():
    """A main method stores almost completely code."""
    filename = "/etc/slave-join.secret" # filepath to check
    shouldpermission = "33184" # should be Inode protection mode (represents unix-format: -rw-r-----)
    shouldowner = "root" 
    shouldgroup = "Slave Join"
    return_code = 100 

    try:
	stat_info = os.stat(filename) # statistics about a given file
    	uid = stat_info.st_uid # userid
    	gid = stat_info.st_gid # groupid
    	user = pwd.getpwuid(uid)[0] # get username/owner
    	group = grp.getgrgid(gid)[0] # get groupname
    	permission = int(stat_info.st_mode) # permission as Inode protection mode fromat (not unix notation)

	# permission checking
	if int(shouldpermission) != permission:
      	   print >> sys.stderr, filename, "has the wrong permission", permission, symbolic_notation(permission), "instead of", shouldpermission, symbolic_notation(int(shouldpermission))
	   return_code = 110    

    	# owner checking
	if shouldowner != user:
	   print >> sys.stderr, filename, "has the wrong owner", user, "instead of", shouldowner, "." 
	   return_code = 110

	# group checking
	if shouldgroup != group:
	   print >> sys.stderr, filename, "has the wrong group", group, "instead of", shouldgroup, "." 
	   return_code = 110

    except OSError, error:
        print >> sys.stderr, "An error occured with: %s" % (error, )
	sys.exit(110) # Exit with returncode 1. Exit in case anything goes wrong on OS-level.
    sys.exit(return_code) # Exit with returncode. End of program in case no OS-error occured.

def symbolic_notation(mode):
    """ A method to display a symbolic unix notation. 0400 Allow read by owner."""
    slash = "-"
    unixmode = ''.join(mode & 0400 >> i and x or '-' for i, x in enumerate('rwxrwxrwx'))
    return slash + unixmode
   

if __name__ == '__main__':
   main()