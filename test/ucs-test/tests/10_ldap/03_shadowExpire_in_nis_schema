#!/usr/share/ucs-test/runner python
## desc: Allow comparison of shadowExpire in nis.schema
## roles: [domaincontroller_master, domaincontroller_backup, domaincontroller_slave]
## exposure: dangerous
## packages: [univention-ldap-server]
## bugs: [35329, 35088]

from univention.uldap import getMachineConnection
import re
import time
import univention.testing.strings as uts
import univention.testing.udm as udm_test
import univention.testing.utils as utils

def nis_schema_conatains_ordering_for_shadowExpire():
	NIS_FILE = '/etc/ldap/schema/nis.schema'
	pattern = re.compile(r'\(.*shadowExpire[^\(]+ORDERING integerOrderingMatch[^\)]+\)')
	with open(NIS_FILE) as fi:
		search_obj = re.search(pattern, fi.read())
		return search_obj

def ldap_search(filter_):
	lo = getMachineConnection()
	found = lo.search(filter=filter_)
	if found:
		return [(x[1]['uid'][0], x[1]['shadowExpire'][0]) for x in found]

def run():
	with udm_test.UCSTestUDM() as udm:
		def create_users():
			local = list(time.localtime(time.time() + date_diff *60*60*24))
			expiry_date = time.strftime('%Y-%m-%d', local)
			passwd =  uts.random_string()
			userdn, username = udm.create_user(password=passwd, userexpiry=expiry_date)

			current_epoch = int(time.time()/60/60/24)
			date = current_epoch + date_diff
			return username, passwd, date

		test_list = []
		for date_diff in [-2, 0, 2]: # Numbers represent days, - in the past, + in the future, 0 = today
			test_list.append(create_users())

		for username, passwd, date in test_list:
			print 'Searching LDAP:\nusername=%s, expirydate=%s' % (username, date)
			ldap_found = ldap_search('(&(objectClass=posixAccount)(shadowExpire>=%r)(shadowExpire<=%r))' %
					(date - 1, date + 1))
			exclude_list = [(x[0], x[2]) for x in test_list]
			exclude_list.remove((username, date))
			if ldap_found:
				if ((username, str(date)) not in ldap_found or set(exclude_list).issubset(ldap_found)):
					utils.fail("LDAP is not able to sort Objects with filter: (shadowExpire>=%r)(shadowExpire<=%r))" % 
							(date -  int(time.time()/60/60/24), date + int(time.time()/60/60/24)))

def main():
	if not nis_schema_conatains_ordering_for_shadowExpire():
		utils.fail("nis.schema does not contain ordering for shadowExpire")
	run()


if __name__ == '__main__':
	main()
