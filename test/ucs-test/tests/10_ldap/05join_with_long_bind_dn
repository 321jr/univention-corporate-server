#!/usr/share/ucs-test/runner bash
## desc: Join to a master when the dn of the bind-user is very long (provoking a linebreak #16210)##
## roles:
##  - domaincontroller_backup
##  - domaincontroller_slave
##  - memberserver
## packages:
##  - univention-join
## exposure: dangerous


. "$TESTLIBPATH/base.sh" || exit 1
. "$TESTLIBPATH/random.sh" || exit 1
. "$TESTLIBPATH/joincheck.sh" || exit 1

if check_join_status; then
	error "Expected system not to be joined"
	exit 135
fi

eval "$(ucr shell)"

DCNAME=
LDAP_BASE=
BINDUSERNAME="$(random_chars)"
BINDPASSWORD="$(random_chars)"
DNPART="$(random_chars)"

#This code snippet is taken (almost) 1:1 from univention-join and sets the variable DCNAME
echo -n "Search DC Master: "
#echo "$interfaces_eth0_address"
#echo "$nameserver1"

if [ "$interfaces_eth0_type" = "dhcp" ]; then
	DCNAME=`host -t SRV _domaincontroller_master._tcp.$domainname | grep -v "not found" | grep -v "reached" | tail -1 | sed -e 's|.* ||g' | sed -e 's|\.$||'`
	if [ -n "$DCNAME" ]; then
		echo -e "\033[60Gdone"
	fi
else
	for i in "$nameserver" "$nameserver1" "$nameserver2" "$nameserver3" "$dns_forwarder1" "$dns_forwarder2" "$dns_forwarder3"; do
		if [ -z "$i" ]; then continue; fi
		DCNAME=`host -t SRV _domaincontroller_master._tcp.$domainname $i | grep -v "not found" | grep -v "reached" | tail -1 | sed -e 's|.* ||g' | sed -e 's|\.$||'`
		if [ -n "$DCNAME" ]; then
			echo -e "\033[60Gdone"
			echo "domain $domainname" >/etc/resolv.conf
			echo "nameserver $i" >>/etc/resolv.conf
			test -x /etc/init.d/nscd && /etc/init.d/nscd restart >>/var/log/univention/join.log 2>&1
			break
		fi
	done
fi

if [ -z "$DCNAME" ]; then
	error "Unable to find a suitable master to join with"
	exit 1 # This exit-code isn't defined, but there seems to
	# be no suitable exit-code for this case
fi


pwfile="$(mktemp)"
trap "rm -f '$pwfile'" EXIT

echo -n "$ADMINISTRATOR_PASSWORD" > "$pwfile"

LDAP_BASE="$(univention-ssh "$pwfile" "root@$DCNAME" \
	ucr get ldap/base)"
LDAP_BASE="$(echo "$LDAP_BASE" | grep dc)"

i=0
while [ $i -le 10 ]
do
PREF=
	j=0
	while [ $j -lt $i ]
	do
		PREF+="cn=$DNPART,"
		j=`expr $j + 1`
	done

	univention-ssh "$pwfile" "root@$DCNAME" \
		univention-directory-manager container/cn create \
		--set "name=${DNPART}" \
		--position "${PREF}cn=users,$LDAP_BASE" || fail_test 1

	i=`expr $i + 1`
done

if [ "$server_role" == "domaincontroller_backup" ]; then
	univention-ssh "$pwfile" "root@$DCNAME" \
		univention-directory-manager users/user create \
		--set "username=${BINDUSERNAME}" \
		--set "password=${BINDPASSWORD}" \
		--set "lastname=$(random_chars)" \
		--set '\"'primaryGroup=cn=Domain Admins,cn=groups,$LDAP_BASE'\"' \
		--append '\"'groups=cn=DC Backup Hosts,cn=groups,$LDAP_BASE'\"' \
		--position "${PREF}cn=users,$LDAP_BASE" || fail_test 1
else
	univention-ssh "$pwfile" "root@$DCNAME" \
		univention-directory-manager users/user create \
		--set "username=${BINDUSERNAME}" \
		--set "password=${BINDPASSWORD}" \
		--set "lastname=$(random_chars)" \
		--set '\"'primaryGroup=cn=Domain Admins,cn=groups,$LDAP_BASE'\"' \
		--position "${PREF}cn=users,$LDAP_BASE" || fail_test 1
fi

univention-ssh "${pwfile}" "root@$DCNAME" \
  'while sleep 1s ; do echo waiting for nscd update ; if getent group \"Domain Admins\" | grep -F '"${BINDUSERNAME}"' ; then break; fi; done'

BINDPWDFILE="/tmp/bindpwd"
echo -n "$BINDPASSWORD" > "$BINDPWDFILE"
/usr/sbin/univention-join -dcaccount "$BINDUSERNAME" -dcpwd "$BINDPWDFILE" || fail_test 1
rm -f "$BINDPWDFILE"

if ! check_join_status; then
	fail_test 1
fi

univention-ssh "$pwfile" "root@$DCNAME" \
	univention-directory-manager container/cn remove \
	--dn "cn=${DNPART},cn=users,$LDAP_BASE" || fail_test 1

exit "$RETVAL"
