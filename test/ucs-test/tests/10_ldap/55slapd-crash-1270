#!/usr/share/ucs-test/runner bash
## desc: Checking for slapd crash (Bug #9738)
## bugs: [9738]
## roles:
##  - domaincontroller_master
##  - domaincontroller_backup
##  - domaincontroller_slave
## packages:
##  - univention-config
##  - univention-directory-manager-tools
##  - ldap-utils
##  - univention-ldap-server
## exposure: dangerous

. "$TESTLIBPATH/base.sh" || exit 1
. "$TESTLIBPATH/user.sh" || exit 1
. "$TESTLIBPATH/group.sh" || exit 1
. "$TESTLIBPATH/printer.sh" || exit 1

eval "$(ucr shell)"

if [ -z "$(pidof slapd)" ]; then
        echo "There is actually no slapd-process"
        exit 120
fi

echo -e "\n\n***Create a test user with UDM CLI"

PRINTERNAME="$(getprintername)"
create_localprinter "$PRINTERNAME" || fail_test 1

set_printer_sambaname "$PRINTERNAME" "sambaname"

USERNAME=$(user_randomname)
user_create "$USERNAME" || fail_test 1

echo -e "\n\n***Create a test group with UDM CLI and add the specified user"

GROUPNAME="$(group_randomnameme)"
group_create "$GROUPNAME" || fail_test 1

echo "$USERNAME" "$GROUPNAME"
echo "$PRINTERNAME"

group_adduser "$USERNAME" "$GROUPNAME" || fail_test 1

echo -e "\n\n***Adding the new group to \"Domain Admins\""x

group_addgroup "$GROUPNAME" "Domain Admins" || fail_test 1

echo -e "\n\n***Displaying the created printer, using the account of the created user:"

ldapsearch -x -D "uid=$USERNAME,cn=users,$ldap_base" -w univention "cn=$PRINTERNAME"

RET=$?

section "Cleanup"

user_remove "$USERNAME" || fail_test 1

group_removegroup "$GROUPNAME" "Domain Admins" || fail_test 1

group_remove "$GROUPNAME" || fail_test 1

remove_printer "$PRINTERNAME" || fail_test 1

if [ ! "$RET" = "0" ] ; then
        if [ -z "$(pidof slapd)" ] ; then
                echo " The slapd crashed. See Bug #9738."
                /etc/init.d/slapd start
                fail_test 1
        else
                echo "Failed to search!"
                fail_test 1
        fi
else
        echo "Everthing was fine. The slapd did not crash."

fi

exit "$RETVAL"