#!/usr/share/ucs-test/runner bash
## desc: LDAP-replication to backup and slave
## tags: [basic]
## roles:
##  - domaincontroller_backup
##  - domaincontroller_slave
## packages:
##  - univention-config
##  - univention-directory-manager-tools
##  - ldap-utils
## exposure: dangerous

# Modification is done 8 times in rapid succession, then 4 times in 4 seconds, then rapidly 8 times again.
# Finally this script waits for the container to appear in the local directory and checks that the latest modification was replicated.

. "$TESTLIBPATH/base.sh" || exit 1
. "$TESTLIBPATH/random.sh" || exit 1

eval "$(ucr shell)"

set -o errexit #"script bail out when it detects an error (a non-zero exit code).
set -o pipefail
set -o nounset #If expansion is attempted on an unset variable or parameter --> prints error

container_name="$(random_chars 20 "${_lowerletters}${_upperletters}${_ciphers}")"
container_position="cn=univention,$ldap_base"
echo "Creating and modifiying object:"
udm-test container/cn create --set description=original --set name=$container_name --position "$container_position"

remove_create_container_with_description ()
{
	description=$1
	udm-test container/cn remove --dn cn=$container_name,"$container_position"
	udm-test container/cn create --set description=$description --set name=$container_name --position "$container_position"
}
for i in $(seq 1 8)
do
	remove_create_container_with_description "other$i"
done

for i in $(seq 9 12)
do
	remove_create_container_with_description "other$i"
    sleep 1s
done

for i in $(seq 13 20)
do
	remove_create_container_with_description "other$i"
done

wait_for_replication

if ! univention-ldapsearch -LLL -x -b "cn=$container_name,$container_position"
then
        echo 'ERROR: container not found!'
		fail_test 1 #Test failed
else
        echo 'OK: container was replicated.'
        if ! univention-ldapsearch -LLL -x -b "cn=$container_name,$container_position" | grep -qs '^description:'
        then
                echo 'ERROR: container has no "description"-attribute!'
				fail_test 1 #Test failed
        else
                echo 'OK: container has "description"-attribute.'
                if ! univention-ldapsearch -LLL -x -b "cn=$container_name,$container_position" | grep -qs '^description:\s*other20$'
                then
                        echo 'ERROR: value of "description"-attribute is incorrect!'
						fail_test 1 #Test failed
                else
                        echo 'OK: object was successfully replicated.'
						#Test passed
                fi
        fi
fi
echo "Removing object:"
udm-test container/cn remove --dn cn=$container_name,$container_position

exit $RETVAL
