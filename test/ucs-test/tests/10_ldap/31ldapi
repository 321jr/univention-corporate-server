#!/usr/share/ucs-test/runner bash
## desc: Try to bind to ldapi as normal user (Bug #10529)
## bugs: [10529]
## tags:
##  - basic
##  - apptest
## roles:
##  - domaincontroller_master
##  - domaincontroller_backup
##  - domaincontroller_slave
## packages:
##  - univention-config
##  - univention-directory-manager-tools
## exposure: dangerous


. "$TESTLIBPATH/base.sh" || exit 1
. "$TESTLIBPATH/random.sh" || exit 1
. "$TESTLIBPATH/user.sh" || exit 1
. "$TESTLIBPATH/maildomain.sh" || exit 1

eval "$(ucr shell)"

create_mail_domain "$domainname"
rc=$?

cleanup () {
	if [ "$rc" = "0" ]; then
		delete_mail_domain "$domainname" || fail_test 1
	fi
}

trap cleanup EXIT

USERNAME=$(user_randomname)
user_create "$USERNAME"

# wait for the replication
i=0
while sleep 1s;
do
	if [ $i -lt 120 ]; then
		echo "Waiting for replication..."
		if getent passwd "$USERNAME"; then
			break
		fi
	else
		echo "Waiting for replication longer than two minutes. Replication is probably broken. Test failed."
		user_remove "$USERNAME"
		exit 1
	fi
	i=`expr $i + 1`
done

echo -e "\n\n***Try to call ldapdelete via the ldapi interface. This shouln't work."
su - "$USERNAME" -c "ldapdelete -x -H ldapi:/// \"uid=$USERNAME,cn=users,$ldap_base\" && echo \"Error: Removed the object as user $USERNAME via ldapi socket.\" && exit 1 || exit 0"

if [ $? -ne 0 ]; then
	fail_test 1
fi

user_remove "$USERNAME"

exit "$RETVAL"
