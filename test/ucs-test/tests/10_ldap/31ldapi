#!/usr/share/ucs-test/runner bash
## desc: Try to bind to ldapi as normal user (Bug #10529)
## bugs: [10529]
## roles:
##  - domaincontroller_master
##  - domaincontroller_backup
##  - domaincontroller_slave
## packages:
##  - univention-config
##  - univention-directory-manager-tools
## exposure: dangerous


. "$TESTLIBPATH/base.sh" || exit 1
. "$TESTLIBPATH/random.sh" || exit 1
. "$TESTLIBPATH/user.sh" || exit 1

eval "$(ucr shell)"

setdomain=1
# create domain part in configured mail domains list
if ! udm mail/domain create --set name=$domainname ; then
	echo "Mail/domain object already exists or could not be created. Continue testing..."
	setdomain=0
fi

cleanup () {

	if [[ "$setdomain" -ne 0 ]]; then
		if ! udm mail/domain remove --dn "cn=$domainname,$ldap_base" ; then
			echo "Could not remove main/domain cn=$domainname,$ldap_base. Continue testing..."
		fi
	fi

}

trap cleanup EXIT

USERNAME=$(user_randomname)
user_create "$USERNAME"

# wait for the replication
i=0
while sleep 1s;
do
	if [ $i -lt 120 ]; then
		echo "Waiting for replication..."
		if getent passwd "$USERNAME"; then
			break
		fi
	else
		echo "Waiting for replication longer than two minutes. Replication is probably broken. Test failed."
		user_remove "$USERNAME"
		exit 1

	fi
	i=`expr $i + 1`
done

echo -e "\n\n***Try to call ldapdelete via the ldapi interface. This shouln't work."
su - "$USERNAME" -c "ldapdelete -x -H ldapi:/// \"uid=$USERNAME,cn=users,$ldap_base\" && echo \"Error: Removed the object as user $USERNAME via ldapi socket.\" && exit 1 || exit 0"

if [ $? -ne 0 ]; then
	fail_test 1
fi

user_remove "$USERNAME"

exit "$RETVAL"