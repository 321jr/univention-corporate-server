#!/usr/share/ucs-test/runner bash
## desc: Checking listener functionality
## tags: [basic]
## roles-not: [basesystem]
## packages:
##  - univention-directory-listener
## exposure: dangerous

. "$TESTLIBPATH/base.sh" || exit 1
. "$TESTLIBPATH/user.sh" || exit 1

DOMAIN="$(ucr get domainname)"
LDAPBASE="$(ucr get ldap/base)"

ucstest="$(random_chars)"
touch /usr/lib/univention-directory-listener/system/"$ucstest".py

tempFile="$(mktemp)"

cat <<__HERE__ >/usr/lib/univention-directory-listener/system/"$ucstest".py
import os, listener
description='set up a new handler (with an new uid entry in tmp-file) for listener'
name='ucstest'
filter='(objectClass=posixAccount)'
def handler(dn, new, old):
        if new:
                listener.setuid(0)
                f=open("$tempFile", 'a+')
                f.write('New User: %s\n' % new.get('uid')[0])
                f.close()
                listener.unsetuid()

__HERE__

/etc/init.d/univention-directory-listener restart

# create domain part in configured mail domains list
setdomain=1
if ! udm mail/domain create --set name=$DOMAIN ; then
	echo "Mail/domain object already exists or could not be created. Continue testing..."
	setdomain=0
fi

USERNAME=$(user_randomname)
user_create "$USERNAME"

echo "Waiting for replication..."
i=0
while sleep 1s;
do
	if [ $i -lt 120 ]; then
		if getent passwd "$USERNAME"; then
			break
		fi
	else
		echo "Waiting for replication longer than two minutes. Replication is probably broken."
		break
	fi
	i=`expr $i + 1`
done

grep "New User: $USERNAME" $tempFile
if [ $? = 0 ]; then
        echo "Found username ($USERNAME) in tempfile ($tempFile)"
else
        echo "Did not found username ($USERNAME) in tempfile ($tempFile)"
        fail_test 1
fi

#cleanup
rm -f /usr/lib/univention-directory-listener/system/"$ucstest".py || fail_test 1
rm -f "$tempFile" || fail_test 1

/etc/init.d/univention-directory-listener restart || fail_test 1

#removing users/user
user_remove "$USERNAME" || fail_test 1

if [[ "$setdomain" -ne 0 ]]; then
	if ! udm mail/domain remove --dn "cn=$DOMAIN,$LDAPBASE" ; then
		echo "Could not remove main/domain cn=$domainname,$ldap_base. Continue testing..."
	fi
fi

exit "$RETVAL"
