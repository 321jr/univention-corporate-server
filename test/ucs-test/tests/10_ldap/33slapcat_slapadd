#!/usr/share/ucs-test/runner bash
## desc: Testing slapcat and slapadd
## tags:
##  - basic
##  - apptest
## packages:
##  - univention-ldap-server
##  - univention-config-registry
## exposure: dangerous

. "$TESTLIBPATH/base.sh" || exit 137

ldif=`mktemp`
ldif2=`mktemp`

/etc/init.d/slapd stop

slapcat > "$ldif"

temp_dir=`mktemp -d`

mv /var/lib/univention-ldap/ldap/* "$temp_dir/"

ucr commit /var/lib/univention-ldap/ldap/DB_CONFIG

slapadd < "$ldif"

slapcat > "$ldif2"

/etc/init.d/slapd start

if ! diff "$ldif" "$ldif2"
then
        echo "There was an error testing slapcat and slapadd, trying to restore the old ldap database"
        /etc/init.d/slapd stop
        rm /var/lib/univention-ldap/ldap/*
        mv $temp_dir/* /var/lib/univention-ldap/ldap/
        /etc/init.d/slapd start
        fail_test 1
fi

rm "$ldif" "$ldif2"
rm -r "$temp_dir"

# check if slapd running
if ! pidof -s "slapd" > /dev/null; then
	echo "Slapd is not running. Test failed."
    fail_test 1
fi

exit $RETVAL
