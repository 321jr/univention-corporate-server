#!/usr/share/ucs-test/runner python
## desc: Checks if the apps are installed
## tags: [basic,apptest]
## bugs: [35652]
## roles-not: [basesystem]
## exposure: safe
## packages:
##   - univention-directory-manager-tools

import os.path
import sys

from univention.lib.package_manager import PackageManager
from univention.management.console.modules.appcenter.app_center import Application
from univention.config_registry import ConfigRegistry

import univention.testing.udm as udm_test
import univention.testing.utils as utils


if not os.path.exists('/var/cache/appcenter-installed.txt'):
	print '/var/cache/appcenter-installed.txt does not exist'
	sys.exit(137)

pm = PackageManager()
pm.update()

ucr = ConfigRegistry()
ucr.load()

def check_package(package):
	print '  package: %s' % package
	if not pm.is_installed(package):
		print 'Test failed: %s is not installed but requested' % (package)
		return False
	return True

def app_dn(app):
	ldap_base = ucr.get('ldap/base')
	return 'univentionAppID=%s_%s,cn=%s,cn=apps,cn=univention,%s' % (app.id, app.version, app.id, ldap_base)

returncode = 100

fd = open('/var/cache/appcenter-installed.txt')
for appID in fd:
	appID = appID.strip()
	if not appID:
		continue
	print 'Checking App: %s' % appID

	app = Application.find(appID)
	if not app:
		print ' Test failed: Requested App not found: %s' % appID
		returncode = 1
		continue

	for package in app.get('defaultpackages'):
		if not check_package(package):
			returncode = 1

	if ucr.get('server/role') in ['domaincontroller_master', 'domaincontroller_backup']:
		for package in app.get('defaultpackagesmaster'):
			if not check_package(package):
				returncode = 1

	with udm_test.UCSTestUDM() as udm:
		utils.verify_ldap_object(app_dn(app), {
							'univentionAppName': ['[en] %s' % app.get('unlocalised_name')],
							'univentionAppID': [app.ldap_id],
							'univentionAppVersion': [app.version],
						})
		utils.verify_ldap_object(app_dn(app), {
							'univentionAppInstalledOnServer' : ['%s.%s' % (ucr.get('hostname'), ucr.get('domainname'))],
						}, False)  # non-strict check for the UCS@School, as there app can be installed on all servers, bug #35652

		for version in app.versions:
			if version.version == app.version:
				continue
			utils.verify_ldap_object(app_dn(version), should_exist=False)

	if app.get('ucsoverviewcategory') and app.get('webinterface'):
		if ucr.get('ucs/web/overview/entries/%s/%s/link' % (app.get('ucsoverviewcategory'), app.id)) != app.get('webinterface'):
			print ' %r apparently did not register its webinterface! Alarm!!' % app
			returncode = 1

sys.exit(returncode)
