#!/usr/share/ucs-test/runner bash
## desc: Create a user via udm cli and authenticate via ldap and samba
## roles:
##  - domaincontroller_master
##  - domaincontroller_backup
##  - domaincontroller_slave
##  - memberserver
## tags:
##  - basic
##  - apptest
##  - skip_admember
## packages:
##  - univention-directory-manager-tools
## exposure: dangerous
## versions:
##  3.0-0: found

. "$TESTLIBPATH/base.sh" || exit 137
. "$TESTLIBPATH/user.sh" || exit 137
. "$TESTLIBPATH/samba.sh" || exit 137

USERNAME=$(user_randomname)
PASSWORD=univention

info "Create a test user with UDM CLI" 
user_create "$USERNAME"

wait_for_replication
if checkpkg univention-samba4; then
	wait_for_drs_replication "(sAMAccountName=$USERNAME)"
fi

ldapsearch -x -D "uid=$USERNAME,cn=users,$ldap_base" -w "$PASSWORD" -s base || RETVAL=110

# In case of a memberserver in a S4 environment, we have to
# wait until the user has been synchonized to Samba 4. Otherwise
# we can't get a kerberos ticket
if [ "$server_role" = "memberserver" ]; then
	sleep 16
fi

info "Try to get a kerberos ticket for the new user"

echo "$PASSWORD" | kinit --password-file=STDIN "$USERNAME" || RETVAL=110

info "Samba Logon with this new user"
smbclient -L localhost -U "${USERNAME}%${PASSWORD}" || RETVAL=110

user_remove "$USERNAME"

exit $RETVAL
# vim:set ft=sh:
