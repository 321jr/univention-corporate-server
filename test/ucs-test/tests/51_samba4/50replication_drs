#!/usr/share/ucs-test/runner bash
## desc: "Test whether the samba4 replication works"
## exposure: safe
## packages:
##  - univention-samba4
## roles:
## - domaincontroller_master
## - domaincontroller_backup
## - domaincontroller_slave

. "$TESTLIBPATH/user.sh" || exit 137
. "$TESTLIBPATH/shares.sh" || exit 137
. "$TESTLIBPATH/random.sh" || exit 137

#----create User
SAMBA="true"
MAIL="false"
KERBEROS="true"
PERSON="false"
POSIX="true"

username="$(user_randomname)"
password=univention

trap 'user_remove "$username"' INT TERM EXIT
user_create "$username" || fail_fast 1 "Could not create user $username."

sleep 5	## wait a bit to give replication a head start

i=0
while ! ldbsearch -H /var/lib/samba/private/sam.ldb "samaccountname=$username" | grep -q '^dn:'
do
	let i=$i+1
	if [ "$i" = 20 ]; then
		fail_fast 1 "TIMEOUT: the user account '$username' was not replicated in $i seconds"
	fi
	sleep 1
done

exit $RETVAL