#!/usr/share/ucs-test/runner bash
## desc: "Test accessing sysvol with smbclient using machine.secret"
## exposure: safe
## packages:
##  - univention-samba4
## bugs: [30818]
## roles:
## - domaincontroller_master
## - domaincontroller_backup
## - domaincontroller_slave

. "$TESTLIBPATH/shares.sh" || exit 137

hostname="$(ucr get hostname)"
password="$(cat /etc/machine.secret)"
ldap_master="$(ucr get ldap/master)"


## Access sysvol using smbclient
echo "----Accessing sysvol using smbclient and hostname/machine.secret credentials"
i=0
while ! output="$(smbclient -U "$hostname\$%$password" "//$ldap_master/sysvol" -c "ls $domainname/Policies" 2>&1)"
do
	let i=$i+1
	if [ "$i" = 10 ]; then
		echo "$output"
		fail_test 1 "Could not access Policies on sysvol with machine.secret credentials"
		break
	fi
	sleep 3
done

exit $RETVAL
