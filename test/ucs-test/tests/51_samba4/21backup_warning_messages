#!/usr/share/ucs-test/runner bash 
# -*- coding: utf-8 -*.
## desc: Check univention-samba4-backup warnings are supressed.
## exposure: dangerous
## bugs: [35907]
## packages:
## - univention-samba4
## roles:
## - domaincontroller_master
## - domaincontroller_backup
## - domaincontroller_slave

LANG=C

. "$TESTLIBPATH/base.sh" || exit 137

function test_backup {
    local output=$(univention-samba4-backup $@ 2>&1)
    local retval=$?

    if [ $retval -ne 0 ]; then
        echo -e "$output"
        fail_test $retval "univention-samba4-backup exited with code $retval"
    fi

    # grep output for messages apeared in Bug #35392:
    local errors=$(echo "$output" | grep -i -e "socket ignored" \
                                         -e "file changed as we read it")

    if [ -n "$errors" ]; then
        echo -e "$errors"
        fail_test 1 "univention-samba4-backup produced one of the messages that should be supressed."
    fi
}

# A basic test as a baseline. This should not fail.
test_backup
