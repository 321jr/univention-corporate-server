#!/usr/share/ucs-test/runner bash
## desc: "Creating a shared printer and printing from smbclient"
## exposure: safe
## packages:
##  - univention-samba4
##  - univention-printserver
## roles:
## - domaincontroller_master
## - domaincontroller_backup
. "$TESTLIBPATH/user.sh" || exit 137
. "$TESTLIBPATH/random.sh" || exit 137

#create user
echo "----Create user"
SAMBA="true"
MAIL="false"
KERBEROS="true"
PERSON="false"
POSIX="true"

username="$(user_randomname)"
printername="$(random_chars 12)"
password=univention

trap '
user_remove "$username";
rm -rf "/tmp/$printername"/ /tmp/print_input;
udm-test shares/printer remove --dn="$PRINTER_DN"
wait_for_replication_and_postrun
' INT TERM EXIT
user_create "$username" || fail_fast 1 "Could not create user $username."

#wait for the user to be created
echo "----wait for the user to be created"
i=0
while ! ldbsearch -H "/var/lib/samba/private/sam.ldb" -U"$username%$password" "cn=$username" | grep -q '^dn:'
do
	let i=$i+1
	if [ $i = 20 ]; then
		fail_fast 1 "TIMEOUT: The User which has been created in UDM could not be found in samba ldb"
	fi
	sleep 1
done

#create printer
echo "----create printer"
udm-test shares/printer create \
	--set "name=$printername" \
	--set "spoolHost=$hostname.$domainname" \
	--set "uri=file:/ tmp/$printername" \
	--set "model=None"

wait_for_replication_and_postrun

#get the printer DN
echo "----get the printer DN"
i=0
while true
do
	let i=$i+1
	sleep 1
	PRINTER_DN="$(univention-ldapsearch cn=$printername | sed -ne 's/^dn: //p')" && break
	echo "$PRINTER_DN"
	if [ $i == 100 ]; then
		echo "Could not get printer DN"
		break
	fi
done


## look for printer
echo "----Looking for samba printer share '$printername'"
i=0
while ! smbclient -NL localhost | grep -qE "^\s+$printername\s+Printer"
do
	echo '.'
	let i=$i+1
	if [ $i = 20 ]; then
		fail_fast 1 "Samba did not provide the printer share 20 seconds after creation"
	fi
	sleep 1
done

#create input file
echo "----Creating input file"

echo "$(uname -a)" > "/tmp/print_input"

## initiate print
echo "initiate print"
i=0
while ! smbclient -U"$username%$password" "//$hostname.$domainname/$printername" -c "print /tmp/print_input"
do
	let i=$i+1
	if [ $i = 20 ]; then
		fail_fast 1 "Initiate printing has not been successful."
	fi
	sleep 1
done

## check output
echo "check output"
i=0
while ! grep -q "$(uname -a)" "/tmp/$printername"
do
	let i=$i+1
	if [ $i = 10 ]; then
		fail_fast "Nothing has been printed to the output file."
	fi
	sleep 1
done

exit $RETVAL
