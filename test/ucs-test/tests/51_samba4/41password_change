#!/usr/share/ucs-test/runner bash
## desc: "Testing password changing with udm, samba and kerberos"
## exposure: safe
## packages:
##  - univention-samba4
## roles:
## - domaincontroller_master
## - domaincontroller_backup
## - domaincontroller_slave
## tags: [basic]

. "$TESTLIBPATH/user.sh" || exit 137
. "$TESTLIBPATH/shares.sh" || exit 137
. "$TESTLIBPATH/random.sh" || exit 137

#----create User
SAMBA="true"
MAIL="false"
KERBEROS="true"
PERSON="false"
POSIX="true"

username="$(user_randomname)"
first_password=univention
second_password="$(random_chars 8 ${_upperletters}${_lowerletters}${_ciphers}äöü)1AÄÖÜ"
third_password=$"(random_chars 8 ${_upperletters}${_lowerletters}${_ciphers}äöü)1AÄÖÜ"
fourth_password="$(random_chars 8 ${_upperletters}${_lowerletters}${_ciphers}äöü)1AÄÖÜ"

user_create "$username" || fail_test 1 "Could not create user $username."

#----create Share
sharename="$(random_share)"
share_create "$sharename" /"$sharename"  || fail_test 1 "Could not create share $sharename."
share_dn=$(univention-directory-manager shares/share list --filter sambaName="$sharename" | sed -ne 's/^DN: //p')
udm shares/share modify --dn="$share_dn" --set sambaPublic=1  || fail_test 1 "Could not modify share $sharename."

USER_DN="$(univention-directory-manager users/user list --filter uid="$username" | sed -ne 's/^DN: //p')"

trap 'user_remove "$username";share_remove "$sharename"' INT TERM EXIT

sleep 20


#--test starting point
#----normal connection using all methods
smbclient -U "$username%$first_password" "//$hostname.$domainname/$sharename" -c "exit"  || fail_test 1 "Could not connect to the share."
univention-directory-manager users/user list --binddn "$USER_DN" --bindpwd "$first_password" > /dev/null || fail_test 1 "Could not authentificate using UDM."

#----password change with samba-tool
samba-tool user setpassword "$username" --newpassword="$second_password" 
sleep 10
#---------check with udm
univention-directory-manager users/user list --binddn "$USER_DN" --bindpwd "$second_password" > /dev/null || fail_test 1 "Could not authentificate with UDM after password change with samba-tool."
#---------check with kinit
echo "$second_password" | kinit --password-file=STDIN "$username" || fail_test 1 "Could not authentificate with kinit after password change with samba-tool."

#----password change with udm
univention-directory-manager users/user modify --binddn "$ADMINISTRATOR_DN" --bindpwd "$ADMINISTRATOR_PASSWORD" --dn "$USER_DN" --set "password=$third_password" || fail_test 1 "Could not change password with UDM"
sleep 10
#--------check with smbclient
smbclient -U "$username%$third_password" "//$hostname.$domainname/$sharename" -c "exit"  || fail_test 1 "Could not authentificate with smbclient after password change with UDM."
#---------check with kinit
echo "$third_password" | kinit --password-file=STDIN "$username" || fail_test 1 "Could not authentificate with kinit after password change with UDM."

#----password change with kpassword
python test_kpasswd.py -u "$username" -r "univention" -n "$fourth_password" -p "$third_password"
sleep 10
#---------check with udm
univention-directory-manager users/user list --binddn "$USER_DN" --bindpwd "$fourth_password" > /dev/null || fail_test 1 "Could not authentificate with UDM after password change with kpasswd."
#--------check with smbclient
smbclient -U "$username%$fourth_password" "//$hostname.$domainname/$sharename" -c "exit"  || fail_test 1 "Could not authentificate with smbclient after password change with kpasswd."

exit $RETVAL