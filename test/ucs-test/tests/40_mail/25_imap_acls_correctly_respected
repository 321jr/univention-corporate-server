#!/usr/share/ucs-test/runner python
## desc: Mail imap acl flags are correctly respected by the IMAP server
## tags: apptest
## exposure: dangerous
## packages: [univention-mail-server]

from essential.mailclient import MailClient, create_shared_mailfolder
from univention.config_registry import handler_set
import itertools
import univention.testing.strings as uts
import univention.testing.ucr as ucr_test
import univention.testing.udm as udm_test


def main():
	with udm_test.UCSTestUDM() as udm:
		with ucr_test.UCSTestConfigRegistry() as ucr:
			domain = ucr.get('domainname')
			handler_set(['mail/cyrus/mailbox/delete=yes'])
			host = '%s.%s' % (ucr.get('hostname'), domain)
			password = 'univention'
			mails = []
			users = []
			for i in xrange(2):
				usermail = '%s@%s' % (uts.random_name(), domain)
				userdn, username = udm.create_user(
					set={
						'password'           : password,
						'mailHomeServer'     : host,
						'mailPrimaryAddress' : usermail
					}
				)
				mails.append(usermail)
				users.append(userdn)
			group_mail = '%s@%s' % (uts.random_name(), domain)
			udm.create_group(
				users=users[0],
				set={
					'users'       : users[1],
					'mailAddress' : group_mail,
				},
			)
			default_shared_permissions = {'anyone': 'lrswipkxtecda'}
			permissions = 'lrswipkxtecda'
			shared_mailbox = create_shared_mailfolder(
				udm, host, user_permission=['"%s" "%s"' % ('anyone', 'all')])

			mails.append(group_mail)
			test_cases = itertools.product(mails, permissions)
			for i in xrange(len(mails) * len(permissions)):
				who, what = next(test_cases)
				imap = MailClient(host)
				imap.log_in(usermail, password)
				mailboxs = imap.getMailBoxes()
				mailboxs.append(shared_mailbox)
				for mailbox in mailboxs:
					print '%d: Mailbox = %s, %s -> %s' % (i, mailbox, who, what)
					imap.deleteacl(mailbox, who)
					if mailbox == shared_mailbox:
						imap.check_acls({mailbox: default_shared_permissions})
					imap.setacl(mailbox, who, what)
					imap.check_acls({mailbox: {who: what} })
				imap.logout()


if __name__ == '__main__':
	main()

# vim: set ft=python ts=4 sw=4 noet :
