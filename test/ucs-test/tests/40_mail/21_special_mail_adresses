#!/usr/share/ucs-test/runner python
## desc: Test special mail adresses
## tags: apptest
## exposure: dangerous
## packages: [univention-mail-server]

from essential.mail import send_mail, mail_delivered
import time
import univention.testing.ucr as ucr_test
import univention.testing.udm as udm_test
import univention.testing.utils as utils


def check_sending_mail(username, password, recipient_email):
	delivery_timeout = 60 # sec
	delivered = False
	token = str(time.time())
	send_mail(recipients=recipient_email, msg=token, tls=True, username=username, password=password)
	for i in xrange(delivery_timeout):
		if not mail_delivered(token, check_root=True):
			time.sleep(1)
			print "%s is waiting for email to be delivered to root" % recipient_email
		else:
			delivered = True
			break
	if not delivered:
		utils.fail('Mail sent with token = %r to %s was not redirected to root' % (token, recipient_email))


def main():
	with ucr_test.UCSTestConfigRegistry() as ucr:
		with udm_test.UCSTestUDM() as udm:
			domain = ucr.get('domainname')
			for mail_name in ('postmaster', 'abuse', 'webmaster'):
				recipient_email = '%s@%s' % (mail_name, domain )
				userdn, username = udm.create_user(
					set={
						'password': 'univention',
						'mailHomeServer': '%s.%s' % (ucr.get('hostname'), domain),
						'mailPrimaryAddress': recipient_email,
					}
				)
				check_sending_mail(username, 'univention', recipient_email)


if __name__ == '__main__':
    main()
# vim: ft=python:ts=4:sw=4:noet:
