#!/usr/share/ucs-test/runner python
## desc: Email domain validity
## tags: [apptest]
## exposure: dangerous
## packages: [univention-mail-server]

import univention.testing.strings as uts
import univention.testing.ucr as ucr_test
import univention.testing.udm as udm_test
import univention.testing.utils as utils


EXPECTED_ERROR_MSG = 'The domain part of the primary mail address is not in list of configured mail domains'


def main():
	with ucr_test.UCSTestConfigRegistry() as ucr, udm_test.UCSTestUDM() as udm:
		fqdn = '%s.%s' % (ucr.get('hostname'), ucr.get('domainname'))
		is_test_failed = True
		try:
			mail_address = '%s@%s' % (uts.random_name(), uts.random_name())
			udm.create_user(
				set={
					'password': 'univention',
					'mailHomeServer': fqdn,
					'mailPrimaryAddress': mail_address
				}
			)
		except udm_test.UCSTestUDM_CreateUDMObjectFailed as exc:
			if EXPECTED_ERROR_MSG in str(exc):
				is_test_failed = False
		if is_test_failed:
			utils.fail('Domain which is not in list of configured mail domains was accepted by udm')


if __name__ == '__main__':
	main()
# vim: ft=python:ts=4:sw=4:noet:
