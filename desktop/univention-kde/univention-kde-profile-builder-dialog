#!/bin/sh
#
# Copyright 2001-2011 Univention GmbH
# 
# http://www.univention.de/
# 
# All rights reserved.
# 
# The source code of the software contained in this package
# as well as the source package itself are made available
# under the terms of the GNU Affero General Public License version 3
# (GNU AGPL V3) as published by the Free Software Foundation.
# 
# Binary versions of this package provided by Univention to you as
# well as other copyrighted, protected or trademarked materials like
# Logos, graphics, fonts, specific documentations and configurations,
# cryptographic keys etc. are subject to a license agreement between
# you and Univention and not subject to the GNU AGPL V3.
# 
# In the case you use the software under the terms of the GNU AGPL V3,
# the program is provided in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU Affero General Public License for more details.
# 
# You should have received a copy of the GNU Affero General Public
# License with the Debian GNU/Linux or Univention distribution in file
# /usr/share/common-licenses/AGPL-3; if not, see
# <http://www.gnu.org/licenses/>.

# -name <profile-name>            The profilename e.g "test-123" (required !)
# -path <profile-path>            The path to configured profile e.g. "/home/user" (required !)
# -no-delete                      Set if you need the package-directory and other build files (optional)
# -version <number>               The Versionnumber, default is 0.1 (optional)
# -desktop <locked/restricted>    Desktop could be locked or restricted for user (required !)

# check requirements
if ! hash -r /usr/bin/univention-kde-profile-builder; then
	echo "error: could not find univention-kde-profile-builder"
	exit 1
fi

if ! hash -r kdialog; then
	echo "error: could not find kdialog"
	exit 1
fi

if [ ! "$(id -ru)" -eq 0 ]; then
	kdialog --error "Dieses Programm kann nur als root gestartet werden!"
	exit 1
fi

cmd=kdialog

if [ -n "$HOME" ]; then
	default_path=$HOME
else
	default_path="/home"
fi

tmpfile=`mktemp`
# get name
$cmd --inputbox "Name des Profils" "profile1" 2>/dev/null >$tmpfile
if [ $? -ne 0 ]; then exit 1; fi
name=`cat $tmpfile | grep -v KWrited | tail -n -1`
echo "NAME:" $name

kdialog --msgbox "Im folgenden Dialog muss das Heimatverzeichnis des Benutzers ausgewählt werden mit dem das KDE-Profil erstellt wurde." >/dev/null 2>&1

$cmd --title "Auswahl des Heimatverzeichnisses" --getexistingdirectory $default_path 2>/dev/null >$tmpfile
if [ $? -ne 0 ]; then exit 1; fi
path=`cat $tmpfile | grep -v KWrited | tail -n -1`

$cmd --inputbox "Versionsnummer des Profils" "0.1" 2>/dev/null >$tmpfile
if [ $? -ne 0 ]; then exit 1; fi
version=`cat $tmpfile | grep -v KWrited | tail -n -1`

$cmd --radiolist "Art des Profils" restricted "Veränderbare Vorgabe" off locked "Unveränderbare Vorgabe" on 2>/dev/null >$tmpfile
if [ $? -ne 0 ]; then exit 1; fi
desktop=`cat $tmpfile | grep -v KWrited | tail -n -1`

rm $tmpfile

echo /usr/bin/univention-kde-profile-builder -name "$name" -path "$path" -version "$version" -desktop "$desktop"

if /usr/bin/univention-kde-profile-builder -name "$name" -path "$path" -version "$version" -desktop "$desktop" | grep "pkg-deb: .*univention-kde-profile-$name"; then
	kdialog --msgbox "das Profil-Paket wurde erfolgreich erstellt und im aktuellen Verzeichnis ($PWD) abgelegt."
else
	kdialog --error "Leider ist die Erstellung des Profil-Paketes fehlgeschlagen"
fi
