<chapter id="windows:Services_fuer_Windows">
  <title>Services für Windows</title>
  <section id="windows:general">
	<title>Einführung</title>
	<para>
	  UCS kann Active Directory (AD) Dienste anbieten, Mitglied einer Active Directory-Domäne sein,
	  Objekte zwischen Active Directory-Domänen und einer UCS-Domäne synchronisieren oder als
	  NT-Domänencontroller arbeiten.
	</para>
	<para>
	  Aus Sicht von Windows-Systemen kann UCS die Aufgaben von Windows-Serversystemen übernehmen:
	</para>

	<itemizedlist>
	  <listitem><simpara>
		Domänencontrollerfunktionalität / Authentifizierungsdienste
	  </simpara></listitem>

	  <listitem><simpara>
		Dateidienste
	  </simpara></listitem>

	  <listitem><simpara>
		Druckdienste
	  </simpara></listitem>
	</itemizedlist>

	<para>
	  Alle diese Dienste werden in UCS durch die Software Samba bereitgestellt.
	</para>

	<para>
	  UCS unterstützt zusätzlich die weitgehend automatische Migration einer bestehenden Microsoft Active
	  Directory Domäne zu UCS. Dabei werden alle Benutzer, Gruppen, Rechnerobjekte und
	  Gruppenrichtlinien übernommen ohne das die Windows-Clients erneut der Domäne beitreten
	  müssen. Dies ist in <xref linkend="windows:adtakeover"/> beschrieben.
	</para>

	<para>
	  Die Migration von einer Samba-Domäne auf NT-Basis zu einer Domäne mit Active
	  Directory-Diensten ist im Univention Wiki <biblioref linkend="wiki-samba-update"/>
	  beschrieben.
	</para>

	<para>
	  Microsoft Active Directory-Domänencontroller können aktuell nicht einer UCS-Samba-Domäne
	  beitreten. Diese Funktionalität ist zu einem späteren Zeitpunkt geplant.
	</para>

	<para>
	  Samba kann zum jetzigen Zeitpunkt noch nicht einem Active Directory Forest beitreten.
	</para>

	<para>
	  Vertrauensstellungen mit anderen Domänen sind aktuell nur bei Verwendung NT-kompatibler
	  Domänen möglich (siehe <xref linkend="vertrauensstellungen_generell"/>).
	</para>
  </section>

  <section id="windows:addomain">
	<title>Betrieb einer Samba-Domäne auf Basis von Active Directory</title>

	<section id="windows:setup4">
	  <title>Installation</title>

	  <para>
		Samba als AD-Domänencontroller kann auf allen UCS-Domänencontrollern mit der Applikation
		<emphasis>Active Directory-kompatibler Domänencontroller</emphasis> aus dem Univention App
		Center installiert werden. Alternativ kann das Softwarepaket
		<package>univention-samba4</package> installiert werden. Auf den Systemrollen &ucsMaster;
		und &ucsBackup; muss zusätzlich <package>univention-s4-connector</package> installiert
		werden (anschließend muss der Befehl <command>univention-run-join-scripts</command>
		aufgerufen werden). Weitere Informationen finden sich in <xref
		linkend="computers::softwaremanagement::installsoftware"/>.
	  </para>

	  <para>
		Ein Samba-Memberserver kann auf UCS-Memberservern mit der Applikation
		<emphasis>Windows-kompatibler Fileserver</emphasis> aus dem Univention App Center
		installiert werden. Alternativ kann das Softwarepakete <package>univention-samba</package>
		installiert werden (anschließend muss der Befehl
		<command>univention-run-join-scripts</command> aufgerufen werden). Weitere Informationen
		finden sich in <xref linkend="computers::softwaremanagement::installsoftware"/>.
	  </para>

	  <para>
		Samba unterstützt auch den Betrieb als <emphasis>read-only domain controller</emphasis>. Die
		Einrichtung ist in <biblioref linkend="ext-doc-win"/> dokumentiert.
	  </para>
	</section>

	<section id="windows:samba4:services">
	  <title>Dienste einer Samba-Domäne</title>

	  <section id="windows:samba4:services:auth">
		<title>Authentifizierungsdienst</title>

		<para>
		  Benutzeranmeldungen können nur auf Microsoft Windows-Systemen erfolgen, die der
		  Samba-Domäne beigetreten sind. Der Domänenbeitritt  ist in <xref
		  linkend="windows-domaenenbeitritt"/> dokumentiert.
		</para>

		<para>
		  Benutzer, die sich an einem Windows-System anmelden erhalten bei der Anmeldung ein
		  Kerberos-Ticket, mit dem die weitere Authentifizierung durchgeführt wird. Mit diesem
		  Ticket wird dann auf die Ressourcen der Domäne zugegriffen. 
		</para>

		<para>
		  Häufige Fehlerquellen bei fehlschlagenden Anmeldungen sind:

		  <itemizedlist>
			<listitem><simpara>
			  Für eine funktionierende Kerberos-Authentifizierung ist eine Synchronisation der
			  Systemzeiten zwischen Windows-Client und Domänencontroller zwingend erforderlich. In
			  der Grundeinstellung wird beim Systemstart die Systemzeit über NTP aktualisiert. Dies
			  kann mit dem Befehl <command>w32tm /resync</command> auch manuell erfolgen.
			</simpara></listitem>

			<listitem><simpara>
			  Während der Anmeldung müssen DNS-Service-Records aufgelöst werden. Der Windows-Client
			  sollte daher als DNS-Nameserver die IP-Adresse des Domänencontrollers verwenden.
			</simpara></listitem>
		  </itemizedlist>
		</para>

	  </section>

	  <section id="windows:samba4:fileservices">
		<title>Dateidienste / File-Server</title>

		<para>
		  Ein Dateiserver stellt zentral benötigte Dateien über das Netz bereit und ermöglicht es
		  unter anderem Benutzerdaten auf einem zentralen Server zu bündeln.
		</para>

		<para>
		  Die in UCS integrierten Dateidienste unterstützen eine Bereitstellung von Freigaben auf
		  Basis von CIFS/SMB (siehe <xref linkend="shares::general"/>). Sofern das unterliegende
		  Dateisystem Access Control Lists (ACLs) unterstützt (verwendbar bei ext3, ext4 und XFS)
		  sind ACLs auch von Windows-Clients verwendbar.
		</para>

		<para>
		  Dateidienste können auch mit Samba Active Directory-Domänencontrollern bereitgestellt
		  werden. Generell wird in Samba-Umgebungen - analog zu den Microsoft-Empfehlungen für Active
		  Directory - empfohlen Domänencontroller- und Datei/Druckdienste zu trennen,
		  d.h. Domänencontroller für die Anmeldung und Memberserver für Datei-/Druckdienste zu
		  verwenden. Dies stellt sicher, dass hohe Last auf einem Fileserver nicht zu Störungen im
		  Anmeldedienst führen. Für kleine Umgebungen, in denen keine Möglichkeit für den Betrieb
		  zweier Server gegeben ist, können Datei- und Druckdienste auch mit auf einem
		  Domänencontroller betrieben werden.
		</para>

		<para>
		  Samba unterstützt das CIFS-Protokoll und den Nachfolger SMB2. Verwendet man einen Client,
		  der SMB2 unterstützt (ab Windows Vista, also auch Windows 7/8), verbessert sich die
		  Performance und die Skalierbarkeit.
		</para>

		<para>
		  Das Protokoll kann über die &ucsUCR;-Variable <envar>samba/max/protocol</envar>
		  konfiguriert werden. Sie muss auf allen Samba-Servern gesetzt und anschließend der/die
		  Samba-Server neu gestartet werden.

		  <itemizedlist>
			<listitem><simpara>
			  <emphasis>NT1</emphasis> konfiguriert CIFS (unterstützt von allen Windows-Versionen)
			</simpara></listitem>

			<listitem><simpara>
			  <emphasis>SMB2</emphasis> konfiguriert SMB2 (unterstützt ab Windows Vista/Windows 7)
			</simpara></listitem>

			<listitem><simpara>
			  <emphasis>SMB3</emphasis> konfiguriert SMB3 (unterstützt ab Windows 8) (aktuell nicht durch Univention-Support abgedeckt)
			</simpara></listitem>
		  </itemizedlist>
		</para>
	  </section>


	  <section id="windows:samba4:services:print">
		<title>Druckdienste / Print-Server</title>
		<para>
		  Samba bietet die Möglichkeit, unter Linux eingerichtete Drucker als Netzwerkdrucker für
		  Windows-Clients freizugeben. Die Verwaltung der Druckerfreigaben und die Integration der
		  Druckertreiber ist in <xref linkend="print::general"/> beschrieben.
		</para>

		<para>
		  Druckdienste können auch mit Samba AD-Domänencontrollern bereitgestellt werden. Hierbei
		  sind die in <xref linkend="windows:samba4:fileservices"/> beschriebenen Einschränkungen zu
		  beachten.
		</para>
	  </section>


	  <section id="windows:s4connector">
		<title>Univention S4 Connector</title>
		<para>
		  Samba stellt einen separaten LDAP-Verzeichnisdienst bereit. Die Synchronisation zwischen
		  dem UCS-LDAP und dem Samba-LDAP erfolgt durch einen internen Systemdienst, den Univention
		  S4 Connector. Der Connector ist standardmässig auf dem &ucsMaster; aktiviert und benötigt
		  normalerweise keine weitere Konfiguration.
		</para>

		<para>
		  Hinweise zum Status der Synchronisation finden sich in der Logdatei
		  <filename>/var/log/univention/connector-s4.log</filename>. Weitere Informationen zur
		  Fehleranalyse von eventuellen Connectorproblemen finden sich in <xref linkend="sdb-s4trouble"/>.
		</para>

		<para>
		  Mit dem Befehl <command>univention-s4search</command> kann im Samba-Verzeichnisdienst
		  gesucht werden. Wird es als Benutzer <emphasis>root</emphasis> aufgerufen,
		  werden automatisch die nötigen Credentials des Maschinenkontos verwendet:

		  <programlisting>
root@master:~# univention-s4search sAMAccountName=Administrator
# record 1
dn: CN=Administrator,CN=Users,DC=example,DC=com
objectClass: top
objectClass: person
objectClass: organizationalPerson
objectClass: user
cn: Administrator
instanceType: 4
(..)
		  </programlisting>
		</para>
	  </section>


	  <section id="windows:multimaster">
		<title>DRS-Replikation der Verzeichnisdaten</title>

		<para>
		  Samba-AD-Domänen verwenden das Directory Replication System (DRS) zur Replikation der
		  Verzeichnisdaten. DRS erlaubt Multimasterreplikation, d.h. die schreibenden Änderungen
		  mehrerer Domänencontroller werden auf Protokollebene synchronisiert. Die Verwendung von
		  Snapshots in Virtualisierungslösungen sollte daher beim Einsatz von Samba 4 vermieden und
		  Samba 4 auf einem Server betrieben werden, der durchgehend eingeschaltet bleibt.
		</para>

		<para>
		  Mit jedem weiteren Samba-AD-Domänencontroller steigt die Komplexität der
		  Multimasterreplikation. Es sollte daher geprüft werden, ob weitere
		  Samba-AD-Domänencontroller nötig sind oder für neue Server nicht ein Memberserver die
		  bessere Wahl ist.
		</para>

		<para>
		  Hinweise zur Analyse von DRS-Replikationsproblemen finden sich in <xref
		  linkend="sdb-s4trouble"/>.
		</para>
	  </section>


	  <section id="windows:sysvolshare">
		<title>Synchronisation der SYSVOL-Freigabe</title>
		<para>
		  Die SYSVOL-Freigabe ist eine Freigabe, die in Active Directory/Samba Gruppenrichtlinien
		  und Anmeldeskripte bereitstellt. Sie wird zwischen allen Domänencontrollern synchronisiert
		  und im Verzeichnis <filename>/var/lib/samba/sysvol</filename> gespeichert.
		</para>

		<para>
		  In Microsoft Active Directory wird die SYSVOL-Freigabe durch den File Replication Service
		  (eingeführt mit Windows 2000), bzw. durch das Distributed File System (ab Windows 2008 R2)
		  synchronisiert. Diese Replikationsmethoden sind in Samba noch nicht vollständig
		  implementiert. Die Synchronisation zwischen den Samba-Domänencontrollern erfolgt in UCS
		  durch einen Cron-Job (standardmäßig alle fünf Minuten, konfigurierbar durch die &ucsUCRV;
		  <envar>samba4/sysvol/sync/cron</envar>.
		</para>
	  </section>
	</section>


	<section id="windows:samba4:desktopmanagement">
	  <title>Konfiguration und Management von Windows-Desktops</title>

	  <section id="gruppenrichtlinien">
		<title>Gruppenrichtlinien</title>

		<section id="gpo:intro">
		  <title>Einführung</title>

		  <para>
			Gruppenrichtlinien sind eine Active Directory-Funktion, die die zentrale Konfiguration von
			Vorgaben für Rechner und Benutzer erlaubt. Gruppenrichtlinien werden auch von
			Samba-AD-Domänen unterstützt. Die Richtlinien greifen nur auf Windows-Clients; Linux- oder
			Mac OS-Systeme werten die Richtlinien nicht aus.
		  </para>
		
		  <para>
			Gruppenrichtlinien werden ausgehend von der englischen Bezeichung <emphasis>Group policy
			objects</emphasis> auch oft als GPOs bezeichnet. Genauer gesagt kann ein
			Gruppenrichtlinienobjekt eine Reihe von Richtlinien beinhalten. Trotz ihres Namens
			lassen sich Gruppenrichtlinienobjekte nicht direkt bestimmten Benutzergruppen zuweisen,
			sondern sie werden vielmehr mit bestimmten AD-Verwaltungseinheiten (Domänen, Sites oder
			Organisationseinheiten) im Samba-Verzeichnisdienst (Samba DS/AD) verknüpft und beziehen
			sich dadurch auf untergeordnete Objekte. Eine gruppen- oder benutzerspezifische
			Auswertung ist nur indirekt über die <emphasis>Sicherheitseinstellungen</emphasis> eines
			Gruppenrichtlinienobjekts möglich, in denen sich das Recht <emphasis>Gruppenrichtlinie
			übernehmen</emphasis> gezielt auf bestimmte Gruppen, Benutzer oder Computer einschränken
			lässt.
		  </para>

		  <para>
			Grundsätzlich sind die <emphasis>Gruppenrichtlinien</emphasis> (<emphasis>Group
			Policies</emphasis> (GPO)) von den sehr ähnlich benannten
			<emphasis>Gruppenrichtlinieneinstellungen</emphasis> (<emphasis>Group Policy
			Preferences</emphasis> (GPP)) zu unterscheiden:
			<itemizedlist>
			  <listitem><simpara>
		        Die über <emphasis>Gruppenrichtlinien</emphasis> (GPOs) getroffenen Vorgaben sind
				bindend, während sich über <emphasis>Gruppenrichtlinieneinstellungen</emphasis>
				(GPPs) nur Präferenzen in die Registry von Windows-Clients eintragen lassen, die
				aber unter Umständen am Client überschrieben werden können.
			  </simpara></listitem>

			  <listitem><simpara>
		        Die über <emphasis>Gruppenrichtlinien</emphasis> (GPOs) getroffenen Vorgaben werden
				zudem dynamisch auf die Zielobjekte angewendet, wo hingegen die über
				<emphasis>Gruppenrichtlinieneinstellungen</emphasis> (GPPs) getroffenen
				Einstellungen statisch in die Registry von Windows-Clients eintragen werden (man
				spricht hier auch von <emphasis>Tattooing</emphasis>).
			  </simpara></listitem>
			</itemizedlist>
		    Aus diesen Gründen sind <emphasis>Gruppenrichtlinien</emphasis> (GPOs) in den meisten
			Fällen den <emphasis>Gruppenrichtlinieneinstellungen</emphasis> (GPPs)
			vorzuziehen. Dieses Kapitel bezieht sich im weiteren ausschließlich auf
			<emphasis>Gruppenrichtlinien</emphasis> (GPOs).
		  </para>

		  <para>
			Gruppenrichtlinien werden im Gegensatz zu den UCS-Richtlinien (siehe <xref
			linkend="central:policies"/>) nicht in der &ucsUMC;, sondern mit einem  separaten Editor
			konfiguriert, mit der <emphasis>Gruppenrichtlinienverwaltung</emphasis>, die Teil der
			<emphasis>Remote Server Administration Tools</emphasis> (RSAT) ist. Die Einrichtung ist
			in <xref linkend="gpo:install"/> dokumentiert.
		  </para>

		  <para>
			Es existieren zwei Arten von Richtlinien:
			
			<itemizedlist>
			  <listitem><simpara>
				<emphasis>Benutzerrichtlinien</emphasis> konfigurieren die Einstellungen eines
				Benutzers, z.B. die Vorkonfiguration des Desktops. Auch Anwendungen können über Gruppenrichtlinien konfiguriert
				werden (z.B. die Startseite des Microsoft Internet Explorers oder Einstellungen in LibreOffice).
			  </simpara></listitem>

			  <listitem><simpara>
				<emphasis>Computer-Richtlinien</emphasis> definieren die Einstellungen von
				Windows-Clients.
			  </simpara></listitem>
			</itemizedlist>
		  </para>

		  <para>
			Computerrichtlinien werden erstmalig beim Systemstart ausgewertet, Benutzerrichtlinien bei
			der Anmeldung. Die Richtlinien werden auch für angemeldete Benutzer/laufende Systeme
			fortlaufend ausgewertet und aktualisiert (in der Grundeinstellung alle 90-120 Minuten,
			der Zeitraum wird zur Vermeidung von Lastspitzen nach dem Zufallsprinzip variiert).
		  </para>

		  <para>
			Die Auswertung der Gruppenrichtlinien kann durch Aufruf des Befehls
			<command>gpupdate /force</command> auch gezielt gestartet werden.
		  </para>

		  <para>
			Einige Richtlinien - z.B. zur Installation von Software oder für Anmeldeskripte - werden
			nur bei der Anmeldung (Benutzerrichtlinien) oder beim Systemstart (Rechnerrichtlinien)
			ausgewertet.
		  </para>

		  <para>
			Die meisten Gruppenrichtlinien setzen nur einen Wert in der Windows-Registry, der dann
			von Windows oder einer Applikation ausgewertet wird. Da Standardbenutzer keine
			Einstellungen in dem entsprechenden Teil der Windows Registry editieren können, können so auch eingeschränkte
			Benutzer-Desktops konfiguriert werden, in denen z.B. Benutzer den Windows Task Manager
			nicht aufrufen dürfen.
		  </para>

		  <para>
			Die Gruppenrichtlinien werden in der SYSVOL-Freigabe gespeichert, siehe <xref
			linkend="windows:sysvolshare"/>. Verknüpft mit Benutzer- und Rechnerkonten werden sie im
			Samba-Verzeichnisdienst.
		  </para>

		</section>

		<section id="gpo:install">
		  <title>Installation der Gruppenrichtlinienverwaltung</title>

		  <para>
			Die Gruppenrichtlinienverwaltung kann als Teil der <emphasis>Remote Server
			Administration Tools</emphasis> auf Windows Clients installiert werden. Sie können für Windows 7 unter <footnote><para><ulink
			url="http://www.microsoft.com/downloads/details.aspx?FamilyID=7d2f6ad7-656b-4313-a005-4e344e43997d"/></para></footnote>
			oder für Windows 8 unter <emphasis>Remote Server Administration Tools (RSAT) for Windows 8</emphasis>
			<footnote><para><ulink
			url="http://www.microsoft.com/de-de/download/details.aspx?id=28972"/></para></footnote>
			bezogen werden.
		  </para>

		  <para>
			<figure><title>Aktivierung der Gruppenrichtlinienverwaltung</title>
			<graphic scalefit="1" width="80%" fileref="illustrations/gpo-activate-de.png"/>
			</figure>
		  </para>

		  <para>
			Nach der Installation muss die Gruppenrichtlinienverwaltung in der Windows-Systemsteuerung
			noch aktiviert werden, in dem unter <guimenu>Start -> Systemsteuerung -> Programme ->
			Windows-Funktionen aktivieren und deaktivieren -> Remoteserver-Verwaltungstools ->
			Featureverwaltungs-Tools</guimenu> die Option <guimenu>Tools für die
			Gruppenrichtlinienverwaltung</guimenu> aktiviert wird.
		  </para>

		  <para>
			Nach der Aktivierung kann die Gruppenrichtlinienverwaltung unter <guimenu>Start ->
			Verwaltung -> Gruppenrichtlinienverwaltung</guimenu> aufgerufen werden.
		  </para>

		</section>

		<section id="gpo:config">
		  <title>Konfiguration von Richtlinien mit der Gruppenrichtlinienverwaltung</title>

		  <para>
			Gruppenrichtlinien können nur von Benutzern konfiguriert werden, die Mitglied der Gruppe
			<emphasis>Domain Admins</emphasis> sind (z.B. der
			<emphasis>Administrator</emphasis>). Bei der Anmeldung muss beachtet werden, dass keine
			Anmeldung mit dem lokalen Administrator-Konto erfolgt, sondern mit dem
			Administrator-Konto der Domäne. Die Gruppenrichtlinienverwaltung kann auf einem beliebigen
			System der Domäne aufgerufen werden.
		  </para>

		  <para>
			Wenn mehr als ein Samba-Domänencontroller eingesetzt wird, muss die Replikation der
			GPO-Daten berücksichtigt werden, siehe <xref linkend="gpo:gposync"/>.
		  </para>
		  <para>
			Es gibt zwei prinzipielle Möglichkeiten GPOs zu erstellen:

			<itemizedlist>
			  <listitem><simpara>
				Sie können im <guimenu>Gruppenrichtlinienobjekte</guimenu>-Order angelegt und dann mit
				verschiedenen Positionen im LDAP verknüpft werden. Dies ist sinnvoll, wenn eine
				Richtlinie mit mehreren Positionen im LDAP verknüpft werden soll.
			  </simpara></listitem>

			  <listitem><simpara>
				Die GPO kann ad hoc an einer LDAP-Position erstellt und dabei direkt verknüpft
				werden. Für kleine und mittlere Domänen ist das der einfachere Weg. Auch ad hoc
				erstellte Domänen werden im  <guimenu>Gruppenrichtlinienobjekte</guimenu>-Ordner angezeigt.
			  </simpara></listitem>
			</itemizedlist>
		  </para>

		  <para>
			Eine Richtlinie kann drei Zustände annehmen; sie kann aktiviert,
			deaktiviert oder nicht gesetzt sein. Die Auswirkung bezieht sich immer auf die
			Formulierung der Richtlinie. Wenn diese beispielsweise <guimenu>Deaktiviere Feature
			xy</guimenu> heisst, muss die Richtlinie aktiviert werden um das Feature
			abzuschalten. Einige Richtlinien haben zusätzliche Optionen, z.B. könnte die Richtlinie
			<guimenu>Aktiviere Mail-Quota</guimenu> eine zusätzliche Option mitbringen um die
			Speichermenge zu verwalten.
		  </para>

		  <para>
			<figure><title>Bearbeiten einer Richtlinie</title>
			<graphic scalefit="1" width="80%" fileref="illustrations/gpo-edit-policy-de.png"/>
			</figure>
		  </para>

		  <para>
			Zwei Standard-Richtlinienobjekte sind vordefiniert:

			<itemizedlist>
			  <listitem><simpara>
				Das <emphasis>Default Domain Policy</emphasis> Objekt kann verwendet werden, um globale
				Richtlinien für alle Benutzer und Rechner der gesamten Domäne zu konfigurieren.
			  </simpara></listitem>

			  <listitem><simpara>
				Das <emphasis>Default Domain Controllers Policy</emphasis> Objekt hat in einer Samba-Domäne
				keine Verwendung (in einer Microsoft AD-Domäne würden die Richtlinien für
				Microsoft-Domänencontroller über dieses Objekt erfolgen). Die Konfiguration der
				Samba-Domänencontroller erfolgt in UCS weitgehend über &ucsUCR;.
			  </simpara></listitem>
			</itemizedlist>
		  </para>

		  <para>
			AD-Domänen können in Sites strukturiert werden. Dies kann z.B. verwendet werden um
			Standorte in einer Domäne zu gruppieren. Im Hauptmenü der Gruppenrichtlinienverwaltung
			werden alle Sites aufgeführt. Dort findet sich auch eine Liste von Domänen. Die
			aktuellen Samba-Versionen unterstützen keine Forest-Domänen, so dass hier immer nur eine
			Domäne angezeigt wird.
		  </para>

		  <para>
			Eine Domäne kann in verschiedene Organisations-Einheiten (OUs) strukturiert werden. Dies kann z.B. verwendet
			werden, um die Mitarbeiter der Buchhaltung und die Benutzer der Verwaltung in
			unterschiedlichen LDAP-Positionen zu speichern.
		  </para>

		  <para>
			Gruppenrichtlinien können sich gegenseitig überlagern. Es gilt das Prinzip der
			Vererbung, d.h. höherliegende Richtlinien überschreiben die untergeordneten. Die
			effektiven Richtlinien für einen Benutzer können sowohl mit dem Modellierungsassistenten
			der Gruppenrichtlinienverwaltung als auch an der Windows-Kommandozeile mit dem Befehl
			<command>gpresult /user BENUTZERNAME /v </command> auf dem Windows-Client angezeigt
			werden:
		  </para>

		  <para>
			<figure><title>Auswertung der GPO für den Benutzer user01</title>
			<graphic scalefit="1" width="80%" fileref="illustrations/gpo-gpresult-de.png"/>
			</figure>
		  </para>

		  <para>
			Die Richtlinien werden in folgender Reihenfolge ausgewertet:

			<itemizedlist>
			  <listitem><simpara>
				Richtlinien der <emphasis>Default Domain Policy</emphasis> gelten als
				Grundeinstellung für alle Benutzer und Rechner der gesamten Domäne.
			  </simpara></listitem>

			  <listitem><simpara>
				Mit einer OU verknüpfte Richtlinien überschreiben Richtlinien aus der Default Domain
				Policy. Sind OUs weiter verschachtelt, greifen im Konfliktfall die jeweils "untersten"
				Richtlinien, d.h. die, die näher am Zielobjekt verknüpft sind. Es gilt folgende
				Auswertungsreihenfolge:

				<itemizedlist>
				  <listitem><simpara>
					Zuweisung einer Richtlinie zu einer Active Directory-Site
				  </simpara></listitem>

				  <listitem><simpara>
					Vorgaben der Default Domain Policy
				  </simpara></listitem>

				  <listitem><simpara>
					Zuweisung einer Richtlinie zu einer Organisationseinheit / OU (jede
					unterliegende OU überstimmt wiederum Richtlinien aus übergeordneten OUs)
				  </simpara></listitem>
				</itemizedlist>
			  </simpara></listitem>
			</itemizedlist>
		  </para>

		  <para>
			Ein Beispiel: Eine Firma verbietet allgemein den Zugriff auf den Windows Task
			Manager. Dazu wird im <emphasis>Default Domain Policy</emphasis>-Objekt die Richtlinie
			<guimenu>Zugriff auf Task Manager unterbinden</guimenu> aktiviert. Für einige technisch
			versiertere Benutzer soll der Task Manager dennoch verfügbar sein. Diese Benutzer sind
			in der OU <emphasis>Technik</emphasis> abgelegt. Nun wird ein zusätzliches
			Gruppenrichtlinienobjekt angelegt, in dem Richtlinie <guimenu>Zugriff auf Task Manager
			unterbinden</guimenu> auf <emphasis>deaktiviert</emphasis> gesetzt wird. Dieses neue GPO
			wird mit der OU <emphasis>Technik</emphasis> verbunden.
		  </para>

		</section>

		<section id="gpo:gposync">
		  <title>Konfiguration von Gruppenrichtlinien in Umgebungen mit mehr als einem
		  Samba-Domänencontroller</title>
		  <para>
			Eine Gruppenrichtlinie besteht technisch aus zwei Teilen: Zum einen gibt es ein
			Verzeichnis im Dateisystem der Domänencontroller, das die eigentlichen
			Richtlinien-Dateien enthält, die auf dem Windows-System umgesetzt werden sollen
			(gespeichert in der SYSVOL-Freigabe (siehe <xref linkend="windows:sysvolshare"/>)).
			Zum anderen gibt es ein gleichnamiges Objekt im LDAP-Baum des Samba-Verzeichnisdienstes
			(Samba DS/AD), das üblicherweise unter einem LDAP-Container namens <emphasis>Group
			Policy Objects</emphasis> abgelegt ist.
		  </para>

		  <para>
			Während die LDAP-Replikation zwischen Domänencontrollern innerhalb weniger Sekunden
			umgesetzt ist, werden die Dateien in der SYSVOL-Freigabe in der Grundeinstellung nur alle fünf Minuten
			repliziert. Es ist zu beachten, dass die Anwendung von neu konfigurierten
			Gruppenrichtlinien in diesem Zeitraum fehlschlagen kann, falls ein Client zufällig einen
			Domänencontroller konsultiert, der noch nicht die aktuellen Dateien zu sich repliziert
			hat.
		  </para>
		</section>

		<section id="gpo:adm">
		  <title>Administrative Vorlagen (ADMX/ADM)</title>
		  <para>
			Die in der Gruppenrichtlinienverwaltung angezeigten Richtlinien können durch sogenannte <emphasis>Administrative
			Vorlagen</emphasis> erweitert werden. In einer solchen Vorlage wird definiert unter
			welchem Namen die Richtlinie in der Gruppenrichtlinienverwaltung erscheinen soll und welcher
			Wert dadurch in der Windows-Registry gesetzt wird. Administrative Vorlagen werden in
			sogenannten <emphasis>ADMX-Dateien</emphasis> (früher <emphasis>ADM-Dateien</emphasis>)
			gespeichert <biblioref linkend="admx-reference"/>. ADMX-Dateien bieten unter anderem
			den Vorteil, dass sie zentral über mehrere Domänencontroller bereitgestellt werden können, damit
			die Gruppenrichtlinienverwaltung an allen Windows-Clients die gleichen
			Konfigurationsmöglichkeiten zeigt <biblioref linkend="admx-central"/>.
		  </para>

		  <para>
			Das folgende Beispiel für eine ADM-Datei definiert eine Rechner-Richtlinie, in der ein
			Registry-Key des (fiktiven) Univention RDP-Client konfiguriert wird.
			ADM-Dateien können über Third-Party-Werkzeuge in das neuere ADMX-Format umgewandelt werden.
			Weiterführende Informationen zum Format von ADM-Dateien sind unter <biblioref
			linkend="microsoft-adm-templates"/> und <biblioref linkend="adm-templates-howto"/> zu
			finden. Die administrativen Vorlagen müssen die Dateiendung <emphasis>.adm</emphasis> verwenden:

			<programlisting language="sh">
CLASS MACHINE
CATEGORY "Univention"
POLICY "RDP-Client"
KEYNAME "Univention\RDP\StorageRedirect"
EXPLAIN "Ist diese Option aktiviert, wird Soundausgabe im RDP-Client aktiviert"
VALUENAME "Sound-Weiterleitung"
VALUEON "Aktiviert"
VALUEOFF "Deaktiviert"
END POLICY
END CATEGORY
			</programlisting>
		  </para>

		  <para>
			<figure><title>Die eingebundene administrative Vorlage</title>
			<graphic scalefit="1" width="80%" fileref="illustrations/gpo-adm-template-de.png"/>
			</figure>
		  </para>

		  <para>
			Die ADM-Datei kann anschließend in das ADMX-Format umgewandelt oder aber direkt über die Gruppenrichtlinienverwaltung importiert
			werden. Dazu wird im Kontextmenü der <guimenu>Administrativen Vorlagen</guimenu> die
			Option <guimenu>Vorlagen hinzufügen/entfernen</guimenu> aufgerufen. Mit
			<guimenu>Hinzufügen</guimenu> kann dann eine ADM-Datei importiert werden. Die
			administrativen Vorlagen werden ebenfalls in der SYSVOL-Freigabe gespeichert und
			repliziert, wodurch die Gruppenrichtlinienverwaltung von den Windows-Clients aus auf sie zugreifen kann.
		  </para>
		</section>

		<section id="gpo:wmifilter">
		  <title>Anwendung von Richtlinien auf Basis von Rechnereigenschaften (WMI-Filter)</title>
		  <para>
			Richtlinien können auch auf Basis von Systemeigenschaften konfiguriert werden. Diese
			Eigenschaften werden über die Windows Management Instrumentation-Schnittstelle (WMI)
			bereitgestellt. Der darauf aufbauende Mechanismus wird als <emphasis>WMI-Filterung</emphasis> bezeichnet.
			Damit ist es beispielsweise möglich eine Richtlinie nur auf PCs mit einer 64
			Bit-Prozessor-Architektur oder mit min. 8 GB RAM anzuwenden. Ändert sich eine
			Eigenschaft eines Systems (z.B. weil mehr Speicher eingebaut wurde), wird der jeweilige
			Filter automatisch vom Client neu ausgewertet.
		  </para>

		  <para>
			Die WMI-Filter werden in der Domänenstruktur im Container <guimenu>WMI-Filter</guimenu>
			angezeigt. Mit <guimenu>Neu</guimenu> kann ein weiterer Filter definiert werden. Unter
			<guimenu>Abfragen</guimenu> werden die Filterregeln definiert. Die Regeln werden in
			einer SQL-ähnlichen Syntax definiert. Regel-Beispiele finden sich in <biblioref
			linkend="microsoft-wmi-filter"/> und  <biblioref linkend="add-wmi-filters"/>.
		  </para>

		</section>

	  </section>

	  <section id="netlogon-freigabe:samba4">
		<title>Anmeldeskripte / NETLOGON-Freigabe</title>
		<para>
		  Die NETLOGON-Freigabe dient der Bereitstellung von Anmeldeskripten in Windows-Domänen. Die
		  Anmeldeskripte werden nach der erfolgreichen Anmeldung eines Benutzers ausgeführt und
		  ermöglichen die Anpassung der Arbeitsumgebung des Benutzers. Die Skripte müssen in einem
		  für Windows ausführbaren Format gespeichert werden, wie z.B. <emphasis>bat</emphasis>.
		</para>

		<para>
		  Die Anmeldeskripte werden unter
		  <filename>/var/lib/samba/sysvol/&lt;Domänenname&gt;/scripts/</filename> abgelegt und
		  werden unter dem Freigabennamen <emphasis>NETLOGON</emphasis> bereitgestellt. Die
		  NETLOGON-Freigabe wird im Rahmen der SYSVOL-Replikation repliziert.
		</para>

		<para>
		  Um ein globales Anmeldeskript für alle Benutzer zu definieren, steht die &ucsUCRV;
		  <envar>samba/logonscript</envar> zur Verfügung. Ist diese Variable auf einem Samba-Server
		  gesetzt, wird allen Benutzern, die sich an diesem Samba-Server anmelden, standardmäßig das
		  dort angegebene Anmeldeskript zugeordnet. Das Anmeldeskript kann auch benutzerspezifisch
		  zugewiesen werden, siehe <xref linkend="users::management"/>.
		</para>
	  </section>


	  <section id="windows:serverhome:samba4">
		<title>Konfiguration des Servers, auf dem das Heimatverzeichnis abgelegt wird</title>

		<para>
		  Das Heimatverzeichnis wird benutzerbezogen in der &ucsUMC; definiert siehe <xref
		  linkend="users::management"/>. Dies erfolgt mit der Einstellung
		  <guimenu>Windows-Heimatverzeichnis</guimenu>,
		  z.B. <emphasis>\\ucs-file-server\meier</emphasis>.
		</para>

		<para>
		  Für das Zuweisen des Heimatverzeichnis-Servers an mehrere Benutzer auf einmal kann der
		  Mehrfachbearbeitungsmodus der &ucsUMC; verwendet  werden, siehe <xref
		  linkend="central:user-interface:edit"/>.
		</para>
	  </section>


	  <section id="windows:roamingprofiles:samba4">
		<title>Servergespeicherte Profile</title>

		<para>
		  Samba unterstützt servergespeicherte Profile, d.h. Einstellungen der Benutzer werden auf
		  einem Server gespeichert. In diesem Verzeichnis werden auch die Dateien gespeichert, die
		  der Benutzer im Ordner <emphasis>Eigene Dateien</emphasis> speichert. Sie werden
		  zwischenzeitlich lokal auf dem Windows-Rechner vorgehalten und erst bei der Abmeldung auf
		  den Samba-Server synchronisiert.
		</para>

		<para>
		  Wird der Profilpfad in der &ucsUMC; geändert, wird ein neues Profilverzeichnis
		  angelegt. Die Daten aus dem alten Profilverzeichnis bleiben dabei erhalten und können
		  manuell in das neue Profilverzeichnis kopiert beziehungsweise verschoben
		  werden. Abschließend kann das alte Profilverzeichnis gelöscht werden.
		</para>

		<para>
		  In Samba-Domänen mit Active Directory-Support werden in der Voreinstellung keine
		  serverseitigen Profile verwendet.
		</para>

		<para>
		  Das Profilverzeichnis kann über eine Gruppenrichtlinie konfiguriert werden, die unter
		  <guimenu>Computerkonfiguration &ar; Richtlinien &ar; Administrative Vorlagen &ar; System
		  &ar; Benutzerprofile &ar; Pfad des servergespeicherten Profils für alle Benutzer
		  festlegen</guimenu> zu finden ist.
		</para>

		<note>
		  <para>
			Der Administrator-Benutzer greift standardmäßig mit root-Berechtigungen auf Freigaben
			zu. Wenn dadurch das Profilverzeichnis mit root als Benutzer angelegt wird, sollte es
			manuell mit dem Befehl <command>chown</command> an den Administrator vergeben werden.
		  </para>
		</note>
	  </section>
	</section>

  </section>





  


  <section id="windows:ntdomain">
	<title>Betrieb einer Samba-Domäne auf Basis von NT-Domänendiensten</title>

	<section id="windows:ntsetup">
	  <title>Bestandteile einer Samba-Domäne</title>

	  <para>
		NT-Domänen sind der technische Vorgänger von Active Directory. Dieses Kapitel ist vor allem
		für Bestandsinstallationen relevant, die noch keine Migration auf eine AD-basierte Domäne
		durchgeführt haben. Die Migration von einer Samba-Domäne auf NT-Basis zu einer Domäne mit
		Active Directory-Diensten ist im Univention Wiki <biblioref linkend="wiki-samba-update"/>
		beschrieben. Für Neuinstallationen wird die Verwendung einer AD-basierten Domäne empfohlen.
	  </para>

	  <para>
		Eine Samba-NT-Domäne besteht aus min. einem Domänencontroller. Windows-Clients und Memberserver
		können als Domänenmitglieder dem Vertrauenskontext der Samba-Domäne beitreten. Memberserver
		stellen keine Anmeldedienste bereit, bieten aber beispielsweise Datei- oder Druckdienste
		an. Neben dem Domänenbeitritt als Memberserver von Windows Server-Systemen kann auch Samba
		als Memberserver arbeiten.
	  </para>

	  <para>
		Der Domänenbeitritt von Windows-Clients und Microsoft Windows-Memberservern wird in
		<xref linkend="windows-domaenenbeitritt"/> beschrieben.
	  </para>

	  <para>
		Microsoft Windows-Domänencontroller können nicht einer UCS-Samba-Domäne beitreten.
	  </para>

	</section>

	<section id="windows:setup3">
	  <title>Installation</title>

	  <para>
		Samba als NT-Domänencontroller kann auf allen UCS-Domänencontrollern mit der Applikation
		<emphasis>Windows-NT-kompatibler Domänencontroller</emphasis> aus dem Univention App Center
		installiert werden. Alternativ kann das Softwarepaket <package>univention-samba</package>
		installiert werden (anschließend muss der Befehl <command>univention-run-join-scripts</command>
		aufgerufen werden). Weitere Informationen finden sich in <xref
		linkend="computers::softwaremanagement::installsoftware"/>.
	  </para>

	  <para>
		Ein Samba-Memberserver kann auf UCS-Memberservern mit der Applikation
		<emphasis>Windows-kompatibler Fileserver auf der Basis von Samba 3</emphasis> aus dem Univention App Center
		installiert werden. Alternativ kann das Softwarepaket <package>univention-samba</package> 
		installiert werden (anschließend muss der Befehl
		<command>univention-run-join-scripts</command> aufgerufen werden). Weitere Informationen finden
		sich in <xref linkend="computers::softwaremanagement::installsoftware"/>.
	  </para>
	</section>

	<section id="windows:samba3:services">
	  <title>Dienste einer Samba-Domäne</title>

	  <section id="windows:samba3:services:auth">
		<title>Authentifizierungsdienst</title>

		<para>
		  Benutzeranmeldungen können nur auf Microsoft Windows-Systemen  erfolgen, die der
		  Samba-Domäne beigetreten sind. Der Domänenbeitritt  ist in <xref
		  linkend="windows-domaenenbeitritt"/> dokumentiert.
		</para>

		<para>
		  Die Benutzerkennwörter werden im UCS-LDAP gespeichert. Benutzer werden bei der
		  Domänenanmeldung mit Benutzernamen und Passwort gegen das LDAP-Verzeichnis authentifiziert
		  und können dann auf alle freigegebenen Ressourcen der Domäne zugreifen ohne Benutzernamen
		  und Passwort erneut eingeben zu müssen. Rechner mit jeglicher Art von
		  Windows-Betriebssystem werden wie in Windows NT-Domänen über das NTLMv2-Protokoll
		  authentifiziert.
		</para>
	  </section>


	  <section id="windows:samba3:fileservices">
		<title>Dateidienste / File-Server</title>

		<para>
		  Ein Dateiserver stellt zentral benötigte Dateien über das Netz bereit und ermöglicht es
		  unter anderem Benutzerdaten auf einem zentralen Server zu bündeln.
		</para>

		<para>
		  Die in UCS integrierten Dateidienste unterstützen eine Bereitstellung von Freigaben auf
		  Basis von CIFS/SMB (siehe <xref linkend="shares::general"/>). Sofern das unterliegende
		  Dateisystem Access Control Lists (ACLs) unterstützt (verwendbar bei ext3, ext4 und XFS)
		  sind ACLs auch von Windows-Clients verwendbar.
		</para>

		<para>
		  Samba unterstützt das CIFS-Protokoll und den Nachfolger SMB2. Verwendet man einen Client,
		  der SMB2 unterstützt (ab Windows Vista, also auch Windows 7/8), verbessert sich die
		  Performance und die Skalierbarkeit.
		</para>

		<para>
		  Das Protokoll kann über die &ucsUCR;-Variable <envar>samba/max/protocol</envar>
		  konfiguriert werden. Sie muss auf allen Samba-Servern gesetzt und anschließend der/die
		  Samba-Server neu gestartet werden.

		  <itemizedlist>
			<listitem><simpara>
			  <emphasis>NT1</emphasis> konfiguriert CIFS (unterstützt von allen Windows-Versionen)
			</simpara></listitem>

			<listitem><simpara>
			  <emphasis>SMB2</emphasis> konfiguriert SMB2 (unterstützt ab Windows Vista/Windows 7)
			</simpara></listitem>
			
			<listitem><simpara>
			  <emphasis>SMB3</emphasis> konfiguriert SMB3 (unterstützt ab Windows 8) (aktuell nicht durch Univention-Support abgedeckt)
			</simpara></listitem>
		  </itemizedlist>
		</para>
	  </section>


	  <section id="windows:samba3:services:print">
		<title>Druckdienste / Print-Server</title>
		<para>
		  Samba bietet die Möglichkeit, unter Linux eingerichtete Drucker als Netzwerkdrucker für
		  Windows-Clients freizugeben. Die Verwaltung der Druckerfreigaben und die Integration der
		  Druckertreiber ist in <xref linkend="print::general"/> beschrieben.
		</para>
	  </section>
	  

	  <section id="windows:netbios">
		<title>NetBIOS-Netzwerkdienst</title>

		<para>
		  NetBIOS ist ein Netzwerkprotokoll zur Namensauflösung und Netzwerkkommunikation von
		  Windows-Clients. Es wird primär für NT-kompatible Domänen verwendet; die Namensauflösung
		  in Active Directory-Domänen erfolgt über DNS. Samba bildet NetBIOS-Funktionalität durch
		  den Systemdienst <emphasis>nmbd</emphasis> ab.
		</para>

		<para>
		  NetBIOS-Rechnernamen können maximal 13 Zeichen umfassen. Der NetBIOS-Name eines
		  UCS-Systems entspricht standardmäßig dem Rechnernamen.
		</para>
	  </section>


	  <section id="windows:wins">
		<title>Namensauflösung über WINS</title>

		<para>
		  Der <emphasis>Windows Internet Name Service (WINS)</emphasis> ist ein Dienst zur Auflösung
		  von NetBIOS-Namen in IP-Adressen ähnlich DNS in TCP/IP-Netzwerken. Außerdem stellt WINS
		  Informationen über die Aufgaben der Rechner bereit.
		</para>

		<para>
		  WINS wird in NT-kompatiblen Samba-Domänen verwendet, in Samba-AD-Domänen erfolgt die
		  Namensauflösung primär über DNS (WINS ist dort ebenfalls verfügbar).
		</para>

		<para>
		  WINS-Unterstützung ist in der Grundeinstellung auf dem &ucsMaster; aktiviert und kann mit
		  der &ucsUCRV; <envar>windows/wins-support</envar> auch auf einem anderen Server in Betrieb
		  genommen werden. WINS kann ohne Anpassungen nur auf jeweils einem Samba-Server der Domäne
		  betrieben werden, die Verteilung auf mehrere Server erfordert die Einrichtung von
		  WINS-Replikation. Informationen zur Inbetriebnahme der WINS-Replikation finden sich in der
		  Univention Support Datenbank unter <xref linkend="sdb-winsrepl"/>.
		</para>

		<para>
		  Der WINS-Server kann Windows-Clients in der &ucsUMC; über eine DHCP-NetBIOS-Richtlinie
		  zugewiesen werden, siehe <xref linkend="networks:dhcp:wins"/>.
		</para>
	  </section>
	</section>


	<section id="windows:samba3:desktopmanagement">
	  <title>Konfiguration und Management von Windows-Desktops</title>

	  <section id="netlogon-freigabe:samba3">
		<title>Anmeldeskripte / NETLOGON-Freigabe</title>
		<para>
		  Die NETLOGON-Freigabe dient der Bereitstellung von Anmeldeskripten in Windows-Domänen. Die
		  Anmeldeskripte werden nach der erfolgreichen Anmeldung eines Benutzers ausgeführt und
		  ermöglichen die Anpassung der Arbeitsumgebung des Benutzers. Die Skripte müssen in einem
		  für Windows ausführbaren Format gespeichert werden, wie z.B. <emphasis>bat</emphasis>.
		</para>

		<para>
		  Standardmäßig ist das Verzeichnis <filename>/var/lib/samba/netlogon</filename> als
		  Samba-Freigabe <emphasis>NETLOGON</emphasis> eingerichtet.
		</para>

		<para>
		  In der Grundeinstellung werden alle Anpassungen im Verzeichnis
		  <filename>/var/lib/samba/netlogon</filename> auf dem &ucsMaster; vorgenommen und stündlich
		  mit dem <emphasis>rsync</emphasis>-Tool auf alle Domänencontroller mit installiertem Samba
		  synchronisiert.
		</para>

		<para>
		  Um ein globales Anmeldeskript für alle Benutzer zu definieren, steht die &ucsUCRV;
		  <envar>samba/logonscript</envar> zur Verfügung. Ist diese Variable auf einem Samba-Server
		  gesetzt, wird allen Benutzern, die sich an diesem Samba-Server anmelden, standardmäßig das dort
		  angegebene Anmeldeskript zugeordnet. Das Anmeldeskript kann auch benutzerspezifisch zugewiesen
		  werden, siehe <xref linkend="users::management"/>.
		</para>
	  </section>

	  <section id="windows:serverhome:samba3">
		<title>Konfiguration des Servers, auf dem das Heimatverzeichnis abgelegt wird</title>

		<para>
		  Das Heimatverzeichnis eines Benutzers wird durch Samba freigegeben und nach der Anmeldung
		  unter Windows in der Grundeinstellung mit dem Laufwerk <emphasis>I:</emphasis> verbunden.
		</para>

		<para>
		  Mit der &ucsUCRV; <envar>samba/homedirserver</envar> kann der Server festgelegt werden,
		  auf dem die Heimatverzeichnisse vorgehalten werden, mit der &ucsUCRV;
		  <envar>samba/homedirpath</envar> kann das Verzeichnis vorgegeben werden. Diese Werte
		  gelten dann für alle Benutzer.
		</para>

		<para>
		  Sie können aber in den Benutzereinstellungen - siehe <xref linkend="users::management"/> -
		  mit der Einstellung <guimenu>Windows-Heimatverzeichnis</guimenu> auch individuell
		  zugewiesen werden, z.B. <emphasis>\\ucs-file-server\meier</emphasis>.
		</para>

		<para>
		  Wenn anstelle des UNIX-Heimatverzeichnisses des Benutzers ein anderes UNIX-Verzeichnis auf
		  dem Windows-Laufwerk für das Heimatverzeichnis angezeigt werden soll, muss dieser Server
		  und das Verzeichnis in das Eingabefeld <guimenu>Windows-Heimatverzeichnis</guimenu>
		  eingetragen werden.
		</para>
	  </section>

	  <section id="windows:roamingprofiles:samba3">
		<title>Servergespeicherte Profile</title>

		<para>
		  Samba unterstützt servergespeicherte Profile, d.h. Einstellungen der Benutzer werden auf
		  einem Server gespeichert. In diesem Verzeichnis werden auch die Dateien gespeichert, die
		  der Benutzer im Ordner <emphasis>Eigene Dateien</emphasis> speichert. Sie werden
		  zwischenzeitlich lokal auf dem Windows-Rechner vorgehalten und erst bei der Abmeldung auf
		  den Samba-Server synchronisiert.
		</para>

		<para>
		  Wird der Profilpfad in der &ucsUMC; geändert, wird ein neues Profilverzeichnis
		  angelegt. Die Daten aus dem alten Profilverzeichnis bleiben dabei erhalten und können
		  manuell in das neue Profilverzeichnis kopiert beziehungsweise verschoben
		  werden. Abschließend kann das alte Profilverzeichnis gelöscht werden.
		</para>

		<para>
		  Die Benutzerprofile werden standardmäßig im Unterverzeichnis <filename>windows-profiles\
		  &lt;Windows-Version&gt;</filename> auf dem Samba-Server gespeichert, an dem sich der
		  Benutzer angemeldet hat.
		</para>

		<para>
		  Mit der &ucsUCRV; <envar>samba/profileserver</envar> kann ein anderer Server und mit
		  <envar>samba/profilepath</envar> ein anderes Verzeichnis festgelegt werden. Diese
		  Einstellungen müssen auf allen Samba-Domänencontrollern gesetzt werden.
		</para>

		<para>
		  In der Benutzerverwaltung der &ucsUMC; kann mit der Einstellung
		  <guimenu>Profilverzeichnis</guimenu> ein abweichender Pfad oder ein anderer Server für das
		  Profilverzeichnis für den Benutzer konfiguriert werden.
		</para>

		<para>
		  Durch Konfiguration der &ucsUCR;-Variablen <envar>samba/profilepath</envar> und
		  <envar>samba/profileserver</envar> auf <emphasis>local</emphasis> und Neustart des
		  Samba-Servers können servergespeicherten Profile deaktiviert werden. Die UMC-Einstellung
		  aus dem Eingabefeld <guimenu>Profilverzeichnis</guimenu> muss dann ebenfalls leer gesetzt sein.
		</para>
	  </section>
	</section>

	<section id="vertrauensstellungen_generell">
	  <title>Vertrauensstellungen</title>
	  <para>
		Vertrauensstellungen zwischen Domänen ermöglichen es den Benutzern
		einer Domäne, sich an Rechnern einer anderen Domäne anzumelden.
	  </para>

	  <para>
		Vertrauensstellungen werden in auf Active Directory basierenden Samba-Domänen nicht
		unterstützt.
	  </para>

	  <para>
		Vertraut eine Windows-Domäne einer Samba-Domäne, steht bei der Anmeldung an Rechnern der
		Windows-Domäne neben der Windows-Domäne auch die Samba-Domäne zur Auswahl.
	  </para>

	  <para>
		Vertraut eine Samba-Domäne einer Windows-Domäne, geben die Benutzer der Windows-Domäne bei
		der Anmeldung an einem Linux-Rechner als Benutzernamen <emphasis>Name der
		Windows-Domäne>+&lt;Benutzername&gt;</emphasis> ein.
	  </para>

	  <para>
		Während der Einrichtung und Nutzung von Vertrauensstellungen müssen sich die
		Domänencontroller der beiden Domänen über das Netzwerk erreichen und per Broadcast oder WINS
		gegenseitig identifizieren können.
	  </para>

	  <para>
		Vertrauensstellungen müssen generell in zwei Schritten angelegt werden:

		<itemizedlist>
		  <listitem><simpara>
			In der "vertrauten" Domäne muss ein Konto für die Vertrauenstellung eingerichtet werden
			(Domain Trust Account).
		  </simpara></listitem>

		  <listitem><simpara>
			In der "vertrauenden" Domäne muss eine Vertrauensstellung eingerichtet werden, in dem
			auf einem Domänencontroller (Microsoft Windows oder Samba) der vertrauenden Domäne ein
			Tool zur Einrichtung einer Vertrauensstellung als Benutzer mit administrativen Rechten
			aufgerufen wird. Dort wird eine in der Microsoft-Terminologie als "ausgehend" bezeichnete
			Vertrauensstellung eingerichtet und Benutzername/Passwort für den Trust Account der
			vertrauten Domäne konfiguriert. Über den Trust Account führt die vertrauende Domäne
			Namensauflösungen in der vertrauten Domäne durch.
		  </simpara></listitem>
		</itemizedlist>
	  </para>

	  <para>
		Vertrauensstellungen können unidirektional oder bidirektional eingerichtet werden. Technisch
		entspricht eine bidirektionale Vertrauensstellung zwei unidirektional konfigurierten
		Vertrauensstellungen in beide Richtungen.
	  </para>

	  <para>
		Die Terminologie von Vertrauensstellungen hängt von der Perspektive der vertrauenden oder
		der vertrauten Domäne ab: Aus Sicht der vertrauenden Domäne ist die Vertrauensstellung
		ausgehend und aus Sicht der vertrauten Domäne eingehend.
	  </para>

	  <para>
		Weitere Informationen zur Konfiguration von Vertrauensstellungen unter Microsoft Windows
		findet sich in <xref linkend="windows-trust"/>.
	  </para>


	  <section id="windows:trustdom:windows-trusts-samba">
		<title>Windows-Domäne vertraut Samba-Domäne</title>

		<para>
		  In der Rechnerverwaltung der &ucsUMC; muss ein <emphasis>Domain Trust Account</emphasis>
		  angelegt werden, dessen Name dem NetBIOS-Namen der Windows-Domäne entspricht, und ein
		  Passwort für das Konto vergeben werden. Die möglicherweise in der Windows-Domäne geltenden
		  Anforderungen an sichere Passwörter sind dabei zu beachten.
		</para>

		<para>
		  Auf dem Windows-PDC muss eine ausgehende Vertrauensstellung angelegt werden.
		</para>

		<para>
		  Die Vertrauensstellung der Windows-Domäne zur Samba-Domäne kann durch Löschung der
		  Vertrauensstellung auf dem Windows-PDC und des Domain Trust Accounts in der &ucsUMC;
		  wieder aufgehoben werden.
		</para>
	  </section>

	  <section id="windows:trustdom:samba-trusts-windows">
		<title>Samba-3-Domäne vertraut Windows-Domäne</title>
		<para>
		  Mit den folgenden Schritten wird die Vertrauensstellung auf einem &ucsSlave; als Benutzer
		  <emphasis>root</emphasis> eingerichtet:
		</para>

		<para>
		  Vertrauensstellungen können nur auf Domänencontrollern eingerichtet werden.
		</para>

		<para>
		  Das Paket <package>winbind</package> muss installiert werden. Winbind ordnet
		  Windows-Benutzer- und Gruppennamen UNIX-IDs zu.
		</para>

		<para>
		  Auf dem Windows-PDC muss nun eine eingehende Vertrauensstellung angelegt werden.
		</para>

		<para>
		  Wird Univention Firewall verwendet, müssen Antworten auf NetBIOS-Broadcasts zugelassen werden:
		</para>

		<programlisting language="sh">
echo "iptables -I INPUT 1 -p udp --sport 137 -j ACCEPT" \
    &gt;&gt; /etc/security/packetfilter.d/50_local.sh
/etc/init.d/univention-firewall restart
		</programlisting>

		<para>
		  Nun wird die Vertrauensstellung initiiert und Winbind neu gestartet. Dies muss auf allen
		  Samba-Anmeldeservern ausgeführt werden.
		</para>

		<programlisting language="sh">
net rpc trustdom establish &lt;Windowsdomain&gt;
net setauthuser -UAdministrator (das Administrator-Passwort in Windows wird benötigt)
ucr set samba/winbind/rpc/only=yes
/etc/init.d/winbind restart
ucr set auth/methods="krb5 ldap unix winbind"
/etc/init.d/nscd restart
		</programlisting>

		<para>
		  Mit folgendem Befehl kann geprüft werden, ob die Vertrauensstellung korrekt hinzugefügt
		  wurde:
		</para>

		<programlisting language="sh">
	  net rpc trustdom list
		</programlisting>
	  </section>
	</section>
  </section>






<section id="ad-connector:general">
  <title>Active Directory-Verbindung</title>
  
  <section id="ad-connector:einfuehrung">
	<title>Einführung</title>

	<para>
	  &ucsUCS; kann auf zwei unterschiedliche Arten mit einer bestehenden Active Directory (AD) Domäne zusammen
	  betrieben werden.
	  Beide Varianten lassen sich durch die App <emphasis>Active Directory-Verbindung</emphasis>
	  auf einem &ucsUCS; Master konfigurieren.
	</para>

	<para>
	  Die beiden Varianten sind:
	  <itemizedlist>
	    <listitem><simpara>
	      UCS als Teil (Domänen-Mitglied) einer AD-Domäne (<emphasis>AD member</emphasis>-Modus, siehe <xref linkend="ad-connector:ad-member-einrichtung"/>)
	    </simpara></listitem>
	    <listitem><simpara>
	      Synchronisation von Kontendaten zwischen einer AD-Domäne und einer UCS-Domäne (siehe <xref linkend="ad-connector:ad-connector-einrichtung"/>)
	    </simpara></listitem>
	  </itemizedlist>
	</para>
	  
	<para>
	  In beiden Modi wird unter UCS der Active Directory-Verbindungsdienst verwendet (kurz UCS AD-Connector), der Verzeichnisdienstobjekte zwischen einem
	  Windows 2003/2008/2012-Server mit Active Directory (AD) und dem OpenLDAP-Verzeichnis aus &ucsUCS; synchronisieren kann.
	  Der Connector kann auch mehrere AD-Domänen mit einer UCS-Domäne synchronisieren;
	  dies ist in <xref linkend="ext-doc-win"/> dokumentiert.
	</para>

	<para>
	  Im ersten Fall, der Konfiguration eines UCS-Serversystems als Mitglied einer
      AD-Domäne (<emphasis>AD member</emphasis>-Modus), dient das AD als führender Verzeichnisdienst
	  und das jeweilige UCS-System tritt dem Vertrauenskontext der AD-Domäne
	  bei.
      Durch die Domänenmitgliedschaft hat das UCS-System limitierten Zugriff auf Kontodaten der Active
	  Directory-Domäne, die es über den UCS AD-Connector aus dem AD
	  ausliest und lokal in den eigenen OpenLDAP-basierten Verzeichnisdienst schreibt.
	  In dieser Konfiguration schreibt der UCS AD-Connector keine Änderungen
	  in das AD. Ohne Installation eines zusätzlichen priviligierten Passwortdienstes auf
	  dem AD-Domänencontroller hat es auch keine Möglichkeit, die verschlüsselten Passwortdaten
	  von AD-Benutzern und -Computern auszulesen.
	</para>

	<para>
	  Dieser Modus, in dem UCS als Mitglied einer AD-Domäne betrieben wird, eignet sich,
	  um eine AD-Domäne um Applikationen zu erweitern, die auf der UCS-Plattform zur
	  Verfügung stehen. Auf der UCS-Plattform installierte Apps sind dann für Benutzer der
	  AD-Domäne nutzbar. Die Authentifikation erfolgt dabei weiter gegen native
	  Microsoft AD Domänencontroller. Die Einrichtung dieses Betriebsmodus ist im Detail in Abschnitt <xref linkend="ad-connector:ad-member-einrichtung"/> beschrieben.
	</para>

	<para>
	  Der zweite Modus, der sich über die App <emphasis>Active Directory-Verbindung</emphasis>
	  konfigurieren lässt, dient dazu, die UCS Domäne parallel zu einer bestehenden AD-Domäne
	  zu betreiben. In diesem Modus ist jedem Domänen-Benutzer sowohl in der UCS als auch
	  in der AD-Domäne ein gleichnamiges Benutzerkonto zugeordnet. Durch die
	  Namensidentität und die Synchronisation der verschlüsselten Passwortdaten ermöglicht
	  dieser Modus einen transparenten Zugriff zwischen beiden Domänen. Die Authentifikation eines
	  Benutzers in der UCS-Domäne geschieht in diesem Modus direkt innerhalb der UCS-Domäne und ist damit
	  nicht direkt abhängig von der AD-Domäne. Die Einrichtung diese Betriebsmodus ist im Detail in Abschnitt <xref linkend="ad-connector:ad-connector-einrichtung"/> beschrieben.
	</para>

  </section>

  <section id="ad-connector:ad-member-einrichtung">
  <title>UCS als Mitglied einer Active Directory-Domäne</title>

  <para>
	Der Einrichtungsassistent kann mit der Applikation <emphasis>Active Directory-Verbindung</emphasis>
	aus dem Univention App Center installiert werden. Alternativ kann das Softwarepaket
	<package>univention-ad-connector</package> installiert werden. Weitere Informationen finden sich in
	<xref linkend="computers::softwaremanagement::installsoftware"/>.
  </para>

  <para>
	Die Applikation <emphasis>Active Directory-Verbindung</emphasis> kann nur auf einem &ucsMaster; oder &ucsBackup; installiert werden.
  </para>

  <note>
  	<para>
  		Der Betriebsmodus als Teil einer AD-Domäne (<emphasis>AD member</emphasis>-Modus) kann nur auf einem &ucsMaster; konfiguriert werden.
  		Der Name der DNS-Domäne des UCS-Systems muss mit dem der AD-Domäne übereinstimmen.
  		Die Hostnamen selbst müssen natürlich unterschiedlich sein.
  	    Alle AD- und UCS-Server in einer Connector-Umgebung sollten dieselbe Zeitzone verwenden.
	</para>
  </note>

  <para>
	Nach Installation der Applikation <emphasis>Active Directory-Verbindung</emphasis>
	aus dem Univention App Center steht der gleichnamige Einrichtungs-Assistent zur Verfügung.
  </para>

  <para>
    <figure><title>Konfiguration des Betriebsmodus als Teil einer AD-Domäne</title>
      <graphic scalefit="1" width="80%" fileref="illustrations/admember_1-de.png"/>
    </figure>
  </para>

  <para>
	Im ersten Dialog der Einrichtungsassistenten ist der Punkt <emphasis>UCS als Teil einer
	AD-Domäne konfigurieren</emphasis> vorausgewählt
	und kann mit <guimenu>Weiter</guimenu> bestätigt werden.
  </para>

  <para>
	Im nächsten Dialog wird die Adresse eines AD-Domänencontrollers
	sowie der Name des Standard-Administrator-Kontos der AD-Domäne
	und dessen Passwort abgefragt. Hier sollte das Standard-AD-Administratorkonto
	verwendet werden.
	Der angegebene AD-Domänencontroller muss auch DNS-Dienste für
	die Domäne bereitstellen.
    Durch Betätigen der Schaltfläche <guimenu>AD-Domäne beitreten</guimenu> wird der Domänenbeitritt gestartet.
  </para>

  <para>
    <figure><title>Domänenbeitritt zu einer AD-Domäne</title>
      <graphic scalefit="1" width="80%" fileref="illustrations/admember_2-de.png"/>
    </figure>
  </para>

  <para>
    Falls die Systemzeit des UCS-Systems mehr als 5 Minuten gegenüber der Systemzeit des AD-Domänencontrollers vorgeht, ist eine manuelle Angleichung der Systemzeiten notwendig. Dies ist notwendig, da die AD-Kerberos-Infrastruktur zur Authentifizierung verwendet wird.
    Systemzeiten sollten dabei nicht zurückgestellt werden, um Inkonsistenzen zu vermeiden.
  </para>

  <para>
    Der Domänenbeitritt läuft automatisch ab.
    Der abschließende Dialog sollte mit <guimenu>Fertigstellen</guimenu> bestätigt werden. Danach sollte mit einem Klick auf <guimenu>Neustart</guimenu> der UMC-Server neu gestartet werden.
  </para>

  <note>
    <para>
    	Nach Einrichtung des Betriebsmodus als Mitglied der AD-Domäne (<emphasis>AD member</emphasis>-Modus) findet die Authentifikation gegen den AD-Domänencontroller statt. Daher gilt für den Administrator jetzt das Passwort aus der AD-Domäne. Falls einer AD-Domäne mit nicht-englischsprachiger Sprachkonvention beigetreten wurde, dann wird das <emphasis>Administrator</emphasis>-Konto aus UCS während des Domänenbeitritts automatisch in die Schreibweise des AD umbenannt. Gleiches gilt für alle Benutzer- und Gruppenobjekte mit <emphasis>Well Known SID</emphasis> (z.B. <emphasis>Domain Admins</emphasis>).
    </para>
  </note>

  <warning>
    <para>
    	Falls zuvor neben dem &ucsMaster; weitere UCS-Systeme schon Teil der UCS-Domäne waren, dann müssen diese neu der gejoint werden. Dabei erkennen sie, dass der &ucsMaster; sich im <emphasis>AD member</emphasis>-Modus befindet und treten ebenfalls der Authentifikationsstruktur der AD-Domäne bei und können dann z.B. zusätzlich Samba-Dateifreigaben bereitstellen.
    </para>
  </warning>

  <note>
  	<para>
    Da in diesem Modus die AD-Kerberos-Infrastruktur zur Authentifizierung von Benutzern verwendet wird, ist es essenziell, dass die Systemzeiten von UCS und AD-Domänencontroller synchron sind (mit einer Toleranz von 5 Minuten). Zu diesem Zweck ist unter UCS der AD-Domänencontroller als NTP-Zeitserver konfiguriert.
    
    	Im Falle von Authentifikationsproblemen sollte immer als erstes die Systemzeit überprüft werden.
    </para>
  </note>

  <para>
    <figure><title>Administrationsdialog für die Active Directory-Verbindung</title>
      <graphic scalefit="1" width="80%" fileref="illustrations/admember_3-de.png"/>
    </figure>
  </para>

  <para>
    Nach dieser Einrichtung kann das UMC-Modul <emphasis>Active Directory-Verbindung</emphasis> zur weiteren Administration verwendet werden, z.B. um zu prüfen, ob der Dienst läuft und ihn ggf. neu zu starten (siehe <xref linkend="ad-connector:neustart"/>).
  </para>

  <para>
    Um eine verschüsselte Verbindung zwischen Active Directory und &ucsMaster; nicht nur für die Authentifikation, sondern auch für den Datenaustausch an sich zu verwenden, kann auf dem AD-Domänencontroller das Root-Zertifikat der Zertifizierungsstelle exportiert und über das UMC-Modul hochgeladen werden. Weitere Informationen dazu liefert <xref linkend="ad-connector:ad-zertifikat"/>.
  </para>

  <para>
    Per Voreinstellung überträgt die so eingerichtete Active Directory-Verbindung keine Passwortdaten aus AD in den UCS-Verzeichnisdienst. In einigen Szenarien kann es dennoch sinnvoll sein, die verschlüsselten Passwortdaten zu übertragen. Manche Apps aus dem Univention App Center benötigen dies. Zu diesem Zweck kann der Passwortdienst auf dem AD-Server installiert werden (siehe <xref linkend="ad-connector:password-dienst"/>).
  </para>

  <para>
  	Im <emphasis>AD member</emphasis>-Modus liest der UCS AD-Connector Objektdaten per Voreinstellung mit den Berechtigungen des Maschinenkontos des &ucsMaster;s aus dem AD. Für das Auslesen von verschlüsselten Passwortdaten sind dessen Berechtigungen nicht ausreichend. Daher muss für die Einrichtung des Passwortdienstes zusätzlich manuell die LDAP-DN eines privilegierten Replikationsbenutzers in die &ucsUCRV; <envar>connector/ad/ldap/binddn</envar> eingetragen werden. Dieser muss im AD Mitglied der Gruppe <emphasis>Domänen-Admins</emphasis> sein. Das entsprechende Kennwort muss auf dem &ucsMaster; in eine Datei gespeichert werden und ihr Dateiname muss in die &ucsUCRV; <envar>connector/ad/ldap/bindpw</envar> eingetragen werden. Die Zugriffsrechte für die Datei sollten so eingeschränkt werden, dass nur der Besitzer <emphasis>root</emphasis> Zugriff hat. Die folgenden Kommandos zeigen dies beispielhaft:
  </para>

  <programlisting language="sh">
ucr set connector/ad/ldap/binddn=Administrator
ucr set connector/ad/ldap/bindpw=/etc/univention/connector/password
touch /etc/univention/connector/password
chmod 600 /etc/univention/connector/password
echo -n "Administrator password" > /etc/univention/connector/password
  </programlisting>

  <para>
    Falls gewünscht, kann zu einem späteren Zeitpunkt der AD-Domänencontroller auch durch den &ucsMaster; abgelöst werden. Dies ist über die Applikation <emphasis>Active Directory Takeover</emphasis> möglich (siehe <xref linkend="windows:adtakeover"/>).
  </para>
  </section>

  <section id="ad-connector:ad-connector-einrichtung">
  <title>Einrichtung des UCS AD-Connectors</title>

  <para>
  	Als Alternative zur Mitgliedschaft in einer AD-Domäne, die im vorherigen Abschnitt beschrieben ist, kann der UCS Active Directory-Connector dazu verwendet werden, Benutzer- und Gruppenobjekte zwischen einer UCS-Domäne und einer AD-Domäne zu synchronisieren. Diese Betriebsart erlaubt über die unidirektionale Synchronisation hinaus auch die bidirektionale Synchronisation. In dieser Betriebsart bestehen beide Domänen parallel und ihre Authentifikationssysteme funktionieren unabhängig. Voraussetzung dafür ist die Synchronisation der verschlüsselten Passwortdaten. Dafür ist die Installation eines speziellen Passwortdienstes auf dem AD-Domänencontroller notwendig.
  </para>

  <para>
    In der Standardeinstellung werden Container, Organisationseinheiten, Benutzer und Gruppen
    synchronisiert. Die Benutzer nehmen eine Sonderstellung ein, da das Passwort in Active
    Directory nicht über das LDAP-Protokoll abgefragt werden kann. Hierfür wird ein zusätzlicher
    Dienst auf dem Windows-Server installiert, der diese Passwortsynchronisation ermöglicht (siehe
    <xref linkend="ad-connector:password-dienst"/>).
  </para>
  
  <para>
    Hinweise zu den in der Grundeinstellung konfigurierten Attributen und zu beachtende
    Besonderheiten finden sich in <xref
    linkend="ad-connector:details-zur-vorkonfigurierten-synchronisation"/>.
  </para>
  
  <para>
    Die Rechnerkonten werden nicht synchronisiert, da Windows-Rechner nur in eine Domäne
    eingebunden sein können.
  </para>
  
  <para>
    Durch die in beiden Domänen gleichen Benutzereinstellungen können Benutzer transparent auf
    Dienste beider Umgebungen zugreifen. Nachdem eine Domänenanmeldung an einer UCS-Domäne
    durchgeführt wurde, ist anschließend eine Verbindung zu einer Dateifreigabe oder einem
    Exchange-Server mit Active Directory ohne erneute Passwortabfrage möglich. Auf den Ressourcen
    der anderen Domäne finden Benutzer und Administratoren gleichnamige Benutzer und Gruppen vor
    und können so mit den gewohnten Rechtestrukturen arbeiten.
  </para>
  
  <para>
    Nach dem erstmaligen Start des Connectors wird die Initialisierung vorgenommen. Dabei werden
    alle Einträge aus dem UCS gelesen und entsprechend dem eingestellten Mapping in AD-Objekte
    umgewandelt und auf AD-Seite hinzugefügt, bzw., falls bereits vorhanden,
    modifiziert. Anschließend werden alle Objekte aus dem AD gelesen und in UCS-Objekte
    umgewandelt und entsprechend auf UCS-Seite hinzugefügt bzw. modifiziert. Solange noch
    Änderungen vorliegen, werden die Verzeichnisdienst-Server weiter abgefragt. Der UCS AD-Connector
    kann auch in einem unidirektionalen Modus betrieben werden.
  </para>
  
  <para>
    Nach dem initialen Sync werden weitere Änderungen in einem festen Intervall abfragt. Dieser
    Wert ist auf fünf Sekunden eingestellt und kann manuell per &ucsUCR; angepasst werden.
  </para>
  
  <para>
    Sollte ein Objekt nicht synchronisiert werden können, so wird dieses Objekt zunächst
    zurückgestellt ("rejected"). Nach einer konfigurierbaren Anzahl von Durchläufen - das
    Intervall kann im UMC-Konfigurationsmodul konfiguriert werden, siehe <xref
    linkend="ad-connector:basicsetup"/>  - wird erneut versucht diese Änderungen wieder
    einzuspielen. Der Standardwert beträgt zehn Durchläufe. Außerdem wird bei einem Neustart des
    UCS AD-Connectors ebenfalls versucht, die zuvor zurückgewiesenen Änderungen erneut zu
    synchronisieren.
  </para>

  <section id="ad-connector:basicsetup">
	<title>Grundkonfiguration des UCS AD-Connectors</title>

	<para>
	  Der UCS AD-Connector wird über den Assistenten <guimenu>UCS Active Directory-Verbindung</guimenu> der
	  &ucsUMC; konfiguriert.
	</para>

	<para>
	  Der Einrichtungsassistent kann mit der Applikation <emphasis>Active Directory-Verbindung</emphasis>
	  aus dem Univention App Center installiert werden. Alternativ kann das Softwarepaket
	  <package>univention-ad-connector</package> installiert werden. Weitere Informationen finden sich in
	  <xref linkend="computers::softwaremanagement::installsoftware"/>.
	</para>

	<para>
	  Die Applikation <emphasis>Active Directory-Verbindung</emphasis> kann nur auf einem &ucsMaster; oder &ucsBackup; installiert werden.
	</para>

	<note>
	  <para>
	    Alle AD- und UCS-Server in einer Connector-Umgebung müssen dieselbe Zeitzone verwenden.
	  </para>
	</note>

	<warning>
	  <para>
	    Trotz intensiver Tests kann aufgrund der Vielfalt der Konfigurations- und Betriebsvarianten
	    einer AD-Domäne nicht ausgeschlossen werden, dass die Ergebnisse des
	    Synchronisationsvorgangs den Betrieb einer produktiven Domäne beeinträchtigen. Der UCS AD-Connector
	    sollte daher vorab in einer getrennten Umgebung auf die jeweiligen Anforderungen geprüft werden.
	  </para>
	</warning>

	<para>
	  Es ist zu empfehlen, die folgenden Schritte mit einem Webbrowser vom AD-Domänencontroller aus durchzuführen, da Dateien auf den AD-Domänencontroller herunter und in die &ucsUMC; hochgeladen werden müssen.
	</para>

	<para>
	  Internet Explorer 6 - der auf Windows 2003-Systemen vorinstalliert ist - wird von der &ucsUMC;
	  nicht unterstützt. Hier sollte zuerst eine Aktualisierung des Browsers durchgeführt oder ein
	  alternativer Browser installiert werden.
	</para>

	<para>
	  Im ersten Dialog der Einrichtungsassistenten muss der Punkt <emphasis>Synchronisation von Kontendaten zwischen einer AD und dieser UCS-Domäne</emphasis> ausgewählt und mit <guimenu>Weiter</guimenu> bestätigt werden.
	</para>

	<para>
	  <figure><title>Konfiguration des UCS AD-Connectors in UMC</title>
	  <graphic scalefit="1" width="80%" fileref="illustrations/adconnector_1-de.png"/>
	  </figure>
	</para>

	<para>
	  Im nächsten Dialog wird die Adresse eines AD-Domänencontrollers abgefragt.
	  Hier kann die IP-Adresse oder ein voll qualifizierter DNS-Name eingegeben werden.
	  Wenn der Rechnername des AD-Systems für das UCS-System nicht auflösbar sein sollte, kann entweder unter UCS der AD DNS-Server als DNS-Forwarder konfiguriert werden oder es kann in der DNS-Verwaltung der &ucsUMC; ein DNS-Host-Record für das AD-System angelegt werden (siehe <xref linkend="networks::dns::hostrecord"/>).
	</para>

	<para>
	  Alternativ kann auch über &ucsUCR; ein statischer Eintrag in <filename>/etc/hosts</filename>
	  aufgenommen werden, z.B. mit
	</para>

	<programlisting language="sh">
ucr set hosts/static/192.168.0.100=w2k8-32.ad.example.com
	</programlisting>

	<para>
	  Im Feld <guimenu>Active Directory-Konto</guimenu> wird der Benutzer konfiguriert, der für
	  den Zugriff auf das AD verwendet wird. Die Einstellung wird in der
	  &ucsUCRV; <envar>connector/ad/ldap/binddn</envar> gespeichert. Der Replikationsbenutzer muss im
	  AD Mitglied der Gruppe <emphasis>Domänen-Admins</emphasis> sein. Synchronisiert
	  der Connector nur lesend von AD zu UCS, kann auch ein Standardbenutzerkonto
	  angegeben werden.
	</para>

	<para>
	  Das verwendete Kennwort für den Zugriff muss im Feld <guimenu>Active Directory-Passwort</guimenu>
	  eingetragen werden. Es wird auf dem UCS-System lokal in einer Datei gespeichert,
	  die nur für den Benutzer <emphasis>root</emphasis> lesbar ist.
	</para>

	<para>
	  Nach Klick auf <guimenu>Weiter</guimenu> prüft der Einrichtungsassistent die Verbindung zum AD-Domänencontroller. Falls keine SSL/TLS-verschlüsselte Verbindung aufgebaut werden kann wird eine Warnung ausgegeben
	  in der zur Installation einer Zertifizierungsstelle auf dem AD-Domänencontroller geraten wird.
	  Es wird empfohlen diesem Rat zu folgen. Nach diesem Schritt kann die Einrichtung durch erneuten Klick auf
	  <guimenu>Weiter</guimenu> fortgesetzt werden. Falls weiterhin keine SSL/TLS-verschlüsselte Verbindung aufgebaut werden kann, wird in einem Sicherheitshinweis nachgefragt, ob die Synchronisation ohne SSL-Verschlüsselung eingerichtet werden soll.
	  Falls dies gewünscht ist, kann die Einrichtung durch Klick auf <guimenu>Fortfaren ohne Verschlüsselung</guimenu> fortgesetzt werden. In diesem Fall findet die Synchronisation der Verzeichnisdaten unverschlüsselt statt.
	</para>

	<para>
	  Falls der AD-Domänencontroller SSL/TLS-verschüsselte Verbindungen unterstützt, bietet der Einrichtungsassistent im nächsten Schritt das <guimenu>Hochladen des AD-Root-Zertifikats</guimenu> an. Dieses Zertifikat muss vorher aus der AD-Zertifizierungsstelle exportiert werden (siehe <xref linkend="ad-connector:ad-zertifikat"/>). Falls dieser Schritt hingegen übersprungen wird, kann das Zertifikat auch zu einem späteren Zeitpunkt über das UMC-Modul hochgeladen und die SSL/TLS-Verschlüsselung aktiviert werden (bis dahin werden dann aber alle Verzeichnisdaten unverschlüsselt synchronisiert).
	</para>

	<para>
	  Der Connector kann in verschiedenen Modi betrieben werden, die im nächsten Dialog
	  <guimenu>Konfiguration der AD-Domänensynchronisation</guimenu> ausgewählt werden können.
	  Neben einer bidirektionalen Synchronisation kann auch unidirektional von AD nach UCS
	  oder unidirektional von UCS in das AD repliziert werden.
	  Nach Auswahl des Modus muss auf <guimenu>Weiter</guimenu> geklickt werden.
	</para>

	<para>
	  Im letzten Dialog werden alle zur <guimenu>Installation des Passwortdienstes</guimenu> notwendigen Dateien zum Download auf den Windows-Server angeboten. Weitere Details dazu sind im Abschnitt <xref linkend="ad-connector:password-dienst"/> beschrieben.
	</para>

	<para>
	  Nach einem Klick auf <guimenu>Weiter</guimenu> wird die Konfiguration übernommen und der UCS AD-Connector wird gestartet.
	  Der abschliessende Dialog muss dann durch Klick auf <guimenu>Fertigstellen</guimenu> geschlossen werden.
	</para>
	<para>
      Nach dieser Einrichtung kann das UMC-Modul <emphasis>Active Directory-Verbindung</emphasis> zur weiteren Administration des UCS Active Directory Connectors verwendet werden, z.B. um zu prüfen, ob der Dienst läuft und ihn ggf. neu zu starten (siehe <xref linkend="ad-connector:neustart"/>).
	</para>
  </section>

<section id="ad-connector:ad-zertifikat">
  <title>Import des SSL-Zertifikats des Active Directory</title>

  <para>
	Auf dem Active Directory-System muss nun ein SSL-Zertifikat erzeugt
	und das Root-Zertifikat exportiert werden, damit eine verschlüsselte Kommunikation
	stattfinden kann. Erzeugt wird das Zertifikat mit dem
	Zertifikatsdienst des Active Directory. Die nötigen Schritte
	sind abhängig von der eingesetzten Windows-Version und werden hier
	beispielhaft für drei Varianten dargestellt.
  </para>

  <para>
	Die verschlüsselte Verbindung zwischen UCS-System und Active Directory
	kann auch deaktiviert werden, indem die
	&ucsUCRV; <envar>connector/ad/ldap/ssl</envar> auf <emphasis>no</emphasis> gesetzt wird. Diese
	Einstellung betrifft nicht die Kommunikation mit dem
	Passwort-Dienst (siehe <xref linkend="ad-connector:password-dienst"/>);
	diese ist immer verschlüsselt.
  </para>

  <section id="windows:Export_unter_Windows_2003">
	<title>Export unter Windows 2003</title>

	<para>
	  Falls der Zertifikatsdienst nicht installiert ist, so kann dieser
	  nachinstalliert werden: <guimenu>Start &ar;
	  Einstellungen &ar; Systemsteuerung &ar; Software &ar; Windows
	  Komponenten, Zertifikatsdienst auswählen &ar; Weiter
	  Stammzertifizierungsstelle des Unternehmens wählen &ar; Weiter, Domänen
	  Namen angeben &ar; Weiter &ar; Weiter</guimenu>. Anschließend sollte der Server neu
	  gestartet werden.
	</para>

	<para>
	  Dieses Zertifikat muss exportiert und auf das UCS System kopiert werden:
	  <guimenu>Zertifizierungsstelle &ar; AD-Domäne &ar;
	  Eigenschaften &ar; Zertifikat anzeigen &ar; Details &ar; In Datei kopieren &ar;
	  DER-codiert-binaer X.509</guimenu>.
	</para>
  </section>

  <section id="windows:Export_unter_Windows_2008">
	<title>Export unter Windows 2008</title>

	<para>
	  Falls der Zertifikatsdienst nicht installiert ist, so muss dieser
	  nachinstalliert werden:
	</para>

	<para>
	  <figure><title>Export des Root-Zertifikats unter Windows 2008</title>
	  <graphic scalefit="1" width="80%" fileref="illustrations/adconnector_23-de.png"/>
	  </figure>
	</para>

	<para>
	  <guimenu>Start &ar; Systemsteuerung &ar; Programme und Funktionen &ar; Windows-Funktionen
	  aktivieren oder deaktivieren &ar; Rollen &ar; Rollen hinzufügen &ar; Weiter
	  &ar; Haken bei Active Directory-Zertifikatsdienste aktivieren &ar; Weiter
	  &ar; Weiter &ar; Zertifizierungsstelle aktivieren &ar; Unternehmen auswählen
	  &ar; Stammzertifierungsstelle auswählen &ar; Neuen privaten Schlüssel
	  erstellen &ar; Weiter &ar; Die vorgeschlagenen Kryptoeinstellungen mit
	  Weiter akzeptieren &ar; Den vorgeschlagenen Namen der
	  Zertifizierungsstelle akzeptieren &ar; Eine beliebige Gültigkeitsdauer
	  auswählen &ar; Weiter &ar; Standardpfad für die Zertifikatsdatenbank
	  akzeptieren</guimenu> . Im abschließenden Dialog erscheint eine Warnmeldung,
	  dass Name und Domäneneinstellung nach Installation der
	  Zertifizierungsstelle nicht mehr geändert werden können. Dies muss
	  mit <guimenu>Installieren</guimenu> bestätigt werden.
	</para>

	<para>
	  Anschließend muss der AD-Server neu gestartet werden.
	</para>

	<para>
	  Dieses Zertifikat muss nun exportiert und auf das UCS System kopiert
	  werden: <guimenu>Start &ar; Programme &ar; Verwaltung &ar; Zertifizierungsstelle</guimenu>.
	  Dort wird eine
	  Rechnerliste angezeigt und unter jedem System die Elemente <guimenu>Gesperrte
	  Zertifikate</guimenu>, <guimenu>Ausgestellte Zertifikate</guimenu>, <guimenu>Ausstehende
	  Anforderungen</guimenu>, <guimenu>Fehlgeschlagene Anforderungen</guimenu> und
	  <guimenu>Zertifikatsvorlagen</guimenu> angezeigt. Hier muss ein Rechtsklick auf den
	  Rechnernamen erfolgen - nicht auf eines der Elemente darunter - und
	  <guimenu>Eigenschaften</guimenu> ausgewählt werden. Das Root-Zertifikat heisst in der Regel
	  <emphasis>Zertifikat Nr. 0</emphasis>. Dann <guimenu>Zertifikat anzeigen &ar; Details  &ar; In Datei kopieren &ar;
	  DER-codiert-binär X.509 (.CER) &ar; Auswahl eines beliebigen Dateinamens und Speicherpfad
	  &ar; Fertig stellen</guimenu>.
	</para>
  </section>

  <section id="windows:adconn:win2012">
	<title>Export unter Windows Server 2012</title>

	<para>
	  Falls der Zertifikatsdienst nicht installiert ist, so muss dieser
	  nachinstalliert werden:
	</para>

	<para>
	  Der Server-Manager muss geöffnet werden. Dort im Menü <guimenu>Verwalten &ar; Rollen und Features
	  hinzufügen</guimenu> die Rolle <guimenu>Active Directory-Zertifikatsdienste</guimenu>
	  auswählen. Bei der Auswahl der Rollendienste reicht es aus, nur die
	  <guimenu>Zertifizierungsstelle</guimenu> auszuwählen. Anschließend wird im Server-Manager in
	  der oberen Leiste ein gelbes Warndreieick angezeigt. Hier muss die Option <guimenu>Active
	  Directory-Zertifikatsdienste auf dem Zielserver konfigurieren</guimenu> ausgewählt werden. Als
	  zu konfigurierender Rollendienst wird <guimenu>Zertifizierungsstelle</guimenu> ausgewählt. Der
	  Installationstyp ist <guimenu>Unternehmenszertifizierungsstelle &ar;
	  Stammzertifizierungsstelle</guimenu>. Nun muss auf <guimenu>Neuen privaten Schlüssel
	  erstellen</guimenu> geklickt und die vorgeschlagenen Kryptoeinstellungen und der
	  vorgeschlagene Name der Zertifizierungsstelle bestätigt werden. Die Gültigkeitsdauer kann
	  beliebig gewählt werden. Als Datenbankort können die Standardpfade verwendet werden.
	</para>

	<para>
	  Anschließend muss der AD-Server neu gestartet werden.
	</para>

	<para>
	  Dieses Zertifikat muss nun exportiert und auf das UCS-System kopiert
	  werden: <guimenu>Server-Manager &ar; AD-Zertifikatsdienste</guimenu>. Dann ein Rechts-Klick
	  auf den Server und Auswahl von <guimenu>Zertifizierungsstelle</guimenu>. Dort wird eine
	  Rechnerliste angezeigt und unter jedem System die Elemente <guimenu>Gesperrte
	  Zertifikate</guimenu>, <guimenu>Ausgestellte Zertifikate</guimenu>, <guimenu>Ausstehende
	  Anforderungen</guimenu>, <guimenu>Fehlgeschlagene Anforderungen</guimenu> und
	  <guimenu>Zertifikatsvorlagen</guimenu> angezeigt. Hier muss ein Rechtsklick auf den
	  Rechnernamen erfolgen - nicht auf eines der Elemente darunter - und
	  <guimenu>Eigenschaften</guimenu> ausgewählt werden. Das Root-Zertifikat heisst in der Regel
	  <emphasis>Zertifikat Nr. 0</emphasis>. Dann <guimenu>Zertifikat anzeigen &ar; Details  &ar; In Datei kopieren &ar;
	  DER-codiert-binär X.509 (.CER) &ar; Auswahl eines beliebigen Dateinamens und Speicherpfad
	  &ar; Fertig stellen</guimenu>.
	</para>

  </section>


<section id="windows:Kopieren_des_AD-Zertifikats_auf_das_UCS-System"><title>Kopieren des AD-Zertifikats auf das UCS-System</title>
<para>
Nun muss das SSL-AD-Zertifikat über den &ucsUMC;-Assistenten in das
UCS-System importiert werden.
</para>
<para>
Dies erfolgt durch einen Klick auf <guimenu>Hochladen</guimenu> im
Untermenü <guimenu>Active Directory Server Konfiguration</guimenu>.
</para>
<para>
Hierbei öffnet sich ein Fenster, in dem eine Datei ausgewählt wird.
Das hochgeladene Zertifikat wird dadurch für den UCS AD-Connector verfügbar gemacht.
</para>
</section>
</section>

<section id="ad-connector:password-dienst"><title>Einrichtung des Passwort-Dienstes auf dem AD-System</title>
<para>
Active Directory verbietet die Abfrage von Passwörtern über das
LDAP-Protokoll, was die Installation eines Paketes auf dem
Windows-Server erfordert.
</para>
<para>
Die Installations-Pakete werden ebenfalls über den
Einrichtungs-Assistenten der &ucsUMC; bereitgestellt:
</para>
<para>
<figure><title>Download der Pakete für den Passwortdienst</title>
 <graphic scalefit="1" width="80%" fileref="illustrations/adconnector_2-de.png"/>
 </figure>
</para>
<itemizedlist>
<listitem><simpara><filename>ucs-ad-connector.msi (for 32bit Windows)</filename></simpara></listitem>
<listitem><simpara><filename>ucs-ad-connector-64bit.msi (for 64bit Windows)</filename></simpara></listitem>
<listitem><simpara><filename>Microsoft Visual C++ 2010 Redistributable Package (x86)</filename></simpara></listitem>
<listitem><simpara><filename>private.key</filename></simpara></listitem>
<listitem><simpara><filename>cert.pem</filename></simpara></listitem>
</itemizedlist>
<para>
Auf 64 Bit-Varianten von Windows muss vor der Installation des AD
Connectors das <emphasis>Microsoft Visual C++ 2010
  Redistributable Package (x86)</emphasis>installiert werden.
</para>
<para>
Die MSI-Pakete sind die Installations-Dateien für den
Passwortdienst und können durch einen Doppelklick gestartet werden.
</para>
<para>
Das Paket wird automatisch in das Verzeichnis <command>C:\Windows\UCS-AD-Connector</command> installiert. Zusätzlich wird der
Passwort-Dienst als Systemdienst in die Windows-Umgebung integriert,
wodurch der Dienst automatisch oder manuell gestartet werden kann.
Nach der Installation ist der Passwort-Dienst für den automatischen
Start konfiguriert.
</para>
<para>
Die Dateien <emphasis>private.key</emphasis> und <emphasis>cert.pem</emphasis> beinhalten unter UCS erzeugte
SSL-Zertifikate für die gesicherte Kommunikation des Passwort-Dienstes. Sie müssen ebenfalls
in das Installationsverzeichnis des Passwort-Dienstes kopiert werden.
Anschließend muss der Passwort-Dienst neu gestartet werden.
</para>
<para>
In einer Standard-Installation unter Windows 2008 blockiert die
Windows-Firewall die Zugriffe auf den UCS AD-Connector. Diese muss entweder
in der <guimenu>Systemsteuerung</guimenu> deaktiviert werden oder Port
6670/TCP freigegeben werden.
</para>
</section>

<section id="ad-connector:neustart"><title>Start/Stop des Active Directory Connectors</title>
<para>
Abschließend kann der Connector über <guimenu>Active Directory
  Connector starten</guimenu> gestartet werden und bei Bedarf über <guimenu>
Active Directory Connector beenden</guimenu> angehalten werden. Alternativ kann
ein Starten/Stoppen auch über Kommandozeile durch die Befehle
<command>/etc/init.d/univention-ad-connector start</command> und
<command>/etc/init.d/univention-ad-connector stop</command> erfolgen.
</para>
</section>

<section id="windows:Funktionstest_der_Grundeinstellungen"><title>Funktionstest der Grundeinstellungen</title>
<para>
Die korrekte Grundkonfiguration des Connectors lässt sich prüfen, indem
vom UCS-System aus im Active Directory gesucht wird. Hier kann z.B. mit
<command>univention-adsearch cn=Administrator</command> nach dem
Administrator-Konto im Active Directory gesucht werden.
</para>
<para>
Da <command>univention-adsearch</command> auf die in &ucsUCRV;
gespeicherte Konfiguration zugreift, kann auf diesem Weg die
Erreichbarkeit/Konfiguration des Active Directory-Zugriffs geprüft
werden.
</para>
</section>
</section>

<section id="ad-connector:tools"><title>Werkzeuge / Fehlersuche</title>
<para>
Mit dem UCS AD-Connector werden einige Tools und Logdateien bereitgestellt:
</para>
<section id="ad-connector:univention-adsearch"><title>univention-adsearch</title>
<para>
Dieses Tool ermöglicht die einfache LDAP-Suche im Active Directory.
In AD gelöschte Objekte werden immer mit angezeigt (diese werden in AD
weiterhin in einem LDAP-Unterbaum vorgehalten). Als erste Option erwartet das Skript
einen LDAP-Filter, die zweite Option kann eine Liste der anzuzeigenden
LDAP-Attribute sein, z.B.:
</para>
<programlisting language="sh">
univention-adsearch cn=administrator cn givenName
</programlisting>
</section>

<section id="ad-connector:univention-connector-list-rejected"><title>univention-connector-list-rejected</title>
<para>
Dieses Tool führt die DNs nicht synchronisierter Objekte auf. Zusätzlich wird,
sofern zwischengespeichert, die korrespondierende DN im jeweils anderen LDAP-Verzeichnis
angegeben. Abschließend gibt <emphasis>lastUSN</emphasis> die ID der letzten von AD
synchronisierten Änderung an.
</para>
</section>

<section id="windows:Logdateien"><title>Logdateien</title>
<para>
Zur Fehlersuche bei Synchronisationsproblemen finden sich
entsprechende Meldungen in folgenden Dateien auf dem UCS-System:
</para>
<programlisting>
/var/log/univention/connector.log
/var/log/univention/connector-status.log
</programlisting>
<para>
Die Statusmeldungen des Passwort-Dienstes auf AD-Seite werden in die
Datei <filename>C:\Windows\UCS-AD-Connector\UCS-AD-Connector.log</filename> protokolliert.
</para>
</section>
</section>

<section id="ad-connector:details-zur-vorkonfigurierten-synchronisation"><title>Details zur vorkonfigurierten Synchronisation</title>
<para>
In der Grundeinstellung werden einige Container durch Filter von der
Synchronisation ausgeschlossen. Diese finden sich in der
Konfigurationsdatei <filename>/etc/univention/connector/ad/mapping</filename>
unter der Einstellung <emphasis>global_ignore_subtree</emphasis>.
</para>

<section id="ad-connector:container-und-organisationseinheiten"><title>Container und Organisationseinheiten</title>
<para>
Container und Organisationseinheiten werden zusammen mit ihrer Beschreibung
synchronisiert. Die Container <emphasis>cn=mail</emphasis> und <emphasis>cn=kerberos</emphasis> werden auf beiden
Seiten ignoriert. Bei
Containern sind einige Besonderheiten auf AD-Seite zu beachten. Active
Directory bietet im <guimenu>Manager für Benutzer und Gruppen</guimenu> keine
Möglichkeit, Container anzulegen. AD zeigt diese im erweiterten Modus
aber an (<guimenu>Ansicht &ar; Erweiterte Funktionen</guimenu>).
</para>

<section id="windows:ad-connector:Besonderheiten"><title>Besonderheiten</title>
<itemizedlist>
	<listitem>
		<para>Unter AD gelöschte Container oder Organisationseinheiten werden unter
UCS rekursiv gelöscht, das bedeutet, dass evtl. nicht synchronisierte
Unterobjekte, die in AD nicht zu sehen sind, ebenfalls entfernt
werden.
</para>
</listitem>
</itemizedlist>
</section>
</section>

<section id="ad-connector:gruppen"><title>Gruppen</title>
<para>
Gruppen werden anhand des Gruppennamens synchronisiert, dabei findet
eine Berücksichtigung der primären Gruppe eines Benutzers statt (die
unter AD nur am Benutzer im LDAP hinterlegt wird).
</para>
<para>
Gruppenmitglieder, die im anderen System z.B. aufgrund von Ignore-Filtern
kein Gegenstück haben, werden ignoriert (bleiben also Mitglied der Gruppe).
</para>
<para>
Zusätzlich wird die Beschreibung der Gruppe synchronisiert.
</para>

<section id="windows:gruppen:Besonderheiten"><title>Besonderheiten</title>
<itemizedlist>
<listitem><simpara>Unter AD wird der <emphasis>Prä-Windows 2000 Name</emphasis> (LDAP-Attribut
<emphasis>samAccountName</emphasis>) verwendet, daher kann eine Gruppe im
Active Directory mit anderem Namen erscheinen als unter UCS.
</simpara>
</listitem>
<listitem><simpara>Der Connector ignoriert Gruppen, die im &ucsUDM;
unter <guimenu>Samba Gruppentyp</guimenu> als <emphasis>Bekannte Gruppe</emphasis>
konfiguriert wurden. Eine Synchronisation von SID oder RID findet
nicht statt.
</simpara>
</listitem>
<listitem><simpara>Gruppen, die im &ucsUDM; unter <guimenu>Samba Gruppentyp</guimenu> als <emphasis>Lokale Gruppe</emphasis>
konfiguriert wurden, werden vom Connector als <emphasis>globale Gruppen</emphasis>
in das Active Directory synchronisiert.
</simpara>
</listitem>
<listitem><simpara>Neu angelegte oder verschobene Gruppen werden immer im gleichen
Untercontainer auf der Gegenseite angelegt. Existieren während der
Initialisierung gleichnamige Gruppen in unterschiedlichen Containern,
werden die Mitglieder synchronisiert, nicht jedoch die Position im
LDAP. Wird eine solche Gruppe auf einer Seite verschoben ist der
Zielcontainer auf der anderen Seite identisch, so dass sich die DNs
der Gruppen ab diesem Zeitpunkt nicht mehr unterscheiden.
</simpara>
</listitem>
<listitem>
	<para>Bestimmte Gruppennamen werden anhand einer Mapping-Tabelle umgesetzt, so
dass z.B. die UCS-Gruppe <emphasis>Domain Users</emphasis> mit der AD-Gruppe
<emphasis>Domänen-Benutzer</emphasis>. synchronisiert wird. Dieses Mapping kann in
englischsprachigen AD-Domänen dazu führen, das die deutschsprachigen
Gruppen angelegt werden und sollte in diesem Fall deaktiviert
werden. Dazu kann die &ucsUCRV; <envar>connector/ad/mapping/group/language</envar>
verwendet werden.
</para>
<para>
Die vollständige Tabelle ist:
</para>
<informaltable>
<?dbhtml table-width="50%" ?>
<?dbfo table-width="50%" ?>
<tgroup cols="2">
<colspec colnum="1" colname="col1" colwidth="1*"/>
<colspec colnum="2" colname="col2" colwidth="1*"/>
<thead>
<row>
<entry><emphasis>UCS-Gruppe</emphasis></entry>
<entry><emphasis>AD-Gruppe</emphasis></entry>
</row>
</thead>
<tbody>
<row>
<entry>Domain Users</entry>
<entry>Domänen-Benutzer</entry>
</row>
<row>
<entry>Domain Admins</entry>
<entry>Domänen-Admins</entry>
</row>
<row>
<entry>Windows Hosts</entry>
<entry>Domänencomputer</entry>
</row>
</tbody>
</tgroup>
</informaltable>
</listitem>
<listitem><simpara>Die Repräsentation von Gruppen in Gruppen unterscheidet sich zwischen
AD und UCS. Sind unter UCS Gruppen Mitglieder von Gruppen, so können
diese Objekte nicht immer auf AD-Seite synchronisiert werden und erscheinen
in der Liste der zurückgewiesenen Objekte. Verschachtelte Gruppen
sollten daher aufgrund der in Active Directory vorliegenden
Einschränkungen immer nur dort zugewiesen werden.
</simpara>
</listitem>
<listitem><simpara>Wird im &ucsUDM; eine globale Gruppe A als Mitglied einer
  anderen globalen Gruppe B aufgenommen, so erscheint diese Mitgliedschaft aufgrund von
AD-internen Beschänkungen unter Windows 2000/2003 nicht im Active
Directory. Wird Gruppe A anschließend umbenannt, geht die
Gruppenmitgliedschaft in Gruppe B verloren. Ab Windows 2008 besteht
diese Einschränkung nicht mehr, dort können im Active Directory auch
globale Gruppen verschachtelt werden.
</simpara>
</listitem>
</itemizedlist>
</section>
</section>

<section id="ad-connector:benutzer"><title>Benutzer</title>
<para>
Benutzer werden wie Gruppen anhand des Benutzernamens bzw. anhand des
AD-Prä-Windows 2000 Namens synchronisiert. Direkt übermittelt werden
die Attribute <emphasis>Vorname</emphasis>, <emphasis>Nachname</emphasis>, <emphasis>primäre Gruppe</emphasis> (sofern auf der
anderen Seite vorhanden), <emphasis>Organisation</emphasis>, <emphasis>Beschreibung</emphasis>, <emphasis>Straße</emphasis>, <emphasis>Stadt</emphasis>,
<emphasis>PLZ</emphasis>, <emphasis>Profilpfad</emphasis>, <emphasis>Anmeldeskriptpfad</emphasis>, <emphasis>Deaktiviert</emphasis> und
<emphasis>Kontoablaufdatum</emphasis>. Indirekt werden zusätzlich <emphasis>Passwort</emphasis>,
<emphasis>Passwortablaufdatum</emphasis> und <emphasis>Ändern des Passwortes beim nächsten Login</emphasis>
synchronisiert. Vorbereitet, aber auf Grund unterschiedlicher Syntax in
der Mapping-Konfiguration auskommentiert, sind <emphasis>Primäre Mail-Adresse</emphasis> und
<emphasis>Telefonnummer</emphasis>.
</para>
<para>
Ausgenommen werden die Benutzer <emphasis>root</emphasis> und <emphasis>Administrator</emphasis>.
</para>

<section id="windows:benutzer:Besonderheiten"><title>Besonderheiten</title>
<itemizedlist>
<listitem><simpara>Benutzer werden ebenfalls anhand des Namens identifiziert, so dass für
Benutzer, die vor der ersten Synchronisation auf beiden Seiten
angelegt wurden, hinsichtlich der Position im LDAP das gleiche
Verhalten gilt wie bei Gruppen.
</simpara>
</listitem>
<listitem><simpara>Die Synchronisation des Passwortablaufdatums und der Benutzer-Option <emphasis>Passwort-Ändern
beim nächsten Login</emphasis> erfolgt UCS-seitig nur auf Samba-Ebene. Wird die Passwortänderung
durch &ucsUMC; ausgelöst, dass Passwort dann aber im Active Directory
geändert, werden die Ablaufdaten bzgl. des Kerberos- und
Posix- Kennworts nicht geändert, so dass der User z.B. bei Thin Client-Anmeldung
sein Passwort erneut ändern muss.
</simpara>
</listitem>
<listitem><simpara>Es kann vorkommen, dass ein unter AD anzulegender Benutzer, dessen
Passwort zurückgewiesen wurde, nach sofortigem erneuten Anlegen aus AD
gelöscht wird. Grund dafür ist, das AD diesen Benutzer zunächst anlegt
und nach dem Abweisen des Passwortes sofort wieder löscht. Werden
diese Operationen nach UCS übertragen, werden sie auch wieder zurück
nach AD übermittelt. Wurde der Benutzer auf AD-Seite schon vor der Rückübertragung
der Operation erneut eingetragen, so wird er nach der Rückübertragung
gelöscht. Das Auftreten dieses Verhaltens ist abhängig von dem
eingestellten Polling-Intervall des Connectors.
</simpara>
</listitem>
<listitem><simpara>AD und UCS legen neue Benutzer per Voreinstellung in eine bestimmte
primäre Gruppe (meist <emphasis>Domain Users</emphasis> bzw. <emphasis>Domänen Benutzer</emphasis>). Während
der ersten Synchronisation von UCS nach AD werden die Benutzer daher
immer in dieser Gruppe Mitglied.
</simpara>
</listitem>
</itemizedlist>
</section>
</section>
</section>
</section>


<section id="windows:adtakeover">
  <title>Migration einer Active Directory-Domäne zu UCS mit Univention AD Takeover</title>

  <section id="windows:adtakeover:intro">
	<title>Einführung</title>
	<para>
	  UCS unterstützt die Übernahme von Benutzern, Gruppen, Rechnerobjekten und
	  Gruppenrichtlinienobjekten (GPOs) aus einer bestehenden Active Directory (AD)-Domäne. Die
	  Windows-Clients müssen dabei nicht erneut der Domäne beitreten. Diese
	  Übernahme ist ein interaktiver Prozess, der aus drei Phasen besteht:

	  <itemizedlist>
		<listitem><simpara>
		  Beitritt des UCS-Domänencontrollers in die Active Directory Domäne
		</simpara></listitem>

		<listitem><simpara>
		  Kopieren der Gruppenrichtliniendateien aus Active Directory nach UCS
		</simpara></listitem>

		<listitem><simpara>
		  Abschalten des AD-Servers und Zuweisung der FSMO-Rollen auf den UCS-Domänencontroller
		</simpara></listitem>
	  </itemizedlist>
	</para>

	<para>
	  Die folgenden Voraussetzungen müssen für die Übernahme erfüllt sein:

	  <itemizedlist>
		<listitem><simpara>
		  Der UCS-Domänencontroller (&ucsMaster;, &ucsBackup; oder &ucsSlave;) muss mit einem
		  eindeutigen Rechnernamen installiert werden, der nicht in der AD-Domäne vorhanden ist.
		</simpara></listitem>

		<listitem><simpara>
		  Der UCS-Domänencontroller muss mit demselben DNS-Domänennamen, NetBIOS-Domänennamen und
		  Kerberos-Domänennamen installiert werden wie die AD-Domäne. Es wird empfohlen auch
		  die selbe LDAP-Basis-DN zu verwenden.
		</simpara></listitem>

		<listitem><simpara>
		  Der UCS-Domänencontroller muss eine IPv4-Adresse im selben Subnetz wie der zu
		  übernehmende Active Directory-Domänencontroller verwenden.
		</simpara></listitem>
	  </itemizedlist>
	</para>

	<para>
	  Für die Migration muss die Applikation <emphasis>Active Directory Takeover</emphasis> aus dem
	  Univention App Center installiert werden. Sie muss auf dem System installiert werden, auf dem
	  der Univention S4 Connector läuft (siehe <xref linkend="windows:s4connector"/>, normalerweise
	  der &ucsMaster;).
	</para>

  </section>

  <section id="windows:adtakeover:preparations">
	<title>Vorbereitung</title>
	<para>
	  Es wird empfohlen die folgenden Schritte durchzuführen, bevor die Übernahme initiiert wird:

	  <itemizedlist>
		<listitem><simpara>
		  Ein Backup des/der AD-Server(s) sollte durchgeführt werden.
		</simpara></listitem>

		<listitem><simpara>
		  Sind Benutzeranmeldungen auf dem AD-Server erlaubt (durch Domänenanmeldungen oder
		  Terminalserversitzungen) wird empfohlen diese zu deaktiviert und alle Dienste zu stoppen
		  die Daten verarbeiten (z.B. Mailserver). Dies stellt sicher das durch den Rollback auf ein
		  Backup oder einen Snapshot keine Daten verloren gehen.
		</simpara></listitem>

		<listitem><simpara>
		  Es wird empfohlen auf dem AD-Server dasselbe <emphasis>Administrator</emphasis>-Passwort zu verwenden wie in
		  der UCS-Domäne. Werden verschiedene Passwörter verwendet, wird anhand der Zeitstempel
		  verglichen welches Passwort aktueller ist und dieses verwendet.
		</simpara></listitem>

		<listitem><simpara>
		  In der Grundeinstellung ist das lokale <emphasis>Administrator</emphasis> Konto auf dem
		  AD-Server deaktiviert. Es sollte in der lokalen Benutzerverwaltung aktiviert werden.
		</simpara></listitem>

	  </itemizedlist>
	</para>

	<para>
	  Die Aktivierung des <emphasis>Administrator</emphasis>-Kontos wird empfohlen weil dieses Konto
	  über die nötigen Berechtigungen verfügt um die Gruppenrichtlinien-Dateien in der SYSVOL-Freigabe zu
	  kopieren. Der Benutzer kann entweder im AD-Verwaltungs-Tool für Benutzer und Gruppen
	  oder mit den folgenden Kommandos auf der Kommandozeile aktiviert werden:

	  <programlisting language="sh">
net user administrator /active:yes
net user administrator PASSWORT
	  </programlisting>
	</para>

  </section>

  <section id="windows:adtakeover:migrate">
	<title>Domänenmigration</title>
	<para>
	  Die Übernahme muss auf dem UCS-Domänencontroller gestartet werden, auf dem der Univention S4
	  Connector läuft (normalerweise der &ucsMaster;). Während der Übernahme sollte Samba nur auf
	  diesem UCS-System laufen. Gibt es weitere Samba-Domänencontroller müssen diese angehalten
	  werden. Dies ist wichtig um replikationsbedingte Dateninkonsistenzen zu vermeiden.
	</para>

	<para>
	  Andere Samba-Systeme können gestoppt werden, indem auf jedem UCS-Domänencontroller als
	  Benutzer <emphasis>root</emphasis> folgender Befehl ausfgeführt wird:

	  <programlisting language="sh">
/etc/init.d/samba4 stop
	  </programlisting>
	</para>

	<para>
	  Nachdem sichergestellt wurde, dass keine anderen Samba-Domänencontroller laufen, kann die
	  Übernahme beginnen. Wurde die UCS-Domäne mit einer UCS-Version vor 3.2 installiert muss zuerst
	  die folgende &ucsUCRV; gesetzt werden:

	  <programlisting language="sh">
ucr set connector/s4/mapping/group/grouptype=false
	  </programlisting>
	</para>

	<para>
	  Die Übernahme erfolgt mit dem &ucsUMC;-Modul <guimenu>Active Directory
	  Takeover</guimenu>. Unter <guimenu>Name oder Adresse des Domänencontrollers</guimenu> muss die
	  IP-Adresse des AD-Systems angegeben werden. Unter <guimenu>Active Directory
	  Administratorkonto</guimenu> muss ein Konto der AD-Domäne angegebe werden, das Mitglied der
	  AD-Gruppe  <emphasis>Domain Admins</emphasis> ist (z.B. der
	  <emphasis>Administrator</emphasis>) und unter <guimenu>Active Directory
	  Administratorpasswort</guimenu> das dazugehörige Passwort.
	</para>

	<figure>
	  <title>Erste Phase der Domänenmigration</title>
	  <graphic scalefit="1" width="80%" fileref="illustrations/takeover1-de.png"/>
	</figure>

	<para>
	  Das Modul prüft, ob der AD-Domänencontroller erreicht werden kann und zeigt die zu
	  migrierenden Domänendaten an:

	<figure>
	  <title>Übersicht über die zu migrierenden Daten</title>
	  <graphic scalefit="1" width="80%" fileref="illustrations/takeover2-de.png"/>
	</figure>
	</para>

	<para>
	  Nach einem Klick auf <guimenu>Weiter</guimenu> werden die folgenden Schritte automatisch
	  durchgeführt. Zusätzliche Informationen werden nach
	  <filename>/var/log/univention/ad-takeover.log</filename> protokolliert.

	  <itemizedlist>
		<listitem><simpara>
		  Anpassung der Systemzeit des UCS-Systems auf die Systemzeit der Active Directory-Domäne
		  (wenn diese um mehr als drei Minuten nachgeht)
		</simpara></listitem>

		<listitem><simpara>
		  Beitritt des UCS-Domänencontrollers in die Active Directory-Domäne
		</simpara></listitem>

		<listitem><simpara>
		  Start von Samba und dem Univention S4 Connector zur Replikation der AD-Objekte in das
		  UCS-OpenLDAP-Verzeichnis
		</simpara></listitem>

	  </itemizedlist>
	</para>
	
	<para>
	  Nun enthält der UCS-Domänencontroller  alle Benutzer, Gruppen und
	  Rechner aus der Active Directory-Domäne. Im nächsten Schritt wird die SYSVOL-Freigabe kopiert,
	  in der u.a. die Gruppenrichtlinien gespeichert werden.
	</para>

	<para>
	  Nun muss eine Anmeldung als <emphasis>Administrator</emphasis> am Active
	  Directory-Domänencontroller erfolgen und dort die Dateien mit den Gruppenrichtlinien aus der
	  SYSVOL-Freigabe des AD-Servers auf den UCS-Server kopiert werden.
	</para>

	<para>
	  Das aufzurufende Kommando wird im UMC-Modul angezeigt. Wenn es erfolgreich aufgerufen wurde,
	  muss mit <guimenu>Weiter</guimenu> bestätigt werden.

	  <figure>
		<title>Kopieren der Sysvol-Freigabe</title>
		<graphic scalefit="1" width="80%" fileref="illustrations/takeover3-de.png"/>
	  </figure>
	  
	  Wenn <command>robocopy</command> nicht vorhanden ist, kann es mit den Windows Server 2003
	  Resource Kit Tools nachinstalliert werden. Ab Windows 2008 ist es vorinstalliert.
	</para>

	<para>
	  Hinweis: Die robocopy-Option <emphasis>/mir</emphasis> spiegelt das Quellverzeichnis mit dem
	  Zielverzeichnis. Es muss beachtet werden das bei einem erneuten Aufruf des Tools Dateien, die
	  im Quellverzeichnis gelöscht wurden auch im Zielverzeichnis gelöscht werden.
	</para>

	<para>
	  Nach erfolgreichem Abschluss dieser Schritte sollten der/die AD-Domänencontroller 
	  heruntergefahren werden. Anschließend muss im UMC-Modul auf <guimenu>Weiter</guimenu> geklickt
	  werden.

	  <figure>
		<title>Herunterfahren des/der AD-Systeme</title>
		<graphic scalefit="1" width="80%" fileref="illustrations/takeover4-de.png"/>
	  </figure>
	</para>

	<para>
	  Die folgenden Schritte werden nun automatisch durchgeführt:

	  <itemizedlist>
		<listitem><simpara>
		  Übertragung der FSMO-Rollen auf den UCS-Domänencontroller. Diese kennzeichnen verschiedene
		  Aufgaben, die ein Server in einer AD-Domäne übernehmen kann.
		</simpara></listitem>

		<listitem><simpara>
		  Einrichten des Rechnernamens des AD-Servers als DNS-Alias (siehe <xref
		  linkend="ip-config:CNAME-Record_Alias-Records"/>) für den UCS-Server
		</simpara></listitem>

		<listitem><simpara>
		  Konfiguration der IP-Adresse des AD-Servers als zusätzliche virtuelle IP-Adresse des UCS-Servers
		</simpara></listitem>

		<listitem><simpara>
		  Verschiedene Anpassungen, z.B. Entfernen des alten AD-Domänencontroller-Eintrags aus der
		  Samba SAM-Datenbank.
		</simpara></listitem>

		<listitem><simpara>
		  Abschließender Neustart von Samba und DNS-Server
		</simpara></listitem>
	  </itemizedlist>
	</para>

  </section>

  <section id="windows:adtakeover:finalsteps">
	<title>Abschluß der Übernahme</title>
	<para>
	  Abschließend  müssen noch die folgenden Schritte durchgeführt werden:

	  <itemizedlist>
		<listitem><simpara>
		  Der Domänenfunktionslevel der migrierten AD-Domäne muss mit dem folgenden Kommando geprüft
		  werden:

		  <programlisting language="sh">
samba-tool domain level show
		  </programlisting>

		  Wenn das Kommando die Meldung <guimenu>ATTENTION: You run SAMBA 4 on a forest function
		  level lower than Windows 2000 (Native)</guimenu> anzeigt müssen die folgenden Befehle
		  aufgerufen werden:

		  <programlisting language="sh">
samba-tool domain level raise --forest-level=2003 --domain-level=2003
samba-tool dbcheck --fix --yes
		  </programlisting>
		</simpara></listitem>

		<listitem><simpara>
		  Gab es in der migrierten AD-Domäne mehr als einen Domänencontroller, müssen die
		  Rechnerkonten der weiteren Domänencontroller in der Rechnerverwaltung der UMC gelöscht
		  werden. Außerdem müssen sie aus der Samba SAM-Datenbank gelöscht werden. Dies kann
		  erfolgen, indem von einem migrierten Windows-Client eine Anmeldung als Mitglied der Gruppe
		  <emphasis>Domain Admins</emphasis> erfolgt und das AD-Verwaltungstool für Benutzer und
		  Computer aufgerufen wird.
		</simpara></listitem>

		<listitem><simpara>
		  Gibt es weitere Samba-Domänencontroller, müssen diese neu der Domäne beitreten.
		</simpara></listitem>

		<listitem><simpara>
		  Alle Windows-Clients müssen neu gestartet werden.
		</simpara></listitem>
	  </itemizedlist>
	</para>
  </section>

  <section id="windows:adtakeover:tests">
	<title>Tests</title>
	<para>
	  Es wird empfohlen nach der Übernahme gründliche Tests mit Windows-Clients durchzuführen, z.B.:

	  <itemizedlist>
		<listitem><simpara>
		  Anmeldung auf einem migrierten Client mit einem migrierten Benutzer
		</simpara></listitem>

		<listitem><simpara>
		  Anmeldung auf einem migrierten Client als Administrator
		</simpara></listitem>

		<listitem><simpara>
		  Test der Gruppenrichtlinien
		</simpara></listitem>

		<listitem><simpara>
		  Domänenbeitritt eines neuen Windows-Clients
		</simpara></listitem>

		<listitem><simpara>
		  Anlegen eines neuen Benutzers und Anmeldung an einem Windows-Client
		</simpara></listitem>
	  </itemizedlist>
	</para>
  </section>

</section>

</chapter>
