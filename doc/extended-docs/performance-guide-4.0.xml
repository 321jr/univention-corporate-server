<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE book PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
          "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [

  <!ENTITY % entities SYSTEM "../stylesheets/macros-en.ent" >

  %entities;
]>
<book lang="en" id="performance-guide-4.0">

<bookinfo>
  <title>Univention Corporate Server</title>
  <subtitle>Performance guide</subtitle>
	<revhistory>
		<revision>
			<revnumber>4.0-0</revnumber>
			<date>18 Nov 2014</date>
		</revision>
	</revhistory>
</bookinfo>

<chapter>
	<title>Introduction</title>
	<para>
		In its default configuration, UCS is suitable for environments with up to
		5,000 users.
	</para>
	<para>
		This document describes configuration modifications which can increase
		performance in larger environments.
	</para>
	</chapter>

<chapter id="slapd">
	<title>OpenLDAP and listener/notifier domain replication</title>
	<para>
		As a core element in the operation and administration of a UCS domain, the
		performance of the LDAP server plays a central role in the overall performance.
	</para>

	<section id="slapd:index">
		<title>Indices</title>
		<para>
			Comparable with other database systems, OpenLDAP runs indices about commonly
			requested attributes. For indexed attributes, a search is not performed via the
			full database contents, but over an optimized subsection.
		</para>
		<para>
			Mit neueren UCS Versionen werden die Indicies gelegentlich ergänzt und
			automatisch aktiviert.  Die automatische Aktivierung kann über die UCR-Variable
			<envar>ldap/index/autorebuild</envar> deaktiviert werden. In diesem Fall sollten die
			Indizes manuell gesetzt werden, damit es zu keinen Performance-Verlusten
			kommt. Gesteuert werden die Indizes durch die UCR-Variablen ldap/index/eq, ldap/index/pres,
			ldap/index/sub sowie ldap/index/approx. Nachdem die Variablen verändert wurden, muss der OpenLDAP-Server beendet und
			das Kommando <command>slapindex</command> ausgeführt werden.
		</para>
		<para>
			Um festzustellen, ob nicht indizierte Variablen verwendet werden, kann der
			OpenLDAP Debug Level -1 aktiviert werden und in der Logdatei /var/log/syslog nach der Zeichenkette 'not
			indexed' gesucht werden.  Beispielsweise:
			<programlisting>
ucr set ldap/debug/level=-1
invoke-rc.d slapd restart
grep 'not indexed' /var/log/syslog
			</programlisting>
		</para>
	</section>

	<section id="slapd:bdb">
		<title>Configuration of the database backend</title>
		<para>
			Seit UCS 4.0 wird für Neuinstallationen die Memory-Mapped-Datenbank (MDB)
			verwendet.  Sofern noch BDB verwendet wird, sollte auf MDB migriert werden. Das
			Datenbankbackend kann über die UCR Variable <envar>ldap/database/backend</envar> gesteuert
			werden.  Eine Migration kann wie folgt durchgeführet werden: 
			<programlisting>
/etc/init.d/slapd stop
slapcat -l ldif
mkdir /var/lib/univention-ldap/ldap.BACKUP
mv /var/lib/univention-ldap/ldap/* /var/lib/univention-ldap/ldap.BACKUP
ucr set ldap/database/backend=mdb
slapadd -l ldif
/etc/init.d/slapd start
			</programlisting>
			In the default configuration the memory mapped database needs more I/O operations than
			the BDB backend. With the &ucsUCRV; <envar>ldap/database/mdb/envflags</envar> this
			behavior can be configured. The following flags can be set (multiple values are
			separated by commas):
			<itemizedlist>
				<listitem><simpara>
					<envar>nosync</envar> specify that on-disk  database contents should not be
					immediately synchronized with in memory changes. Enabling 
					this option may improve performance at the expense of data security. In
					particular, if the operating system crashes before changes are flushed, some
					number of transactions may be lost.  By default, a full data flush/sync is
					performed when each transaction is committed.
				</simpara></listitem>
				<listitem><simpara>
					<envar>nometasync</envar> Flush the data on a commit, but
					skip the sync of the meta page. This mode is slightly faster than doing a full
					sync, but can potentially lose the last committed transaction if the operating
					system crashes. If both  nometasync  and  nosync  are set, the nosync flag takes
					precedence.
				</simpara></listitem>
				<listitem><simpara>
					<envar>writemap</envar> Use a writable memory map instead of
					just read-only. This speeds up write operations but makes the database
					vulnerable to corruption in case any bugs in slapd cause stray writes into the
					mmap region.
				</simpara></listitem>
				<listitem><simpara>
					<envar>mapasync</envar> When using a writable memory map and
					performing flushes on each commit, use an asynchronous flush instead of a
					synchronous flush (the default). This option has no effect if writemap has not
					been set. It also has no effect if nosync is set.
				</simpara></listitem>
				<listitem><simpara>
					<envar>nordahead</envar> Turn  off  file  readahead.
					Usually  the OS performs readahead on every read request. This usually boosts
					read performance but can be harmful to random access read performance if the
					system's memory is full and the DB is larger than RAM.
				</simpara></listitem>
			</itemizedlist>
		</para>
	</section>

	<section id="slapd:acl">
		<title>OpenLDAP ACLs</title>
		<para>
			Access to the information contained in the LDAP directory is controlled by
			access control lists (ACLs) on the server side. General information on the
			configuration of ACLs in UCS can be found in the LDAP chapter of the UCS
			manual.
		</para>
		<para>
			The default setting of the LDAP server does not allow anonymous access to the
			LDAP directory. If the &ucsUCRV; <envar>ldap/acl/read/anonymous</envar> is set
			to <literal>yes</literal>, these access restrictions do not apply and the
			LDAP performance is increased. Access to sensitive attributes such as user
			passwords remains protected via separate ACLs.
		</para>
	</section>

	<section id="listener">
		<title>Univention Directory Listener</title>
		<para>
			The Univention Directory Listener can perform safety
			checks to prevent a user name being added into a group twice.
			These checks add some overhead to replication and can
			be deactivated by setting the &ucsUCR; variables
			<envar>listener/memberuid/skip</envar> and
			<envar>listener/uniquemember/skip</envar> to <literal>no</literal>.
			Starting with UCS 3.1 the variables are not set and the checks are
			not activated any longer by default.
		</para>
	</section>
</chapter>

<chapter id="nscd">
	<title>Name Service Cache Daemon (NSCD)</title>
	<para>
		Name resolutions can be cached by the <emphasis>Name Service Cache
		Daemon</emphasis> (NSCD) in order to speed up frequently recurring requests for
		unchanged data. Thus, if a repeated request occurs, instead of querying the
		LDAP server, the data are simply drawn directly from the cache.
	</para>
	<para>
		The size of the cache held by the NSCD is preconfigured for an environment with
		5,000 users. If more users or hosts are created, the cache
		should be enlarged as otherwise it will not be possibly to cache enough
		entries.
	</para>
	<para>
		The following &ucsUCR; variables can be set:
	</para>
	<itemizedlist>
		<listitem>
			<simpara>
			<envar>nscd/hosts/size</envar> should be at least the same as the number
			of all the computers entered in the DNS.
			</simpara>
		</listitem>
		<listitem>
			<simpara>
			<envar>nscd/passwd/size</envar> should be at least the same as the number
			of users.
			</simpara>
		</listitem>
	</itemizedlist>
	<para>
		To allow an efficient cache allocation, the value selected should always be a
		prime number, in case of doubt the next highest prime number should be
		selected.
	</para>
	<para>
		A script can be downloaded from
		<ulink url="http://download.univention.de/download/scripts/nscdCachesize.sh"/>
		which suggests corresponding values based on the objects currently included in
		the system.
	</para>
</chapter>

<chapter id="group:cache">
	<title>Local group cache</title>

	<para>
		In the default setting, the group cache is regenerated every time changes are
		made to a group. This avoids cache effects whereby group memberships only
		become visible for a service after the next scheduled group
		cache rewrite (in the default setting after 15 minutes and
		after 15 seconds of inactivity in the &ucsUDL;. In
		larger environments with a lot of group changes, this function should be
		deactivated by setting the &ucsUCRV;
		<envar>nss/group/invalidate_cache_on_changes</envar> to
		<literal>false</literal>. This setting takes effect immediately and does not
		require a restart of the Univention Directory Listener.
	</para>

	<para>
	  When the group cache file is being generated, the script verifies whether the group members
	  are still present in the LDAP directory. If only the &ucsUMC; is used for the management of
	  the LDAP directory, this additional check is not necessary and can be disabled by setting the
	  &ucsUCRV; <envar>nss/group/cachefile/check_member</envar> to <literal>false</literal>.
	</para>

</chapter>


<chapter>
  <title>UCS management system</title>

  <section id="umc:search:auto">
	<title>Disabling automatic search</title>
	<para>
	  By default all objects are automatically searched for in the domain management
	  modules of the &ucsUMC;. This behaviour can be disabled by setting the
	  &ucsUCRV; <envar>directory/manager/web/modules/autosearch</envar> to
	  <literal>0</literal>.
	</para>
  </section>

  <section id="umc:search:limit">
	<title>Imposing a size limit for searches</title>
	<para>
	  The &ucsUCRV; <envar>directory/manager/web/sizelimit</envar> is used to impose an upper limit
	  for search results. If, e.g., this variable is set to 2000 (as is the default), searching for
	  more than 2000 users would not be performed and instead the user is asked to refine the
	  search.
	</para>
  </section>
</chapter>


<chapter>
	<title>Further services and components</title>
	<section id="squid">
		<title>Squid</title>
		<para>
			If the Squid proxy service is used with NTLM authentication,
			up to five running NTLM requests can be processed in parallel.
			If many proxy requests are received in parallel, the
			Squid user may occasionally receive an authentication error. The number
			of parallel NTLM authentication processes can be configured with
			the &ucsUCRV; <envar>squid/ntlmauth/children</envar>.
		</para>
	</section>

	<section id="bind">
		<title>Bind</title>
		<para>
		  Bind can use two different backends for its configuration: OpenLDAP or the internal LDB
		  database of Samba 4. The backend is configured via the &ucsUCRV;
		  <envar>dns/backend</envar>.
		</para>

		<para>
		  When using the Samba backend, a search is performed in the LDAP for every DNS
		  request. With the OpenLDAP backend, a search is only performed in the directory service if
		  the DNS data has changed. For this reason, using the OpenLDAP backend can reduce the load
		  on a Samba 4 domain controller.
		</para>
	</section>

	<section id="kernel">
		<title>Kernel</title>
		<para>
			In medium and larger environments the maximum number of open files allowed by the Linux kernel may be set too low by default.
			As each instance requires some unswappable memory in the Linux kernel, too many objects may lead to a resource and denial-of-service problems in multi-user environments.
			Because of that the number of allowed file objects is limited by default.
		</para>
		<para>
			The maximum number of open files can be configured on a per-user or per-group basis.
			The default for all users can set through the following &ucsUCRV;s:
		</para>
		<variablelist>
			<varlistentry>
				<term><envar>security/limits/user/<replaceable>default</replaceable>/hard/nofile</envar></term>
				<listitem>
					<simpara>
						The hard limit defines the upper limit a user can assign to a process.
						The default is 32768.
					</simpara>
				</listitem>
			</varlistentry>
			<varlistentry>
				<term><envar>security/limits/user/<replaceable>default</replaceable>/soft/nofile</envar></term>
				<listitem>
					<simpara>
						The soft limit defines the default settings for the processes of the user.
						The default is 32768.
					</simpara>
				</listitem>
			</varlistentry>
		</variablelist>
		<para>
			A similar problem exists with the <wordasword>Inotify</wordasword> sub-system of the kernel, which can be used by all users and  applications to monitor changes in file systems.
		</para>
		<variablelist>
			<varlistentry>
				<term><envar>kernel/fs/inotify/max_user_instances</envar></term>
				<listitem>
					<simpara>
						The upper limit of Inotify services per user ID.
						The default is 511.
					</simpara>
				</listitem>
			</varlistentry>
			<varlistentry>
				<term><envar>kernel/fs/inotify/max_user_watches</envar></term>
				<listitem>
					<simpara>
						The upper limit of files per user which can be watched by the Inotify service.
						The default is 32767.
					</simpara>
				</listitem>
			</varlistentry>
			<varlistentry>
				<term><envar>kernel/fs/inotify/max_queued_events</envar></term>
				<listitem>
					<simpara>
						The upper limit of queued events per Inotify instance.
						The default is 16384.
					</simpara>
				</listitem>
			</varlistentry>
		</variablelist>
	</section>

	<section id="samba">
		<title>Samba</title>
		<para>
			Samba uses its own mechanism to specify the maximum number of open files.
			This can be configured through the &ucsUCRV; <envar>samba/max_open_files</envar>.
			The default is 32808.
		</para>
		<para>
			If the log file <filename>/var/log/samba/log.smbd</filename> contains errors like <computeroutput>Failed to init inotify - Too many open files</computeroutput>, the kernel and Samba limits should be increased and the services should be restarted.
		</para>
	</section>

	<section id="systemstats">
		<title>Systemstatisken</title>
		<para>
			Für weitere Performance Analysen kann die Logdatei
			<filename>/var/log/univention/system-stats.log</filename> geprüft werden. Alle 30 Minuten
			wird der Systemstatus protokolliert. Sofern die Protokollierung häufiger erfolgen soll,
			kann dies über die UCR-Variable <envar>system/stats/cron</envar> gesteuert werden.
		</para>
	</section>
</chapter>
<?dbhtml-include href="../stylesheets/piwik.html"?>
</book>
