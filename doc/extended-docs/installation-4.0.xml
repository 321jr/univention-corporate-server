<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE book PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
          "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [

  <!ENTITY % entities SYSTEM "../stylesheets/macros-en.ent" >

  %entities;
]>
<book lang="en" id="installation-4.0">
<bookinfo>
  <title>Univention Corporate Server</title>
  <subtitle>Extended installation documentation</subtitle>
</bookinfo>

<chapter id="appliance:use">
  <title>Using a UCS appliance</title>

  <para> 
	In addition to the traditional installation, there is also the possibility of providing UCS via
	an appliance image. These appliance images can be used both for simple commissioning in a
	virtualization solution such as VMware and for providing a cloud instance.
  </para>

  <para> 
	Appliances can be created with minimal effort. This is described in <xref
	linkend="appliance:create"/>.
  </para>

  <para> 
	Whilst some of the settings can be preconfigured globally in the image, it is still necessary
	for the end user to make final adjustments to the configuration, e.g., to set the computer name
	or the domain used. For this reason, a basic system is installed for the appliance image and a
	component set up, which then allows the end user to finalise the configuration. Alternatively,
	the configuration can also be performed automatically without user interaction. This is
	described in <xref linkend="appliance:use:auto"/>.
  </para>

  <para> 
	The interactive configuration can be performed in two ways:

	<itemizedlist>
	  <listitem><simpara>
		A graphic interface starts on the system, in which the web browser Firefox is started in
		full-screen mode and automatically accesses the configuration URL. This option is
		particularly suitable for images in virtualization solutions.
	  </simpara></listitem>

	  <listitem><simpara>
		The configuration can also be performed directly via an external web browser. In this case,
		the system's IP address must be known to the user (e.g., if it has been notified to him in
		advance in the scope of the provision of a cloud image).
	  </simpara></listitem>
	  
	</itemizedlist>
  </para>

  <para> 
	In the scope of the initial configuration, the user can change the following settings in the
	default setting:

	<itemizedlist>
	  <listitem><simpara>
		Selection of the language, time zone and keyboard layout
	  </simpara></listitem>

	  <listitem><simpara>
		Configuration of the network settings
	  </simpara></listitem>
	  
	  <listitem><simpara>
		Setup of a new UCS domain or joining a UCS or Microsoft Active Directory domain
	  </simpara></listitem>
	  
	  <listitem><simpara>
		Software selection of UCS key components. The user can install software from other
		vendors at a later point in time via the Univention App Center.
	  </simpara></listitem>
	</itemizedlist>
  </para>

</chapter>



<chapter id="appliance:create">
  <title>Creating a UCS appliance/cloud image</title>

  <section id="appliance:intro">
	<title>Introduction</title>

	<para> 
	  This article describes how to set up an appliance based on UCS 4.0. This type of appliance can
	  also be used to provide preconfigured instances as a cloud service provider. The
	  creation of images for typical virtualization solutions is another possible application
	  scenario, see <xref linkend="appliance:create:virt"/>.
	</para>

  </section>

  <section id="appliance:installbase">
	<title>Performing the basic installation</title>

	<para> 
	  The basic installation is performed using the standard UCS installer. Further information on
	  the individual options can be found in the UCS manual. The installation should be performed in
	  a virtualization solution. In this example, the installation is performed in UVMM. A QCOW2
	  image should be selected for the hard drive for the virtual machine.  QCOW2 images can be
	  converted to different virtualization formats such as VirtualBox or VMWare using a tool
	  provided by Univention, see <xref linkend="appliance:create:virt"/>.
	</para>

	<para> 
	  The following settings are configured for the basic image:

	  <itemizedlist>
		<listitem><simpara>
		  The installation language can be selected as required. The locale of the system is set
		  based on the selected language. If you want to be able to use the appliance in more than
		  one language, you can add another locale at a later point in time.
		</simpara></listitem>

		<listitem><simpara>
		  A preselection is made for the time zone which is then adapted subsequently by the users
		  of the appliance.
		</simpara></listitem>

		<listitem><simpara>
		  The keyboard layout is only relevant for local logins; it is not important for the web-based
		  configuration.
		</simpara></listitem>

		<listitem><simpara>
		  A configuration via DHCP is the most practical presetting for appliance images. The
		  Univention Installer attempts to perform a DHCP request in the scope of the network
		  configuration. The network configuration is only performed via DHCP if this is successful,
		  i.e., an IP address must be assigned to the appliance for the duration of the setup. This
		  can be done with an <emphasis>IP managed client</emphasis> object in the &ucsUMC;.
		</simpara></listitem>

		<listitem><simpara>
		  In the next step, the initial password is set for the root user. This root password is
		  changed by the end user during the commissioning of the appliance image.
		</simpara></listitem>

		<listitem><simpara>
		  The partitioning can be performed as required, e.g., by using an LVM.
		</simpara></listitem>
	  </itemizedlist>
	</para>

	<para> 
	  Once the basic installation is complete, a dialogue is shown in which you can select whether
	  to create a new UCS domain or join an existing domain. To create the appliance, CTRL+q
	  must be pressed at this point to interrupt the process. The installation continues for a short
	  period of time, during which the <guimenu>Starting Univention System Setup</guimenu> message
	  appears and the systems then restarts. 
	</para>

	<para> 
	  The installation of the basic image is now complete. Following a reboot, the user of the
	  appliance is shown the dialogue for adjusting the configuration, see <xref
	  linkend="appliance:use"/>.
	</para>

	<para> 
	  In most cases, the appliance needs to be preconfigured with a certain selection of
	  software. The installation is usually performed via the Univention App Center, which, however,
	  is not yet available at this point in time. The installation is thus performed via the command
	  line. UCS standard components can be installed using the corresponding package names, e.g.

	  <programlisting>
univention-install univention-printserver
	  </programlisting>

	  Packages from the Univention App Center are installed with the command
	  <command>univention-add-app</command>.  The ID of an application can be retrieved with the
	  command <command>univention-add-app --list</command>:

	  <programlisting>
univention-add-app -l APPID
	  </programlisting>
	</para>

	<para> 
	  The system now needs to be shut down cleanly without filesystems still being mounted. This can
	  be done by restarting the system and then shutting it down in UVMM when the
	  system displays the Grub menu.
	</para>

	<para> 
	  The QCOW image (i.e., the hard drive of the virtual machine) is now copied. If the
	  <emphasis>default</emphasis> storage pool of UVMM was used, the image is stored in the
	  directory <filename>/var/lib/libvirt/images</filename>.
	</para>

	<para> 
	  Additional steps are required if the image is to be used in Amazon EC2, see <xref
		linkend="appliance:create:ec2"/>.
	</para>

	<section id="appliance:create:ec2">
	  <title>Providing an image for Amazon EC2</title>
	  <para>
		The following adjustments need to be made for an image that is to be used in Amazon
		EC2.
	  </para>

	  <para>
		Amazon EC2 uses a PyGrub version which can only read the data format from Grub 1 (menu.lst),
		whilst UCS uses Grub 2 as the bootloader. The following &ucsUCR; variables can be
		used to generate the Grub configuration in this format additionally. The bootloader
		configuration is also adapted:

		<programlisting>
append="$(ucr get grub/append)"
ucr set grub/append="$(echo "$append" | sed -e 's|/dev/sda|/dev/xvda|g;s|splash|nosplash|')"
ucr set grub/root=/dev/xvda1
ucr set grub/grub1root="(hd0)"
update-initramfs -uk all
update-grub
univention-grub-generate-menu-lst
		</programlisting>
	  </para>

	  <para>
		The initial login to the EC2 instance is performed via a SSH host key. To prevent SSH logins
		from occurring with the default root password of the standard image during commissioning of
		the instance, the initial root password is removed. The two &ucsUCR; variables configure this start mode:

		<programlisting>
usermod -p \* root
ucr set server/amazon=true
ucr set apache2/startsite="ucs-overview/initialsetup.html"
		</programlisting>
	  </para>

	  <para>
		The name server should be set; in this example to OpenDNS:
 
		<programlisting>
ucr set nameserver1=208.67.222.222 dns/forwarder1=208.67.222.222
ucr unset nameserver2 nameserver3
ucr unset dns/forwarder2 dns/forwarder3
		</programlisting>
	  </para>
	</section>

	<section id="appliance:create:openstack">
	  <title>Providing an image for OpenStack</title>
	  <para>
		The provisioning for OpenStack images occurs via Cloud-Init  (see
		<xref linkend="appliance:use:cloudinit"/>). No additional adjustments are necessary.
	  </para>
	</section>

	<section id="appliance:create:virt">
	  <title>Providing an image for VMWare/VirtualBox</title>
	  <para>
		Virtualization images for VirtualBox, VMware Player and Vmware ESX(i) can also be created on
		the basis of the QCOW images above. To this end, Univention offers a tool, which can be
		installed via the <package>generate-appliance</package> package (the integration in UCS 4.0
		can be followed via Bug 37137).
	  </para>

	  <para>
		The <command>generate_appliance</command> tool must be started and the QCOW
		image selected with the parameter <emphasis>-s</emphasis>:

		<programlisting>
generate_appliance -s appliance.qcow2
		</programlisting>

		The virtual machine is assigned one CPU and a gigabyte of RAM as standard. If the appliance
		has a higher storage or CPU power requirement, the parameter <emphasis>-m</emphasis> can be
		used to specify a different quantity of RAM in megabytes and <emphasis>-c</emphasis> can be
		used to assign a different number of CPUs.

		The parameters <emphasis>--vendor</emphasis> and <emphasis>--product</emphasis> can be used
		to specify a vendor and product name.
	  </para>

	  <para>
		In the default setting, three different virtualization images are generated from the QCOW
		image. The generation for a type can be suppressed using the respectively given option:

		<itemizedlist>
		  <listitem><simpara>
			Zipped VMware-compatible images (e.g. for VMWare Player), can be suppressed with <emphasis>--no-vmware</emphasis>
		  </simpara></listitem>

		  <listitem><simpara>
			VirtualBox OVA image, can be suppressed with <emphasis>--no-ova-virtualbox</emphasis>
		  </simpara></listitem>

		  <listitem><simpara>
			VMWare ESX(i) OVA image, can be suppressed with <emphasis>--no-ova-esxi</emphasis>
		  </simpara></listitem>
		</itemizedlist>
	  </para>

	</section>




  </section>


  <section id="appliance:use:auto">
	<title>Automatic configuration of an appliance</title>
	<para>
	  Instead of an interactive configuration of the appliance by the user,
	  it can also be performed automatically. The automatic configuration can either be performed
	  via Cloud-Init (a general tool for the provision of cloud images) or a Univention appliance
	  mode profile file.
	</para>

	<section id="appliance:use:auto:profile">
	  <title>Automatic configuration with a UCS appliance mode profile file</title>
	  
	  <para>
		Automatic configuration with the UCS appliance mode requires creating a profile file
		<filename>/var/cache/univention-system-setup/profile</filename>. Example configuration:

		<programlisting>
hostname="ucs"
domainname="testdom.local"
windows/domain="TESTDOM"
ldap/base="dc=testdom,dc=local"
root_password="univention"
 
locale/default="de_DE.UTF-8:UTF-8"
components="univention-s4-connector:univention-samba4 univention-nagios-server"
packages_install="univention-s4-connector univention-samba4 univention-nagios-server"
packages_remove=""

server/role="domaincontroller_master"
 
interfaces/eth0/type=""
interfaces/eth0/address="10.201.101.2"
interfaces/eth0/netmask="255.0.0.0"
interfaces/eth0/network="10.0.0.0"
interfaces/eth0/broadcast="10.255.255.255"
dns/forwarder1="10.201.74.2"
gateway="10.201.0.1"
		</programlisting>

		If <emphasis>interfaces/eth0/type</emphasis> is set to <emphasis>dynamic</emphasis>, DHCP is
		used for the network configuration.
	  </para>

	  <para>
		Then the <command>/usr/lib/univention-system-setup/scripts/setup-join.sh</command> tool
		needs to be run once. Then Apache and the UMC server need to be restarted:

		<programlisting>
invoke-rc.d apache2 restart
invoke-rc.d univention-management-console-server restart
		</programlisting>
	  </para>
	</section>

	<section id="appliance:use:cloudinit">
	  <title>Automatic configuration of an appliance with Cloud-Init</title>
	  <para>
		Cloud-Init is a standardised solution for configuration of an image. Cloud-Init checks a
		range of data sources for an existing configuration. The <package>cloud-init</package>
		package must be installed to prepare an image for provisioning via Cloud-Init:

		<programlisting>
univention-install cloud-init
		</programlisting>

		The configuration file is provided by the respective cloud service; the type of provision
		differs from cloud solution to cloud solution. It is currently only possible to provide a
		&ucsMaster;.
	  </para>

	  <para>
		The following includes an example file with which a &ucsMaster; can be provided. In
		addition, two files are generated on the system: the UCS license to be installed and a file
		with the apps to be installed from the Univention App Center. The files specified are base64-encoded
		The <command>base64</command> and <command>base64 --decode</command> commands can
		be used to encode and decode files. The <emphasis>content</emphasis> entry needs to be
		specified as a consecutive line:

		<programlisting>
ucs_setup:
  hostname: myucsmaster
  domainname: ucs.local
  windowsdomain: UCS
  ldap_base: dc=ucs,dc=local
  rootpassword: univention
  defaultlocale: de_DE.UTF-8:UTF-8
  components:
  packages_install:
  packages_remove:
write_files:
-   encoding: b64
    content:
	ZG46IGNuPWFkbWluLGNuPWxpY2Vuc2UsY249dW5pdmVudGlvbixkYz11Y3MsZGM9bG9\
    jYWwKY246IGFkbWluCm9iamVjdENsYXNzOiB0b3AKb2JqZWN0Q2xhc3M6IHVuaXZlbn\
    Rpb25MaWNlbnNlCm9iamVjdENsYXNzOiB1bml2ZW50aW9uT2JqZWN0CnVuaXZlbnRpb\
    25MaWNlbnNlQmFzZUROOiBGcmVlIGZvciBwZXJzb25hbCB1c2UgZWRpdGlvbgp1bml2\
    ZW50aW9uTGljZW5zZUNvcnBvcmF0ZUNsaWVudHM6IHVubGltaXRlZAp1bml2ZW50aW9\
    uTGljZW5zZUVuZERhdGU6IHVubGltaXRlZAp1bml2ZW50aW9uTGljZW5zZUtleUlEOi\
    A0MDBkM2IzMS02YWMxLTQwNTgtOTc2Ny1jNTY5Zjk4Mzc1YmEKdW5pdmVudGlvbkxpY\
    2Vuc2VNYW5hZ2VkQ2xpZW50czogNQp1bml2ZW50aW9uTGljZW5zZU1vZHVsZTogYWRt\
    aW4KdW5pdmVudGlvbkxpY2Vuc2VQcmVtaXVtU3VwcG9ydDogMAp1bml2ZW50aW9uTGl\
    jZW5zZVNlcnZlcnM6IHVubGltaXRlZAp1bml2ZW50aW9uTGljZW5zZVNpZ25hdHVyZT\
    ogWllwVmVLWkhXSkVIVFdMTEhYZTB0ZS9NZTh6cis5SnpCMUYvNFV5RkxPc3JQa3hLC\
    iArS0I3Q0tFbmpGVFg3NnBRN1BMYmhHWHR4VEJDOUlXdzV1T0EzTzdUNEd1ZzU3c1RO\
    TVRnR0FMTzF0Vldxa1cxaFQ5OE9NSW5yUFcKIHlIZmVsVmZGa2hjNEJxQVhCOTlSc1M\
    xY1h0Rm1tWE0xQWF1ekNkOUFqVEFQZm9NSFBmTE9HL1JRVXdGSVU2SjZWaUlMd2p0dG\
    Z1YQogZnZKOWpLNGR1REliTXNSRWxSejNZQkk3M1FwSy9CcG04WXZTd0ZvVGF0RW9kS\
    mJ0RzRIUTNkL2kxV2dPd20wVUdaK3BtNWl1Vm45CiBTN0RnOXorTXdVZ05TUmk2dmdu\
    d2F2cVl0NHVtMGhTTHZJOUsvaWVia3BoRW52RVlOb2NFN0xSKy9MSjBBT21XMm5CeXc\
    9PQp1bml2ZW50aW9uTGljZW5zZVN1cHBvcnQ6IDAKdW5pdmVudGlvbkxpY2Vuc2VUeX\
    BlOiBVQ1MKdW5pdmVudGlvbkxpY2Vuc2VVc2VyczogNQp1bml2ZW50aW9uTGljZW5zZ\
    VZlcnNpb246IDIKdW5pdmVudGlvbkxpY2Vuc2VWaXJ0dWFsRGVza3RvcENsaWVudHM6\
    IHVubGltaXRlZAp1bml2ZW50aW9uTGljZW5zZVZpcnR1YWxEZXNrdG9wVXNlcnM6IHV\
    ubGltaXRlZAp1bml2ZW50aW9uT2JqZWN0VHlwZTogc2V0dGluZ3MvbGljZW5zZQoK
    owner: root:root
    path: /var/cache/univention-system-setup/license
    permissions: '0400'
-   encoding: b64
    content: YWRjb25uZWN0b3IKc2ltcGxlc2FtbHBocAo=
    owner: root:root
    path: /var/cache/univention-system-setup/installapps
    permissions: '0400'
		</programlisting>
	  </para>

	  <para>
		The file with the apps to be installed contains a list of IDs of applications from the
		Univention App Center, see <xref linkend="appliance:installbase"/>. The list in the example
		above looks like this when decoded, i.e., the Univention AD Connector and the SAML
		integration are installed on the provided &ucsMaster;:

		<programlisting>
adconnector
simplesamlphp
		</programlisting>
	  </para>
	</section>

	<section id="appliance:license">
	  <title>License management in cloud instances</title>	
	  <para>
		In the default installation, a UCS installation has a so-called <emphasis>free for personal
		use license</emphasis> (up to five users). A license from Univention is required for the
		productive use of a UCS installation. For standard installations it is sent to the user by
		e-mail and then set up in the &ucsUMC;.
	  </para>

	  <para>
		Cloud service providers have the possibility of retrieving UCS licenses via an API, i.e., if
		a new instance is to be created for a customer, the license can be retrieved via the API and
		then installed in the provided instance directly.
	  </para>

	  <para>
		Access to the license server requires a user name and a password. These can be requested
		from Univention at sales@univention.de. In this document,
		<uri>https://license.univention.de/shop/example/</uri> is used as an example URL for the
		license server.
	  </para>

	  <section id="appliance:license:api">
		<title>API for retrieving UCS licenses</title>
		<para>
		  The licenses are retrieved via HTTPS from the Univention license server
		  <uri>license.univention.de</uri>. The retrieval can be performed completely with
		  <command>wget</command>.
		</para>

		<para>
		  Firstly, a session with the license server must be opened, in this case with the user name
		  <emphasis>univention</emphasis> and the password <emphasis>secret</emphasis> as an
		  example. It is also possible to request more than one license in one session.

		  <programlisting>
wget --keep-session-cookies --save-cookies cookie.db --load-cookies \ 
 cookie.db --post-data='username=univention&amp;password=secret' \
 https://license.univention.de/shop/example/
		  </programlisting>
		</para>

		<para>
		  A license can also be ordered with a POST request via wget. Please note that special
		  characters such as blank spaces must be escaped in URL-encoded syntax, see
		  <uri>http://en.wikipedia.org/wiki/Percent-encoding</uri> for details.

		  <programlisting>
wget --keep-session-cookies --save-cookies cookie.db --load-cookies cookie.db \
--post-data='kundeEmail=customer@example&amp;'\
'kundeUnternehmen=New%20Customern&amp;'\
'EndDate=27.11.2015&amp;'\
'BaseDN=dc%3Ddrei%2Cdc%3Dzwei%2Cdc%3Dtest&amp;'\
'Servers=0&amp;'\
'Support=0&amp;'\
'PremiumSupport=0&amp;'\
'Users=100&amp;'\
'ManagedClients=0&amp;'\
'CorporateClients=0&amp;'\
'VirtualDesktopUsers=0&amp;'\
'VirtualDesktopClients=0&amp;'\
'Type=UCS' \
https://license.univention.de/shop/example/order
		  </programlisting>
		</para>

		<para>
		  If the order is successful, the return code 202 is returned. The HTML data includes the tag
		  <emphasis>orderid</emphasis>, which identifies the order number of a successful order:

		  <programlisting>
...
&lt;span id="orderid"&gt;21&lt;/span&gt;
...
		  </programlisting>
		</para>

		<para>
		  If the order fails, a return code 4xx is returned and the <emphasis>details</emphasis> tag
		  includes additional information, e.g.:

		  <programlisting>
...
&lt;span id="details"&gt;Not a valid date: u'27.11.201'&lt;/span&gt;
...
		  </programlisting>
		</para>

		<para>
		  Should it not be possible to process an order due to a server error, 5xx is output as the
		  return code. The order can then be repeated at a later point in time.
		</para>

		<para>
		  Following ordering of a license, it takes a few seconds before the license is
		  generated. It can then be retrieved in LDIF format using the order number. If the request
		  above returns e.g. the order number 465, the file name is thus <filename>465.ldif</filename>.
		  The request specified below waits for the availability of the license for up to sixty seconds:

		  <programlisting>
wget --keep-session-cookies --save-cookies cookie.db --load-cookies cookie.db \
https://license.univention.de/shop/example/orders/465.ldif 
		  </programlisting>

		</para>

	  </section>
	</section>


  </section>



</chapter>

<!-- <bibliography> -->
<!--   <bibliomixed id="ucs-handbuch"/> -->
<!--   <bibliomixed id="locales"/> -->
<!-- </bibliography> -->

<?dbhtml-include href="../stylesheets/piwik.html"?>
</book>
