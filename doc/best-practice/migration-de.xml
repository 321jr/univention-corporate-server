<chapter>
  <title>Migration einer Active Directory-Domäne nach &ucsUCS;</title>
  <section>
	<title>Einleitung</title>
	<para>
	  Diese Dokumentation beschreibt das Vorgehen bei der Migration einer Microsoft Active
	  Directory-Domäne auf Basis von Windows Server 2003/2008/2012 auf &ucsUCS;. Der
	  Domänencontroller-Dienst wird durch UCS in AD-kompatibler Weise bereitgestellt: Ein
	  Windows-Client, der in die AD-Domäne gejoint wurde, ist nach der Migration auch in der
	  UCS-Domäne verfügbar, d.h. es ist kein erneuter Domänenbeitritt nötig. Das komplette Inhalt
	  des AD-LDAP-Verzeichnis wird migriert (und somit auch all alle Benutzerkonten und Gruppen).
	</para>

	<para>
	  In dieser Dokumentation werden zwei Szenarien unterschieden:

	  <itemizedlist>
		<listitem><simpara>
		  Migration einer Umgebung mit nur einem Domänencontroller (z.B. Microsoft
		  Small Business Server) (<xref linkend="bestpractice:migration:single"/>)
		</simpara></listitem>

		<listitem><simpara>
		  Migration einer verteilten Active Directory-Umgebung mit mehreren Domänencontrollern
		  (z.B. für verteilte Standorte oder für große Umgebungen) (<xref linkend="bestpractice:migration:distrib"/>)
		</simpara></listitem>
	  </itemizedlist>
	</para>

	<para>
	  Neben der Migration der Kern-Domänendienste (Benutzeranmeldungen, Client-Integration) können
	  auch Datei-/Druckdienste auf UCS migriert werden (<xref linkend="bestpractice:migration:services"/>).
	</para>
  </section>

  <section id="bestpractice:migration:single">
	<title>Migration einer AD-Domäne mit einem Domänencontroller (Single-Server-Umgebung)</title>

	<section id="bestpractice:migration:single:intro">
	  <title>Einleitung</title>

	  <para>
		Jede UCS-Umgebung besteht aus min. einem &ucsMaster; und einer beliebigen Anzahl weiterer
		Server. So besteht beispielsweise die Möglichkeit an verschiedenen Standorten einen lokalen
		Server zu betreiben.
	  </para>

	  <para>
		Diese Variante der Migrations-Dokumentation beschreibt die Migration des
		AD-Domänencontrollers auf einen einzelnen UCS-Domänencontroller. Wenn die Umgebung später
		wächst oder aus anderen Gründen verteilt werden soll, ist eine Aufteilung von Diensten
		jederzeit nachträglich möglich.
	  </para>

	</section>

	<section id="bestpractice:migration:single:installucs">
	  <title>Installation des UCS-Systems</title>
	  <para>
		Für die Migration wird ein separater Server mit UCS installiert. Die Installation des
		Systems kann anhand des UCS-Quickstart Guides erfolgen (TODOREF). Bei der Installation müssen
		die folgenden Einstellungen gewählt werden:

		<itemizedlist>
		  <listitem><simpara>
			<emphasis>Sprache</emphasis>, <emphasis>Zeitzone</emphasis>, <emphasis>Tastaturbelegung</emphasis>: Beliebig
		  </simpara></listitem>

		  <listitem><simpara>
			<emphasis>Systemrolle</emphasis>: Domain Controller Master
		  </simpara></listitem>

		  <listitem><simpara>
			<emphasis>Vollständiger Rechnername</emphasis>: Dieser Wert besteht aus dem Rechnernamen und dem
			Domänennamen. In <emphasis>server1.company.example</emphasis> ist
			<emphasis>server1</emphasis> der Rechnername und <emphasis>company.example</emphasis>
			der Domänenname. Der Rechnername kann beliebig gewählt werden, darf aber in der
			zu migrierenden AD-Domäne noch nicht in Verwendung sein. Als Domänenname muss der
			AD-Domänenname verwendet werden (er wird z.B. in der Windows-Systemsteuerung unter
			<guimenu>System und Sicherheit -> System</guimenu> im Feld <guimenu>Domäne</guimenu>
			angezeigt.
		  </simpara></listitem>

		  <listitem><simpara>
			<emphasis>LDAP-Basis</emphasis> und <emphasis>Windows-Domäne</emphasis> werden auf Basis
			des vollständigen Rechnernamens vorschlagen, hier sollte der vom Installationsdialog vorgeschlagene Wert
			übernommen werden.
		  </simpara></listitem>

		  <listitem><simpara>
			<emphasis>Root-Passwort</emphasis>: Das hier konfigurierte Passwort ist auch das
			initiale Passwort für das <emphasis>Administrator</emphasis>-Konto auf dem UCS-Server. Hier sollte dasselbe
			<emphasis>Administrator</emphasis>-Passwort wie in der AD-Domäne verwendet werden.
		  </simpara></listitem>

		  <listitem><simpara>
			<emphasis>Partitionierung</emphasis>: Beliebig, es wird empfohlen die automatische
			Partitionierung zu verwenden.
		  </simpara></listitem>

		  <listitem><simpara>
			<emphasis>Netzwerk-Konfiguration</emphasis>: Es muss eine IPv4-Adresse aus dem Subnetz
			des zu migrierenden AD-Domänencontrollers verwendet werden.
		  </simpara></listitem>

		  <listitem><simpara>
			Die Softwareauswahl kann komplett leer gelassen werden. Alle benötigten Applikationen
			werden später aus dem Univention App Center installiert.
		  </simpara></listitem>
		</itemizedlist>
	  </para>

	  <para>
		Wenn die Installation abgeschlossen ist, muss das UCS-System durch einen Tastendruck neu
		gestartet werden. Der UCS-Server ist nun installiert, enthält aber noch nicht die
		Benutzerdaten der AD-Domäne. Diese werden in einem späteren Schritt migriert.
	  </para>

	</section>


	<section id="bestpractice:migration:test">
	  <title>Testlauf einer Migration</title>
	  <para>
		Die hier beschriebene Migration kann komplett vorab getestet werden. Dies ist sinnvoll, um
		potentielle Probleme vorab zu ermitteln und ein Zeitfenster für die Migration ankündigen zu
		können:

		<itemizedlist>
		  <listitem><simpara>
			Wenn der AD-Server virtualisiert ist, kann ein Clone des AD-Servers migriert werden.
		  </simpara></listitem>

		  <listitem><simpara>
			Wird die AD-Migration im AD-Takeover an der Stelle abgebrochen wird, an der normalerweise der
			AD-Server heruntergefahren würde, können alle Funktionen wie Domänenanmeldungen, GPOs
			etc. trotzdem getestet werden. Die während des Takeovers eingerichtete Replikation der
			Verzeichnisdaten ist unidirektional von AD nach UCS, d.h. wenn während der Testphase
			Änderungen in der &ucsUMC; durchgeführt werden, werden diese nicht an das AD übertragen.
			Wird ein AD-Takeover für eine Testmigration abgebrochen, sollte das Rechnerkonto des
			UCS-Servers vor der eigentlichen produktiven Migration aus den Rechnerkonten des Active
			Directory gelöscht werden.
		  </simpara></listitem>
		</itemizedlist>
	  </para>
	</section>

	<section id="bestpractice:migration:single:services">
	  <title>Migration der Dienste des AD-Systems</title>

	  <para>
		Die Daten aus dem Verzeichnisdienst (z.B. Benutzer, Gruppen und Rechnerkonten) sowie die
		Gruppenrichtlinieninformationen werden im Rahmen der Übernahme der AD-Domäne automatisch
		nach UCS migriert. Nach Durchführung der Migration ist der AD-Domänencontroller nicht mehr verfügbar. D.h. wenn
		auf dem AD-Domänencontoller über den Anmeldedienst hinaus noch Dienste betrieben werden, müssen diese
		ebenfalls migriert werden. Hierfür gibt es prinzipiell zwei verschiedene Vorgehensweisen:

		<itemizedlist>
		  <listitem><simpara>
			Die Migration der Dienste auf den UCS-Server. Dies wird in <xref
			linkend="bestpractice:migration:fileshare"/> für Datei-Freigaben und in <xref
			linkend="bestpractice:migration:single:services:migrate:printshare"/> für Drucker-Freigaben
			beschrieben. Das Univention App Center bietet darüberhinaus verschiedene Applikationen zur
			Installation an, die ebenfalls bestehende Software wie z.B. Microsoft Exchange ersetzen
			können (<xref linkend="bestpractice:migration:appcenter"/>)
		  </simpara></listitem>

		  <listitem><simpara>
			Installation eines Member-Servers in der AD-Domäne und Migration der Dienste auf diesen
			Server. Der Memberserver wird später im Rahmen der Übernahme der AD-Domäne automatisch in die
			UCS-Domäne übernommen.
		  </simpara></listitem>
		</itemizedlist>
	  </para>

	  <para>
		Werden neben dem Anmeldedienst alle weiteren Dienste auf einen Memberserver migriert, ist
		kein langes Wartungsfenster für die Migration von AD auf UCS nötig. Wenn während der Umstellung auch Dienste migriert werden
		sollen, kann sich dieses Fenster deutlich ausweiten, die Entzerrung der Migration durch
		Migration der Dienste auf einen Memberserver ist daher empfehlenswert. 
	  </para>
	</section>

	<section id="bestpractice:migration:takeover">
	  <title>Migration der AD-Domäne</title>

	  <para>
		Nun erfolgt die Migration des AD-Servers. Die folgenden Schritte werden dabei umgesetzt:

		<itemizedlist>
		  <listitem><simpara>
			Beitritt des UCS-Domänencontrollers in die Active Directory Domäne
		  </simpara></listitem>

		  <listitem><simpara>
			Kopieren der Gruppenrichtliniendateien aus Active Directory nach UCS
		  </simpara></listitem>

		  <listitem><simpara>
			Abschalten des AD-Servers und Zuweisung der FSMO-Rollen auf den UCS-Domänencontroller
		  </simpara></listitem>
		</itemizedlist>
	  </para>
		
	  <para>
		Die Migration erfolgt über die App Center-Applikation <emphasis>Active Directory
		Takeover</emphasis> und ist im UCS-Handbuch (<biblioref linkend="ad-takeover"/>) ausführlich dokumentiert.
	  </para>


	</section>

	<section id="bestpractice:migration:extend">
	  <title>Erweiterungen</title>
	  <para>
		Die beschriebene Migration deckt die Basisdienste eine AD-Domäne ab. Darüberhinaus bietet
		UCS eine Vielfalt von weiteren Komponenten, die durch die UCS-Lizenz bereits abgedeckt sind
		und zu einem späteren Zeitpunkt in die migrierte Domäne integriert werden können, z.B.

		<itemizedlist>
		  <listitem><simpara>
			Integration von Mac OS X-Systemen <biblioref linkend="ucs-macjoin"/>
		  </simpara></listitem>

		  <listitem><simpara>
			Integration von Linux-Desktop auf Basis von Ubuntu <biblioref linkend="ubuntu-join"/>
			oder Univention Corporate Client <biblioref linkend="ucc-manual"/>
		  </simpara></listitem>

		  <listitem><simpara>
			Single Sign On mit Webdiensten über einen SAML Identity Providers <biblioref linkend="wiki-saml"/>
		  </simpara></listitem>

		  <listitem><simpara>
			IP-Management mit DHCP <biblioref linkend="ucs-dhcp"/>
		  </simpara></listitem>

		  <listitem><simpara>
			Web-Proxy für Caching und Policy Management/Virenscan <biblioref linkend="ucs-proxy"/>
		  </simpara></listitem>

		  <listitem><simpara>
			Service-Überwachung mit Nagios <biblioref linkend="ucs-nagios"/>
		  </simpara></listitem>

		  <listitem><simpara>
			Virtualisierung mit KVM/Xen <biblioref linkend="ucs-uvmm"/>
		  </simpara></listitem>
		</itemizedlist>
	  </para>
	</section>




  </section>

  <section id="bestpractice:migration:services">
	<title>Migration von Diensten auf einem Windows-Server auf &ucsUCS;</title>

	<section id="bestpractice:migration:fileshare">
	  <title>Migration von Datei-Freigaben</title>

	  <para>
		Jeder UCS-Samba-Server (Domänencontroller und Memberserver) stellt standardmässig
		Dateidienste bereit. Für die Migration von Dateifreigaben auf Windows-Servern steht kein
		standardisiertes Übernahme-Tool bereit: Die Freigaben müssen auf dem UCS-Server angelegt
		und die Daten kopiert werden.	
	  </para>

	  <para>
		Um eine korrekte Übernahme der Dateiberechtigungen zu erreichen muss der
		AD-Server auf die gleiche Benutzer-Basis zugreifen. Die kann auf zwei Wegen erreicht werden:

		<itemizedlist>
		  <listitem><simpara>
			Der AD-Server ist als &ucsMember; in die UCS-Domäne gejoint
		  </simpara></listitem>

		  <listitem><simpara>
			Der AD-Server ist ein Domänencontroller und wird während einer AD-Takeover-Migration
			temporär in die UCS-Domäne gejoint (bevor er final abgeschaltet wird)
		  </simpara></listitem>
		</itemizedlist>

		Die Dateibesitzrechte der Dateien werden auf dem AD-Server anhand der SID-Informationen
		gespeichert. Würden die Dateien des Fileservers auf das UCS-System migriert, bevor die
		Benutzerdaten verfügbar sind, wären die Dateien später nicht ohne weiteres einzelnen Benutzer
		zuordbar.
	  </para>

	  <para>
		Die auf einem AD-Server vorhandenen Datei-Freigaben sind unter <guimenu>Start ->
		Verwaltung -> Freigabe- und Speicherverwaltung</guimenu> zu finden. Im Reiter
		<guimenu>Freigaben</guimenu> werden alle veröffentlichten Freigaben aufgeführt. Im
		Kontextmenü einer Freigabe unter <guimenu>Eigenschaften</guimenu> werden die Eigenschaften
		einer Freigabe angezeigt, im folgenden Beispiel eine Freigabe mit dem Namen
		<emphasis>Documentation</emphasis>, die den Pfad <emphasis>C:\Documentation</emphasis>
		unter dem Freigabepfad <emphasis>\\ADSERVER\Documentation</emphasis> bereitstellt.

		<figure id="bestpractice-migrate-cifs">
		  <title>Zu migrierende Freigabe</title>
		  <graphic scalefit="1" width="80%" fileref="illustrations/cifs-migrate-de.png"/>
		</figure>

		Für diese Freigabe wird nun in der Freigabenverwaltung der &ucsUMC; eine Freigabe
		angelegt. Das Freigaben-Modul bietet vielfältige Möglichkeiten, die im UCS-Handbuch
		dokumentiert sind <biblioref linkend="ucs-share"/>, für die Übernahme der Daten reichen aber wenige Einstellungen
		aus. Die folgenden Werte müssen beim Anlegen der Freigabe(n) im UMC-Modul
		<guimenu>Freigaben</guimenu> min. angelegt werden:

		<itemizedlist>
		  <listitem><simpara>
			<emphasis>Name</emphasis>: Der Name, den die Freigabe unter Windows verwendete. Die
			Regeln für den Freigaben sind unter UCS strikter als in AD; wenn der unter Windows
			verwendete Name nicht anwendbar ist, kann im Reiter <guimenu>Samba-Name</guimenu> ein
			zusätzlicher Name konfiguriert, der beim Zugriff über CIFS angezeigt wird. Der Name
			muss nicht notwendigerweise identisch sein. Um Irritationen bei den Benutzern zu
			minimieren, ist es aber empfehlenswert.
		  </simpara></listitem>

		  <listitem><simpara>
			<emphasis>Server</emphasis>: Der UCS-Server, die Freigabe bereitstellen soll.
		  </simpara></listitem>

		  <listitem><simpara>
			<emphasis>Pfad</emphasis>: Der Pfad, unter dem die Daten der Freigabe auf dem
			UCS-Server gespeichert werden. Existiert der Pfad noch nicht, wird er automatisch
			angelegt. Die Berechtigungen dieses Verzeichnisses können unter
			<emphasis>Dateiberechtigungen für das Wurzelverzeichnis der Freigabe</emphasis>
			konfiguriert werden.
		  </simpara></listitem>
		</itemizedlist>
	  </para>

	  <para>
		Nun müssen die Daten der Freigabe vom Windows-Server auf das UCS-System kopiert
		werden. Dazu erfolgt eine Anmeldung auf dem Windows-Server, die Daten werden mit
		<command>robocopy</command> kopiert (es ist ab Windows 2008 vorinstalliert und kann unter
		Windows 2003 mit den Windows Server 2003 Resource Kit Tools nachinstalliert werden). Ein
		Beispiel:

		<programlisting language="sh">
		  robocopy /mir /sec /z \\ADSERVER\Documentation \\UCSSERVER\Documentation
		</programlisting>

		Anschließend sollte von einem Windows-Client der Domäne zu Zugriff auf die Freigabe auf
		dem UCS-Server getestet werden. Hier sollten alle Berechtigungen weiterhin korrekt
		angewendet werden. 
	  </para>

	  <para>
		Um zu verhindern, das sweitere Änderungen an der Freigabe auf dem Windows-Server erfolgen
		sollte nach der Migration der Daten die Freigabe auf dem Windows-Server deaktiviert
		werden. Dazu muss unter <guimenu>Start -> Verwaltung -> Freigabe- und
		Speicherverwaltung</guimenu> im Kontextmenü der migrierten Freigabe die Option
		<guimenu>Freigabe beenden</guimenu> gewählt werden.
	  </para>

	</section>

	<section id="bestpractice:migration:single:services:migrate:printshare">
	  <title>Migration von Drucker-Freigaben</title>

	  <para>
		Jeder UCS-Server kann Druckdienste anbieten. Dazu muss im &ucsUMC;-Modul
		<guimenu>Univention App Center</guimenu> in der Sektion <guimenu>UCS-Komponenten</guimenu>
		die Applikation <emphasis>Druckserver (CUPS)</emphasis> ausgewählt werden. Für die Migration
		von Druckerfreigaben auf Windows-Servern steht kein standardisiertes Übernahme-Tool bereit.
		Die Freigaben müssen manuell auf dem UCS-Server angelegt werden.
	  </para>

	  <para>
		Die auf einem AD-Server vorhandenen Drucker-Freigaben sind unter <guimenu>Start ->
		Verwaltung -> Druckverwaltun</guimenu> zu finden. Unter <guimenu>Druckerserver</guimenu>
		wird der Name des Windows-Servers aufgeführt. Dort sind unter <guimenu>Drucker</guimenu>
		alle registrierten Druckerfreigaben aufgeführt. Im Kontext-Menü eines Druckers können unter
		<guimenu>Eigenschaften</guimenu> die Einstellungen abgerufen werden. Im folgenden Beispiel
		ist ein Brother DCP-116C als Netzwerkdrucker unter der Adresse 192.168.0.100 angebunden.

	  <figure id="bestpractice-migrate-print">
		<title>Zu migrierender Drucker</title>
		<graphic scalefit="1" width="80%" fileref="illustrations/printer-migrate-de.png"/>
	  </figure>

		Für diese Druckerfreigabe wird nun in der Druckerverwaltung der &ucsUMC; ein Drucker
		angelegt. Das Drucker-Modul bietet vielfältige Möglichkeiten, die im UCS-Handbuch
		dokumentiert sind <biblioref linkend="ucs-print"/>, für die Übernahme der Druckerfreigaben reichen aber wenige Einstellungen
		aus. Die folgenden Werte müssen beim Anlegen der Drucker im UMC-Modul
		<guimenu>Drucker</guimenu> min. angelegt werden:

		<itemizedlist>
		  <listitem><simpara>
			<emphasis>Name</emphasis>: Der Name, den die Druckerfreigabe unter Windows verwendete. Der Name
			muss nicht notwendigerweise identisch sein, um Irritationen bei den Benutzern zu
			minimieren ist es aber empfehlenswert. Die
			Regeln für den Druckerfreigaben sind unter UCS strikter als in AD; wenn der unter Windows
			verwendete Name nicht anwendbar ist, kann unter <guimenu>Samba-Name</guimenu> ein
			zusätzlicher Name konfiguriert, der beim Zugriff von Windows-Clients angezeigt wird.
		  </simpara></listitem>

		  <listitem><simpara>
			<emphasis>Server</emphasis>: Der UCS-Server, der die Druckerfreigabe bereitstellen soll.
		  </simpara></listitem>

		  <listitem><simpara>
			<emphasis>Verbindung</emphasis>: Der Drucker kann entweder lokal an den Druckserver
			angeschlossen sein oder auf einen IP-fähigen Drucker zugreifen. Das Format
			<emphasis>Protokoll</emphasis> und das <emphasis>Ziel</emphasis> unterscheiden sich je
			nach Protokoll. Das genaue Format ist im UCS-Handbuch unter TODOREF dokumentiert.
		  </simpara></listitem>

		  <listitem><simpara>
			<emphasis>Drucker-Hersteller</emphasis> und <emphasis>Drucker-Modell</emphasis>: Das
			UCS-Drucksystem basiert auf CUPS. Die technischen Fähigkeiten eines Druckers werden in
			sogenannten PPD-Dateien spezifiziert. In diesen Dateien ist beispielsweise festgehalten,
			ob ein Drucker farbig drucken kann, ob ein beidseitiger Druck möglich ist, welche
			Papierschächte vorhanden sind, welche Auflösungen unterstützt und welche
			Druckerbefehlssprachen unterstützt werden (z.B. PCL oder Postscript). Hier muss der
			entsprechende Drucker ausgewählt werden.
		  </simpara></listitem>
		</itemizedlist>
	  </para>

	  <para>
		Wenn auf dem Windows-Druckserver serverseitig Drucker-Treiber hinterlegt wurden, müssen
		diese für den UCS-Druckserver erneut hochgeladen werden. Das Vorgehen dazu ist im
		UCS-Handbuch dokumentiert <biblioref linkend="ucs-print-umc"/>.
	  </para>

	  <para>
		Anschließend sollte von einem Windows-Client der Domäne eine Testseite über den migrierten
		Drucker ausgedruckt werden.
	  </para>

	  <para>
		Die migrierten Druckerfreigaben können anschließent auf dem Windows-Server entfernt
		werden. Dazu muss unter <guimenu>Start -> Verwaltung -> Druckverwaltung</guimenu> im
		Kontextmenü der migrierten Freigabe die Option <guimenu>Löschen</guimenu> gewählt werden.
	  </para>
	</section>

	<section id="bestpractice:migration:appcenter">
	  <title>Migration weiterer Dienste (z.B. Microsoft Exchange)</title>

	  <para>
		Wenn auf dem AD-Server Microsoft Exchange betrieben wird, besteht die Möglichkeit auf eine
		Groupware aus dem Univention App Center zu migrieren. Diese sind im Univention App Center
		in der Sektion <emphasis>Collaboration</emphasis> zu finden. Diese Groupware-Lösungen
		werden von externen Anbietern bereitgestellt und mit Support versorgt.
	  </para>
	</section>
  </section>

  <section id="bestpractice:migration:distrib">
	<title>Migration einer AD-Domäne mit mehreren Domänencontrollern</title>
  </section>

</chapter>
