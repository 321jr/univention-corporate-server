<chapter id="bestpractice:migration">
  <title>Migration of an Active Directory domain to &ucsUCS;</title>
  <section>
	<title>Introduction</title>
	<para>
	  This documentation describes how to migrate a Microsoft Active Directory domain based on
	  Windows Server 2003/2008/2012 to &ucsUCS;. The domain controller service is provided in an
	  AD-compatible version by UCS. A Windows client which has joined the AD domain is 
	  available in the UCS domain after the migration, i.e., it is not necessary to join the domain
	  again. The entire contents of the AD LDAP directory are migrated (and thus all the user
	  accounts and groups as well).
	</para>

	<para>
	  In this documentation, a distinction is made between two scenarios:

	  <itemizedlist>
		<listitem><simpara>
		  Migration of an environment with just one domain controller (e.g., Microsoft Small
		  Business Server) (<xref linkend="bestpractice:migration:single"/>)
		</simpara></listitem>

		<listitem><simpara>
		  Migration of a distributed Active Directory environment with several domain controllers
		  (e.g., for distributed sites or larger environments)(<xref
		  linkend="bestpractice:migration:distrib"/>)
		</simpara></listitem>
	  </itemizedlist>
	</para>

	<para>
	  In addition to the migration of the core domain services (user logins, client integration), it
	  is also possible to migrate file/print services to UCS (<xref
	  linkend="bestpractice:migration:services"/>).
	</para>
  </section>

  <section id="bestpractice:migration:single">
	<title>Migration of an AD domain with one domain controller (single-server environment)</title>

	<section id="bestpractice:migration:single:intro">
	  <title>Introduction</title>

	  <para>
		Every UCS environment is composed of at least one &ucsMaster; and any number of additional
		servers. This allows the option of operating a local server at different sites, for example.
	  </para>

	  <para>
		This version of the migration documentation describes the migration of the AD domain
		controller to a single UCS domain controller. If the environment is subsequently expanded or
		needs to be distributed for other reasons, the services can be subsequently split up at any
		point.
	  </para>

	</section>

	<section id="bestpractice:migration:single:ucsinstall">
	  <title>Installing the UCS system</title>
	  <para>
		A separate server with UCS is installed for the migration. The system installation can be
		performed with the help of the UCS quickstart guide <biblioref
		linkend="ucs-quickstart"/>. The following settings need to be selected during the
		installation:

		<itemizedlist>
		  <listitem><simpara>
			<emphasis>Language</emphasis>, <emphasis>Time zone</emphasis>, <emphasis>Keyboard mapping</emphasis>: Arbitrary
		  </simpara></listitem>

		  <listitem><simpara>
			<emphasis>System role</emphasis>: Domain Controller Master
		  </simpara></listitem>

		  <listitem><simpara>
			<emphasis>Fully qualified domain name</emphasis>: This value is composed of the computer name
			and the domain name. In <systemitem class="fqdomainname">server1.company.example</systemitem>
			<systemitem class="systemname">server1</systemitem> is the computer name and
			<systemitem class="domainname">company.example</systemitem> the domain name. Any name can be used for the
			computer name, as long as it is not in use in the AD domain to be migrated. The domain
			name must be the AD domain name (it is displayed in the Windows Control Panel under
			<guimenu>System and Security &ar; System</guimenu> in the <guimenu>Domain</guimenu> field.
		  </simpara></listitem>

		  <listitem><simpara>
			The <emphasis>LDAP base</emphasis> and <emphasis>Windows domain name</emphasis> are
			suggested based on the fully qualified domain name. The value suggested by the installation
			dialogue should be accepted.
		  </simpara></listitem>

		  <listitem><simpara>
			<emphasis>Root password</emphasis>: The password configured here is also the initial
			password for the <emphasis>Administrator</emphasis> account on the UCS server. The same
			<emphasis>Administrator</emphasis> password should be used here as in the AD domain.
		  </simpara></listitem>

		  <listitem><simpara>
			<emphasis>Partitioning</emphasis>: Any - it is recommended to use the automatic partitioning.
		  </simpara></listitem>

		  <listitem><simpara>
			<emphasis>Network configuration</emphasis>: An IPv4 address from the subnetwork of the
			AD domain controller to be migrated should be used.
		  </simpara></listitem>

		  <listitem><simpara>
			The software selection can be left completely blank. All the necessary applications are
			installed from the Univention App Center at a later point in time.
		  </simpara></listitem>
		</itemizedlist>
	  </para>

	  <para>
		Once the installation is complete, the UCS system must be restarted by pressing a key. The
		UCS server is now installed but does not contain the user data from the AD domain. These are
		migrated in a subsequent step.
	  </para>

	</section>


	<section id="bestpractice:migration:single:services">
	  <title>Migration of the AD system's services</title>

	  <para>
		The data from the directory service (e.g., users, groups and computer accounts) and the
		group policy information are migrated to UCS automatically in the course of the AD domain
		takeover. Once the migration is complete, the AD domain controller is no longer
		available. In other words, if other services besides the login service are also operated via
		the AD domain controller, they must also be migrated. There are two different means of doing
		this in principle:

		<itemizedlist>
		  <listitem><simpara>
			Migration of services to the UCS server. This is described in <xref
			linkend="bestpractice:migration:fileshare"/> for file shares and in <xref
			linkend="bestpractice:migration:single:services:migrate:printshare"/> for print
			shares. In addition, the Univention App Center offers a range of applications for
			installation, which can also replace existing software such as Microsoft Exchange (<xref
			linkend="bestpractice:migration:appcenter"/>)
		  </simpara></listitem>

		  <listitem><simpara>
			Installation of a member server in the AD domain and migration of the services to this
			server. The member server is later taken over automatically into the UCS domain during
			the takeover of the AD domain.
		  </simpara></listitem>
		</itemizedlist>
	  </para>

	  <para>
		If all additional services are migrated to a member server in addition to the login service,
		only a short maintenance window is required for the migration of AD to UCS. If other
		services are intended to be migrated during the changeover, this window can be extended
		considerably, so migration of the services to a member service is recommended for
		equalisation of the migration. 
	  </para>
	</section>

	<section id="bestpractice:migration:takeover">
	  <title>Migration of the AD domain</title>

	  <para>
		The AD server is now migrated. This involves the realisation of the following steps:

		<itemizedlist>
		  <listitem><simpara>
			Joining of UCS domain controller in the Active Directory domain
		  </simpara></listitem>

		  <listitem><simpara>
			Copying of group policy files from Active Directory to UCS
		  </simpara></listitem>

		  <listitem><simpara>
			Switching off of AD server and assignment of FSMO roles to the UCS domain controller
		  </simpara></listitem>
		</itemizedlist>
	  </para>
		
	  <para>
		The migration is performed via the App Center application <emphasis>Active Directory
		Takeover</emphasis> and is documented in detail in the UCS manual (<biblioref
		linkend="ad-takeover"/>).
	  </para>
	</section>


  <section id="bestpractice:migration:distrib">
	<title>Migration of an AD domain with several domain controllers</title>

	<para>
	  Migration of a distributed AD environment differs from migration of a single AD server only in
	  individual aspects. This section therefore refers partly to individual sections of this
	  documentation and only indicates the differences.
	</para>

	<section id="bestpractice:migration:distrib:planning">
	  <title>Inventory and planning</title>

	  <para>
		The first step is to take an inventory of the Window servers in the domain to be migrated:

		<itemizedlist>
		  <listitem><simpara>
			How many domain controllers are there? What other services are running in addition to
			the login services on these systems (e.g., file or print services)
		  </simpara></listitem>

		  <listitem><simpara>
			The next step is to determine which of the AD domain controllers will be the primary and
			which will take on the FSMO roles. This is described in <biblioref
			linkend="microsoft-fsmo"/>.
		  </simpara></listitem>

		  <listitem><simpara>
			In the scope of a migration, the AD domain controllers can be migrated to the same number
			of Samba domain controllers. However, it is also possible consolidate systems to new
			hardware and to migrate them to fewer Samba servers than in Active Directory.
		  </simpara></listitem>
		</itemizedlist>

	  </para>
	</section>

	<section id="bestpractice:migration:distrib:ucsinstall">
	  <title>Installation of the UCS servers</title>

	  <para>
		The first step is the installation of the &ucsMaster;, the first system in a UCS domain. The
		installation is performed in the same way as for a single-server environment, as described
		in <xref linkend="bestpractice:migration:single:ucsinstall"/>.
	  </para>

	  <para>
		The additional Samba domain controllers are added at a later point in time. The UCS servers
		on which Samba is to be installed can be installed and joined in advance, but the Samba
		service can also be installed when the AD takeover has already been performed.
	  </para>
	</section>

	<section id="bestpractice:migration:distrib:services">
	  <title>Migration of the AD system's services</title>

	  <para>
		The login services are migrated in the scope of the AD takeover; other services on the AD
		domain controllers must be migrated to a member server or the UCS system in advance. The
		procedure is described in <xref linkend="bestpractice:migration:single:services"/>.
	  </para>
	</section>

	<section id="bestpractice:distrib:takeover">
	  <title>Migration of the AD domain</title>
	  <para>
		The AD servers are now migrated. This is performed in the following stages:

		<itemizedlist>
		  <listitem><simpara>
			Prior to the migration, all domain controllers which do not have FSMO roles must be
			switched off, see <xref linkend="bestpractice:migration:distrib:planning"/>.
		  </simpara></listitem>

		  <listitem><simpara>
			The primary AD domain controller is now migrated to the &ucsMaster;. To this end, the
			UCS system temporarily joins the AD domain, replicates all the LDAP data and copies the
			group policy files. Once the UCS system has taken over the FSMO roles, the AD server is
			switched off. The migration is performed via the App Center application <emphasis>Active
			Directory Takeover</emphasis> and is documented in detail in the UCS manual (<biblioref
			linkend="ad-takeover"/>).
		  </simpara></listitem>

		  <listitem><simpara>
			Samba is then installed on the UCS systems which are also operated as domain
			controllers. The directory service data and the GPO directory are replicated
			automatically.
		  </simpara></listitem>
		</itemizedlist>
	  </para>
	</section>
  </section>


  <section id="bestpractice:migration:services">
	<title>Migration of services from a Windows server to &ucsUCS;</title>

	<section id="bestpractice:migration:fileshare">
	  <title>Migration of file shares</title>

	  <para>
		Every UCS Samba server (domain controllers and member servers) provides file services by
		default. There is no standardised tool available for the migration of file shares on Windows
		servers: the shares must be re-created on the UCS server and the data copied.	
	  </para>

	  <para>
		To achieve a correct takeover of the file permissions, the AD server must access the same
		user base. This can be achieved in two ways:

		<itemizedlist>
		  <listitem><simpara>
			The AD server is joined in the UCS domain as a member server.
		  </simpara></listitem>

		  <listitem><simpara>
			The AD server is a domain controller and temporarily joins the UCS domain during an AD
			takeover migration (before it is permanently switched off).
		  </simpara></listitem>
		</itemizedlist>

		The file ownership rights of the files are saved on the AD server using the SID
		information. If the files of the file server were migrated to the UCS system before the user
		data were available, it would not be subsequently possible to assign the files to individual
		users without additional efforts.
	  </para>

	  <para>
		The file shares available on an AD server can be found under <guimenu>Start ->
		Administrative Tools -> Share and Storage Management </guimenu> The <guimenu>Shares</guimenu> tab
		lists all the published shares. The <guimenu>Properties</guimenu> section in the context
		menu of a share lists the properties of the share. In the following example, a share with
		the name <emphasis>Documentation</emphasis>, which provides the path
		<filename class="directory">C:\Documentation</filename> under the share path
		<uri>\\ADSERVER\Documentation</uri>.

		<figure id="bestpractice-migrate-cifs">
		  <title>The file share to migrate</title>
		  <graphic scalefit="1" width="80%" fileref="illustrations/cifs-migrate-en.png"/>
		</figure>

		A share is now created in the share management of the &ucsUMC;. The share module offers a
		range of possibilities, which are documented in the UCS manual <biblioref
		linkend="ucs-shares"/>. However, just a few settings are enough for the takeover of the
		data. The following values need to be saved as a minimum when creating the share(s) in the
		UMC module <guimenu>Shares</guimenu>:

		<itemizedlist>
		  <listitem><simpara>
			<emphasis>Name</emphasis>: The name that the share uses in Windows. The rules for the
			shares are stricter in UCS than in AD. If the name used in Windows is not permitted, an
			additional name can be configured in the <guimenu>Samba name</guimenu> tab, which is
			displayed during access via CIFS. The name does not necessarily need to be
			identical. Nevertheless, to minimise irritations among the users, it is recommended.
		  </simpara></listitem>

		  <listitem><simpara>
			<emphasis>Host</emphasis>: The UCS server providing the file share
		  </simpara></listitem>

		  <listitem><simpara>
			<emphasis>Directory</emphasis>: The path under which the share data are saved on the UCS
			server. It the path does not already exist, it will be created automatically. The rights
			of the directory can be found under <emphasis>Permissions for the shares' root
			directory</emphasis>.
		  </simpara></listitem>
		</itemizedlist>
	  </para>

	  <para>
		The share data is now copied from the Windows server to the UCS system. A login is then
		performed on the Windows server and the data is copied with <command>robocopy</command>
		(preinstalled as of Windows 2008 and can be subsequently installed with the Windows Server
		2003 Resource Kit Tools in Windows 2003). Example:

		<programlisting language="sh">
		  robocopy /mir /sec /z \\ADSERVER\Documentation \\UCSSERVER\Documentation
		</programlisting>

		Then the access to the share on the UCS server should be tested from a Windows client. All
		the permissions should still be correctly applied. 
	  </para>

	  <para>
		To prevent further changes to the share on the Windows server, the share on the Windows
		server should be disabled following migration of the data. This is done by selecting the
		<guimenu>Stop sharing</guimenu> option in the context menu of the migrated share under
		<guimenu>Start -> Administrative Tools -> Share and Storage Management</guimenu>.
	  </para>

	</section>

	<section id="bestpractice:migration:single:services:migrate:printshare">
	  <title>Migration of print shares</title>

	  <para>
		Any UCS server can offer print services. This is achieved by selecting the <emphasis>Print
		server (CUPS)</emphasis> application in the <guimenu>UCS components</guimenu> section in the
		&ucsUMC; module <guimenu>Univention App Center</guimenu>. There is no standardised tool
		available for the migration of print shares on Windows servers: The shares need to be
		created manually on the UCS server.
	  </para>

	  <para>
		The print shares available on an AD server can be found under <guimenu>Start ->
		Administrative Tools -> Print Management </guimenu> The name of the Windows server is displayed
		under <guimenu>Print server</guimenu>. All the registered print shares are listed there
		under <guimenu>Printers</guimenu>. The settings can be viewed under
		<guimenu>Properties</guimenu> in the context menu of a printer. In the following example, a
		<systemitem>Brother DCP-116C</systemitem> is connected as a network printer under the address <systemitem class="ipaddress">192.168.0.100</systemitem>.

	  <figure id="bestpractice-migrate-print">
		<title>Printer to migrate</title>
		<graphic scalefit="1" width="80%" fileref="illustrations/printer-migrate-en.png"/>
	  </figure>

	  A printer share is now created in &ucsUMC;' printer management. The print module offers a
	  range of possibilities, which are documented in the UCS manual <biblioref
	  linkend="ucs-print"/>. However, just a few settings are enough for the takeover of the print
	  shares. The following values need to be saved as a minimum when creating the printers in the
	  UMC module <guimenu>Printers</guimenu>.

		<itemizedlist>
		  <listitem><simpara>
			<emphasis>Name</emphasis>: The name that the print share uses in Windows. The name does
			not necessarily need to be identical. Nevertheless, to minimise irritations among the
			users, it is recommended. The rules for the shares are stricter in UCS than in AD. If
			the name used in Windows  is not permitted, an additional name can be configured in the
			<guimenu>Samba name</guimenu> tab, which is displayed during access via Windows clients.
		  </simpara></listitem>

		  <listitem><simpara>
			<emphasis>Spool host</emphasis>: The UCS server which should provide the print share.
		  </simpara></listitem>

		  <listitem><simpara>
			<emphasis>Connection</emphasis>: The printers can either be connected to the print
			server locally or access an IP-compatible printer. The format
			<emphasis>Protocol</emphasis> and the <emphasis>Destination</emphasis> differ depending
			on the protocol. The precise format is documented in the UCS manual <biblioref
			linkend="ucs-print-umc"/>.
		  </simpara></listitem>

		  <listitem><simpara>
			<emphasis>Printer producer</emphasis> and <emphasis>Printer model</emphasis>: The
			UCS printing system is based on CUPS. The technical capacities of a printer are
			specified in so-called PPD files. These files include for example whether a printer can
			print in colour, whether duplex printing is possible, whether there are paper trays,
			which resolutions are supported and which printer control languages are supported (e.g.,
			PCL or Postscript). To this end, the corresponding printer must be selected.
		  </simpara></listitem>
		</itemizedlist>
	  </para>

	  <para>
		If printer drivers have been stored on the Windows print server on the server side, they
		need to be re-uploaded for the UCS print server. This procedure is documented in the UCS
		manual <biblioref linkend="ucs-winprinter"/>.
	  </para>

	  <para>
		Then a Windows client in the domain should be used to print a test page via the migrated
		printer.
	  </para>

	  <para>
		The migrated printer shares can then be removed from the Windows server. This is done by
		selecting the <guimenu>Delete</guimenu> option in the context menu of the migrated share
		under <guimenu>Start -> Administrative Tools -> Print Management</guimenu>.
	  </para>
	</section>

	<section id="bestpractice:migration:appcenter">
	  <title>Migration of further services (e.g., Microsoft Exchange)</title>

	  <para>
		If Microsoft Exchange is operated on the AD server, there is the possibility of migrating to
		a groupware from the Univention App Center. These can be found in the
		<emphasis>Collaboration</emphasis> section of the Univention App Center. These groupware
		solutions are provided by external suppliers and offer support.
	  </para>
	</section>
  </section>

	<section id="bestpractice:migration:test">
	  <title>Test run of migration</title>
	  <para>
		The migration described here can be completely tested in advance. This is a good idea in
		order to identify potential problems in advance and establish a time window for the
		migration:

		<itemizedlist>
		  <listitem><simpara>
			if the AD server is virtualized, a clone of the AD server can be migrated.
		  </simpara></listitem>

		  <listitem><simpara>
			If the AD migration in the AD takeover is cancelled at the point in which the AD server
			would normally be shut down, it is still possible to test all the functions such as
			domain logins, GPOs, etc. The replication of the directory data set up in this takeover
			is unidirectional from AD to UCS, i.e., if changes are made in the &ucsUMC; during the
			test phase, these are not replicated to AD. If an AD takeover for a test migration is
			cancelled, the computer account of the UCS server should be deleted from the computer
			accounts in Active Directory prior to the actual productive migration.
		  </simpara></listitem>
		</itemizedlist>
	  </para>
	</section>

	<section id="bestpractice:migration:extend">
	  <title>Extending the UCS installation</title>
	  <para>
		The migration described covers the basic services of an AD domain. In addition, UCS offers a
		wide range of different components which are already covered by the UCS license and can be
		integrated in the migrated domain at a later point in time, e.g.,

		<itemizedlist>
		  <listitem><simpara>
			Integration of Mac OS X systems <biblioref linkend="ucs-macjoin"/>
		  </simpara></listitem>

		  <listitem><simpara>
			Integration of Linux desktop based on Ubuntu <biblioref linkend="ubuntu-join"/> or
			Univention Corporate Client <biblioref linkend="ucc-manual"/>
		  </simpara></listitem>

		  <listitem><simpara>
			Single sign on with web services via a SAML identity provider <biblioref linkend="wiki-saml"/>
		  </simpara></listitem>

		  <listitem><simpara>
			IP management with DHCP <biblioref linkend="ucs-dhcp"/>
		  </simpara></listitem>

		  <listitem><simpara>
			Web proxy for caching and policy management / virus scanning <biblioref linkend="ucs-proxy"/>
		  </simpara></listitem>

		  <listitem><simpara>
			Service monitoring with Nagios <biblioref linkend="ucs-nagios"/>
		  </simpara></listitem>

		  <listitem><simpara>
			Virtualization with KVM/Xen <biblioref linkend="ucs-uvmm"/>
		  </simpara></listitem>
		</itemizedlist>
	  </para>
	</section>
  </section>


</chapter>
