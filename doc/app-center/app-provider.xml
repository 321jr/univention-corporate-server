<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE book PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
	"http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
	<!ENTITY % extensions SYSTEM "../stylesheets/macros.ent" >
	<!ENTITY % entities SYSTEM "../stylesheets/macros-en.ent" >
	%extensions;
	%entities;
]>
<book lang="en" id='app-provider-4.3'>
<bookinfo>
  <title>Univention App Center for App Provider</title>
</bookinfo>

<chapter id="introduction">
    <title>Introduction</title>

    <para>
        This document is for app providers who want to place their product
        clearly visible for a broad, professional and growing user group. It
        covers the steps on how make the product available as app for
        Univention App Center.
    </para>

    <section id="introduction:start">
	    <title>What is Univention App Center?</title>
        <para>
            Univention App Center is an ecosystem similar to the app stores
            known from mobile platforms from Apple or Google. It provides an
            infrastructure to build, deploy and run enterprise applications on
            Univention Corporate Server (UCS). The App Center uses well-known
            technology like and docker containers.
        </para>
    </section>

    <section id="infrastructure">
        <title>App Center infrastructure</title>

        <para>
            The ecosystem consists of following components:
            <itemizedlist>
                <listitem>
                    <simpara>
                        <emphasis>The App</emphasis> is the software plus the
                        collection of metadata like description, logo,
                        screenshots and more for the presentation.
                    </simpara>
                </listitem>
                <listitem>
                    <simpara>
                        <emphasis>The App Center Repository</emphasis> is a
                        central server infrastructure managed by Univention
                        that stores the files and data for the app. It is the
                        installation source for the app for UCS.
                    </simpara>
                </listitem>
                <listitem>
                    <simpara>
                        <emphasis>The App Center Module on UCS</emphasis> is
                        part of the web-based management system on UCS. It is the
                        place where administrators install, update and
                        uninstall apps in their UCS environment.
                    </simpara>
                </listitem>
                <listitem>
                    <simpara>
                        <emphasis>The App Catalog</emphasis> is the
                        presentation of the app portfolio on the <ulink
                            url="https://www.univention.com/products/univention-app-center/app-catalog/">
                            Univention website</ulink>.
                    </simpara>
                </listitem>
                <listitem>
                    <simpara>
                        <emphasis>The App Provider Portal</emphasis> is the
                        self-service portal for app providers where they can
                        create and maintain their app.  
                    </simpara>
                </listitem>
                <listitem>
                    <simpara>
                        <emphasis>The Test App Center</emphasis> is the
                        &quot;staging area&quot; for app providers to develop
                        and test their apps.
                    </simpara>
                </listitem>
            </itemizedlist>
        </para>

        <para>
            For building an app the app developer deals with the app, the
            provider portal and the Test App Center.
        </para>
    </section>
</chapter>

<chapter id="get-started">
    <title>Get Started</title>

    <para>
        This chapter describes the requirements and the steps to create an app
        for Univention App Center. After reading this chapter you are can create
        your own app and start with a development and test cycle using the Test
        App Center.
    </para>

    <section id="app-provider-needs">
        <title>What the app provider needs?</title>

        <para>
        </para>

        <section id="app-provider-needs:docker-image">
            <title>Software in a docker image</title>
            <para>
                Your software needs to be provided in a <ulink
                    url="https://docs.docker.com/">docker image</ulink>. This
                is the easiest way to deploy software in Univention App Center.
            </para>
            <para>
                It is also recommended to publish the docker container to
                <ulink url="https://hub.docker.com/">docker hub</ulink>. This
                makes referencing the image later much easier.
            </para>
            <para>
                The image must have an image tag for version information. It later
                allows updates for the apps.
            </para>
        </section>

        <section id="app-provider-needs:portal-account">
            <title>Account for App Provider Portal</title>

            <para>
                The app provider portal is the app developer's self service
                place for all the settings around the app.
            </para>

           <orderedlist>
               <listitem>
                   <simpara>
                       To start building your app, you should first get
                       yourself an account for the app provider portal.
                       Please <ulink url="https://www.univention.com/products/univention-app-center/for-solution-providers/">
                           request your personal account</ulink>.
                   </simpara>
               </listitem>
               <listitem>
                   <simpara>
                       You will receive an email with your username and
                       instructions on how to set your password.
                   </simpara>
               </listitem>
               <listitem>
                   <simpara>
                       Afterwards you can login to the <ulink
                           url="https://provider-portal.software-univention.de/univention-management-console/">App
                           Provider Portal</ulink>.
                   </simpara>
               </listitem>
           </orderedlist>
        </section>
    </section>

    <section id="create-app-with-docker">
        <title>Create app with a docker image</title>

        <para>
            This section describes the steps how to create the app in the App
            Provider Portal and use a docker image.
        </para>

        <para>
            <figure id="create-app-with-docker:create-app">
                <title>Add a new App</title>
                <graphic scalefit="1" width="275px" fileref="illustrations/app_portal_new_app.png"/>
            </figure>
        </para>

        <orderedlist>
            <listitem>
                <simpara>
                    In the App Provider Portal select the
                    <guimenu>Apps</guimenu> module in the
                    <guimenu>Favorites</guimenu> or <guimenu>Software</guimenu>
                    section.
                </simpara>
            </listitem>
            <listitem>
                <simpara>
                    Click on <guimenu>Add a new App</guimenu> and provide the following settings.
                </simpara>
                    <itemizedlist>
                    <listitem>
                        <simpara>
                            <emphasis>App ID</emphasis> is like a primary key.
                            You should choose it carefully, because it cannot
                            be changed once the app is released to the public.
                            It should use small capitals, dashes and numbers.
                            Please do not include version strings in here.
                        </simpara>
                    </listitem>
                    <listitem>
                        <simpara>
                            <emphasis>App Name</emphasis> is the name of your
                            app. It is used to display the app on the overview
                            pages. This attribute can be changed any time later.
                        </simpara>
                    </listitem>
                    <listitem>
                        <simpara>
                            <emphasis>App Version</emphasis> is the version of
                            your app. The App Center distinguishes versions and
                            uses them to handle app updates.
                        </simpara>
                    </listitem>
                    <listitem>
                        <simpara>
                            <emphasis>UCS Version</emphasis> is the UCS version
                            your app should start to be available on.
                        </simpara>
                        <simpara>
                            As the App is a container and has little
                            interaction with the host system, it is unnecessary
                            to publish a new version for UCS 4.3, if it has
                            already been published for UCS 4.2. UCS 4.3 systems
                            may very well use the App - if you specify
                            <literal>SupportedUCSVersion=4.2-0, 4.3-0</literal>
                            in your 4.2 App. It does not really matter in
                            which UCS version you are publishing your App. But
                            if you are publishing it in various UCS versions,
                            you need to also test various UCS versions.
                        </simpara>
                    </listitem>
                    <listitem>
                        <simpara>
                            <emphasis>File under</emphasis> refers to the
                            organization that the app belongs to. Please select
                            your organization here or otherwise the app will not
                            show up in the listing for you.
                        </simpara>
                    </listitem>
                    </itemizedlist>
            </listitem>
        </orderedlist>

        <section id="create-app-with-docker:image">
            <title>Docker image</title>

            <orderedlist>
                <listitem>
                    <simpara>
                        In your app go to the tab <guimenu>Docker</guimenu>.
                    </simpara>
                </listitem>
                <listitem>
                    <simpara>
                        Activate the checkbox <guimenu>Use docker container technology</guimenu>.
                    </simpara>
                </listitem>
                <listitem>
                    <simpara>
                        Enter the name of your image to <guimenu>Docker
                            image</guimenu>. Grab the name of your image from
                        docker hub for example
                        <literal>univention/ucs-master-amd64:4.2-2</literal>.
                    </simpara>
                </listitem>
            </orderedlist>

            <important>
                <para>
                    Please add the version tag explicitly. The App Center
                    distinguishes different app versions and handles updates
                    accordingly.
                </para>
            </important>

            <note>
                <para>
                    The App Center does currently not support multi container
                    setups. The container needs to include all services needed
                    for the software, except the database.  The App Center
                    takes care of providing a database management system
                    directly on the docker host that can be used by the docker
                    container. Supported are MySQL and PostgreSQL. See <xref
                        linkend="create-app-with-docker:database" />.
                </para>
            </note>
        </section>

        <section id="create-app-with-docker:description">
            <title>Logo and description</title>
            <para>
            </para>
        </section>

        <section id="create-app-with-docker:defaults">
            <title>Change defaults</title>
            <para>
                Set the docker entry-point in the section <guimenu>Advanced docker settings</guimenu> at <guimenu>Entrypoint for the Docker App</guimenu>.
            </para>
        </section>

        <section id="create-app-with-docker:volumes">
            <title>Persistent data with volumes</title>
            <para>
            </para>
        </section>

        <section id="create-app-with-docker:web-interface">
            <title>Web interface</title>
            <para>
            </para>
        </section>

        <section id="create-app-with-docker:ports">
            <title>Ports</title>
            <para>
            </para>
        </section>

        <section id="create-app-with-docker:database">
            <title>Database</title>
            <para>
            </para>
        </section>

    </section>
</chapter>

<chapter id="connection-idm">
    <title>Connection with Identity Management</title>

    <para>
		One of the UCS key features is the integrated identity management (IDM).
		With this central identity management, users benefit, among other things, from a single login independent of which services or systems they use.
		It is highly recommended to integrate the app into the identity management system.
    </para>

    <para>
		If the app should benefit from the identity management system, the flag <emphasis>Add activation checkbox for App in UCS user management</emphasis>
		should be activated.
		This gives administrators the possibility to activate the users for the app. It is also possible to make significantly more complex settings.
<!-- TODO
	Add a link
-->
    </para>

    <section id="provisioning">
        <title>Provisioning</title>

        <para>
			There are different ways in which applications can access provisioning information. The following describes a pull and a push-based procedure.
        </para>

        <section id="provisioning:pull">
            <title>Automatically via LDAP connection (Pull)</title>
            <para>
				UCS stores the user and group information in an OpenLDAP based directory. Thus, the default information can be accessed via the LDAP protocol.
				Objects are identified by an LDAP filter. The following filter can be used to search for users <wordasword>(univentionObjectType=users/user)</wordasword>
				and for groups the filter <wordasword>(univentionObjectType=groups/group)</wordasword> can be used.
            </para>
            <para>
				If the user activation is used (<guimenu>Add activation checkbox for App in UCS user management</guimenu>), the following LDAP filter can be used:
				<wordasword>(&amp;(univentionObjectType=users/user)(myappActivated=TRUE))</wordasword>.
				The string <wordasword>myapp</wordasword> has to be replaced with the <wordasword>appid</wordasword>.
            </para>
            <para>
				The parameters for the LDAP server can be read from the environment variables:
				<itemizedlist>
					<listitem>
						<simpara>
     						<option>LDAP_SERVER_NAME</option>: The fully-qualified host name of the OpenLDAP server the App may connect to.
						</simpara>
					</listitem>
					<listitem>
						<simpara>
    						<option>LDAP_SERVER_PORT</option>: The port of the OpenLDAP server the App may connect to.
						</simpara>
					</listitem>
					<listitem>
						<simpara>
    						<option>LDAP_SERVER_ADDITION</option>: A list of alternative OpenLDAP servers. These values should be used for failover.
						</simpara>
					</listitem>
					<listitem>
						<simpara>
    						<option>LDAP_BASE</option>: The base for the whole LDAP database, e.g., <uri>dc=mydomain,dc=intranet</uri> or <uri>o=mydomain</uri>.
						</simpara>
					</listitem>
				</itemizedlist>
				<important>
					<para>
						As a rule, the LDAP basis should not be further restricted. Many environments store users below <uri>cn=users</uri>, but this is not the case in all environments.
					</para>
				</important>
            </para>

            <para>
				By default, the OpenLDAP server in UCS does not allow anonymous authentications. For every app a user account is created. The account has
				read access to the LDAP directory. The username is passed as the environment variable <option>LDAP_HOSTDN</option>. The password is written in the file <filename>/etc/machine.secret</filename>.
				The credentials are not changed when an app is upgraded. But they change if an App is reinstalled. 
            </para>
        </section>

        <section id="provisioning:push">
            <title>Automatically via IDM notifications (Push)</title>
            <para>
				An app can be notified by the IDM system when users or groups are created, modified or deleted. For each change, a file is created in
				a specific directory. The app can either poll the directory or register a command that is executed when a file is created. The app should
				then delete the files.
            </para>
            <para>
				The configuration for these IDM notifications can be done on the <option>LDAP Listener</option> tab in the App Provider Portal.
<!-- TODO
	How to define the script?
-->
            </para>
            <para>
				The files are created in the directory <filename>/var/lib/univention-appcenter/apps/$appid/data/listener/</filename>.
            </para>
            <para>
				All files are JSON with one dictionary and the following content:
				<itemizedlist>
					<listitem>
						<simpara>
    						<option>entry_uuid</option>: A unique identifier for the object. It does not change even if the object is moved. The script certainly wants to
							identify objects by this attribute.
						</simpara>
					</listitem>
					<listitem>
						<simpara>
    						<option>dn</option>: The distinguished name of the LDAP object.
						</simpara>
					</listitem>
					<listitem>
						<simpara>
    						<option>type</option>: The type of the object, i.e., "users/user", or "groups/group".
						</simpara>
					</listitem>
					<listitem>
						<simpara>
    						<option>attributes</option>: A dictionary of the attributes of this object. The content is defined by the UDM (Univention Directory Manager)
							representation of the object. If it is null instead, the object has been deleted.
						</simpara>
					</listitem>
				</itemizedlist>
            </para>
        </section>
    </section>

    <section id="authentication">
        <title>Authentication</title>

        <para>
			There are different ways in which applications can authenticate the against the UCS identity management system.
        </para>

        <section id="authentication:ldap">
            <title>LDAP</title>
            <para>
				UCS stores the user and group information in an OpenLDAP based directory. Thus, the default information can be accessed via the LDAP protocol.
				Objects are identified by an LDAP filter. The following filter can be used to search for users <wordasword>(univentionObjectType=users/user)</wordasword>
				and for groups the filter <wordasword>(univentionObjectType=groups/group)</wordasword> can be used.
            </para>
            <para>
				If the user activation is used (<guimenu>Add activation checkbox for App in UCS user management</guimenu>), the following LDAP filter can be used:
				<wordasword>(&amp;(univentionObjectType=users/user)(myappActivated=TRUE))</wordasword>.
				The string <wordasword>myapp</wordasword> has to be replaced with the <wordasword>appid</wordasword>.
            </para>
            <para>
				The parameters for the LDAP server can be read from the environment variables:
				<itemizedlist>
					<listitem>
						<simpara>
     						<option>LDAP_SERVER_NAME</option>: The fully-qualified host name of the OpenLDAP server the App may connect to.
						</simpara>
					</listitem>
					<listitem>
						<simpara>
    						<option>LDAP_SERVER_PORT</option>: The port of the OpenLDAP server the App may connect to.
						</simpara>
					</listitem>
					<listitem>
						<simpara>
    						<option>LDAP_SERVER_ADDITION</option>: A list of alternative OpenLDAP servers. These values should be used for failover.
						</simpara>
					</listitem>
					<listitem>
						<simpara>
    						<option>LDAP_BASE</option>: The base for the whole LDAP database, e.g., <uri>dc=mydomain,dc=intranet</uri> or <uri>o=mydomain</uri>.
						</simpara>
					</listitem>
				</itemizedlist>
				<important>
					<para>
						As a rule, the LDAP basis should not be further restricted. Many environments store users below <uri>cn=users</uri>, but this is not the case in all environments.
					</para>
				</important>
            </para>

            <para>
				By default, the OpenLDAP server in UCS does not allow anonymous authentications. For every app a user account is created. The account has
				read access to the LDAP directory. The username is passed as the environment variable <option>LDAP_HOSTDN</option>. The password is written in the file <filename>/etc/machine.secret</filename>.
				The credentials are not changed when an app is upgraded. But they change if an App is reinstalled. 
            </para>
        </section>
<!--
        <section id="authentication:saml">
            <title>SAML</title>
            <para>
            </para>
        </section>
-->
        <section id="authentication:kerberos">
            <title>Kerberos</title>
            <para>
				UCS integrates a Kerberos server by default. As usual with Kerberos, the data for the Kerberos configuration can be obtained from the DNS. By default, the
				DNS domain name is passed through the <option>DOMAINNAME</option> environment variable. The following settings can then be queried via DNS:
				<itemizedlist>
					<listitem>
						<simpara>
							<emphasis>Kerberos Realm</emphasis>: It an be queried by the TXT record <option>_kerberos.DOMAINNAME</option>
						</simpara>
					</listitem>
					<listitem>
						<simpara>
							<emphasis>Kerberos KDC</emphasis>: It an be queried by the SRV records <option>_kerberos._tcp.DOMAINNAME</option> and  <option>_kerberos._udp.DOMAINNAME</option>.
						</simpara>
					</listitem>
				</itemizedlist>
            </para>
        </section>
<!--
        <section id="authentication:openid-connect">
            <title>OpenID connect</title>
            <para>
            </para>
        </section>
-->
    </section>

    <section id="user-rights-management">
        <title>User rights management</title>
        <para>
        </para>
    </section>

</chapter>

<chapter id="app-lifecycle">
    <title>App life cycle</title>

    <para>
    </para>

    <section id="testing">
        <title>Testing</title>
        <para>
        </para>
    </section>

    <section id="first-release">
        <title>First release</title>
        <para>
        </para>
    </section>

    <section id="updates">
        <title>Updates</title>
        <para>
        </para>
    </section>

    <section id="termination">
        <title>Termination (end of life)</title>
        <para>
        </para>
    </section>

    <section id="certificates">
        <title>Certificates</title>
        <para>
        </para>
    </section>

</chapter>

<chapter id="app-presentation">
    <title>App presentation</title>

    <para>
    </para>

    <section id="logos">
        <title>Logos</title>
        <para>
        </para>
    </section>

    <section id="screentshots">
        <title>Screenshots and videos</title>
        <para>
        </para>
    </section>

    <section id="description">
        <title>Description</title>
        <para>
        </para>
    </section>

    <section id="contact">
        <title>Contact</title>
        <para>
        </para>
    </section>

    <section id="license">
        <title>License</title>
        <para>
        </para>
    </section>

    <section id="readme">
        <title>README for the administrator</title>
        <para>
        </para>
    </section>

</chapter>

<chapter id="app-appliances">
    <title>App Appliances</title>

    <section id="branding">
        <title>Custom branding</title>
        <para>
        </para>
    </section>

    <section id="procedures">
        <title>Procedures</title>
        <para>
        </para>
    </section>
</chapter>

<chapter id="app-configurations">
    <title>App configurations</title>

    <section id="installation-scripts">
        <title>Installation scripts</title>
        <para>
        </para>
    </section>

    <section id="app-settings">
        <title>App settings</title>
        <para>
        </para>
    </section>

    <section id="app-attributes">
        <title>App attributes</title>
        <para>
        </para>
    </section>
</chapter>

</book>
