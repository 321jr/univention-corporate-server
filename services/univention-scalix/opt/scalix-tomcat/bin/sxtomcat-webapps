#!/bin/sh
#
# This script adds or removes web apps to/from a Scalix Tomcat instance.
#

OMCHECKGC=/opt/scalix/bin/omcheckgc

if [ "$#" -lt 3 ] ; then
    echo "Usage: $0 [--add|--del] instance [ALL|app1 app2...]" >&2
    exit 1
fi

action="$1"
instance="$2"
shift
shift

appsdir="/opt/scalix/web"
instdir=$(/opt/scalix-tomcat/bin/sxtomcat-get-inst-dir $instance)
instappsdir="$instdir/conf/Catalina/localhost"
connectordir="/etc/opt/scalix-tomcat/connector"

configdirs="caa mobile platform res sis webmail wireless"

if [ ! -d "$instdir" ] ; then
    echo "Error: instance $instance doesn't exist" >&2
    exit 1
fi

get_config_dirs() {
	if [ "$*" = "ALL" ]
	then
		echo $configdirs
	else
		dirs=""
		for f in $*
		do
			case "$f" in
				api) dirs="$dirs platform";;
				m) dirs="$dirs mobile";;
				sac) dirs="$dirs";;
				*) dirs="$dirs $f" ;;
			esac
		done
		echo "$dirs"
	fi
}

get_webapps_list() {
    appsdir="$1"
    shift
	apps=""

    if [ -d "$appsdir" ] ; then
       if [ "$*" = "ALL" ] ; then
           for f in $appsdir/*.xml ; do
               apps="$apps $(basename $f .xml)"
           done
       else
           apps="$*"
       fi

       for a in $apps; do
           if [ ! -f $appsdir/$a.xml ] ; then
               echo "Error: application $a doesn't exist in $appsdir" >&2
               exit 1
           fi
       done
    fi

    echo $apps
}

determine_instance_host() {
    instance="$1"

    if [ -f $OMCHECKGC ] ; then
        OMCURRENT=$instance $OMCHECKGC -h
    else
        hostname -s
    fi
}

add_webapp_connector() {
    instance="$1"
    app="$2"
    tomcathost=$(determine_instance_host $instance)
    app_conf_file=app-$instance.$app.conf
    if [ $app == "wireless" ]
    then
        target=Microsoft-Server-ActiveSync
    else
        target=$app
    fi

    # AJP:
    ajp_conf_file=$connectordir/ajp/$app_conf_file
    rm -f $ajp_conf_file
    # For the platform only, proxy caldav requests via http rather than ajp
    # order is important for ProxyPass - the more specific should go first
    if [ $app == "api" ]
    then
        echo "ProxyPass /${app}/dav http://${tomcathost}:8080/${app}/dav" \
            >>$ajp_conf_file
    fi

    echo "ProxyPass /${target}  ajp://${tomcathost}:8009/${app}" \
         >>$ajp_conf_file

    if [ $app == "wireless" ]
    then
        echo "ProxyPassReverseCookiePath /${app} /${target}" \
            >>$ajp_conf_file
    fi

    # JK:
    jk_conf_file=$connectordir/jk/$app_conf_file
    rm -f $jk_conf_file

    # wireless requires special handling due to the URL prefix rewrite (Bug 17894)
    if [ $app == "wireless" ]
    then
        echo 'RewriteEngine On' >>$jk_conf_file
        echo 'RewriteRule ^/Microsoft-Server-ActiveSync(.*)$ /wireless$1 [PT]' >>$jk_conf_file
    fi

    echo "JkMount /${app}* ${instance}" \
        >>$jk_conf_file

    # api needs a second identical ProxyPass directive in the jk file
    if [ $app == "api" ]
    then
        echo "ProxyPass /${app}/dav http://${tomcathost}:8080/${app}/dav" \
            >>$jk_conf_file
    fi
}

add_webapps() {
    apps=$(get_webapps_list "$appsdir" $*)
	config_dirs=$(get_config_dirs $*)
    if [ ! -z "$apps" ] ; then
        aw_count=0
		for a in $apps ; do
			ln -sf $appsdir/$a.xml $instappsdir/$a.xml
			add_webapp_connector $instance $a
		done
		tomcatdir=$(dirname $instdir)
		for d in $config_dirs
		do
			if [ -d "/etc/opt/scalix/$d" -a -d "$(dirname $instdir)/$d" ]
			then
			    rm -Rf "/etc/opt/scalix/$d"
			elif [ -d "/opt/scalix/web/template/$d" ]
			then
				# cp -pRf "/opt/scalix/web/template/$d" $(dirname $instdir)
				# first copy the directory structure
				for dd in $(find /opt/scalix/web/template/${d} -type d ); do
					name=${dd#/opt/scalix/web/template/}
					dir=$(dirname $instdir)
					dest="${dir}/${name}"

					if [ ! -x "${dest}" ]; then
						mkdir -p ${dest}
						chmod --reference=${dd} ${dest}
					fi
				done

				for f in $(find /opt/scalix/web/template/$d -type f ); do
					name=${f#/opt/scalix/web/template/}
					dir=$(dirname $instdir)
					dest="${dir}/${name}"
					
					if [ -e "${dest}" ]; then
						cp -p $f ${dest}.dpkg-dist
					else
						cp -p $f ${dest}
					fi
				done
			fi
            aw_count=$((aw_count + 1))
		done
        if [ 0 -eq $aw_count ]
        then
            echo "INFO: No work done for ${apps}."
        fi
    fi

}

del_webapps() {
    apps=$(get_webapps_list $instappsdir $*)
	config_dirs=$(get_config_dirs $*)
	if [ ! -z "$apps" ] ; then
       for a in $apps ; do
           rm -f $instappsdir/$a.xml
           rm -f $connectordir/ajp/app-$instance.$a.conf
           rm -f $connectordir/jk/app-$instance.$a.conf
       done
	   for d in $config_dirs
	   do
           rm -Rf $(dirname $instdir)/$d
	   done
	fi
}

case "$action" in
    --add )
            add_webapps $*
            ;;
    --del )
            del_webapps $*
            ;;
    * )
            echo "Error: $action is not valid command" >&2
            exit 1
esac
