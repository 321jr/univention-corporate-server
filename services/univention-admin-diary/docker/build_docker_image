#!/bin/bash

set -e
set -x

TAG="docker-test.software-univention.de/admin-diary-backend:2.0"
EXPOSED_PORT=8910

# remove old image
docker rmi -f "$TAG" || true

# build/tag image
docker build -t "$TAG" univention-admin-diary-backend

echo "1=$1 2=$2 3=$3"

if [[ $1 == "-p" ]]; then
	shift
	docker push "$TAG"
fi

if [[ $1 = "-r" ]]; then
	old_container="$(docker ps -f "publish=$EXPOSED_PORT" | grep -v CONTAINER | cut -f 1 -d ' ')"
	if [[ -n "$old_container" ]]; then
		docker stop "$old_container"
		docker rm "$old_container"
	fi
	docker run -d -p "$EXPOSED_PORT:$EXPOSED_PORT/tcp" docker-test.software-univention.de/admin-diary-backend:2.0
fi
